"use strict";
// Get Alerts Lambda Function
// Requirements: 9.2, 9.3
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const types_1 = require("../shared/types");
const alerts_1 = require("../shared/data-access/alerts");
const audit_logger_1 = require("../shared/audit-logger");
async function handler(event) {
    try {
        const userId = event.pathParameters?.userId;
        const status = event.queryStringParameters?.status;
        const startTime = event.queryStringParameters?.startTime;
        const endTime = event.queryStringParameters?.endTime;
        const limit = event.queryStringParameters?.limit ? parseInt(event.queryStringParameters.limit) : 50;
        if (!userId && !status) {
            return (0, types_1.createErrorResponse)(400, 'Either userId or status query parameter is required');
        }
        let alerts;
        if (userId) {
            // Get alerts by user
            alerts = await (0, alerts_1.getAlertsByUser)(userId, startTime ? new Date(startTime) : undefined, endTime ? new Date(endTime) : undefined, limit);
            // Log audit event
            await (0, audit_logger_1.logAuditEvent)({
                eventType: 'ALERTS_VIEWED',
                userId: event.requestContext.authorizer?.claims?.sub || 'unknown',
                userType: 'secondary',
                action: 'VIEW_ALERTS',
                resource: `alerts/user/${userId}`,
                timestamp: new Date().toISOString(),
                success: true,
            });
        }
        else if (status) {
            // Get alerts by status
            alerts = await (0, alerts_1.getAlertsByStatus)(status, startTime ? new Date(startTime) : undefined, endTime ? new Date(endTime) : undefined, limit);
        }
        // Sort alerts by severity (critical first) and then by timestamp (newest first)
        const severityOrder = { critical: 0, high: 1, medium: 2, low: 3 };
        alerts?.sort((a, b) => {
            const severityDiff = severityOrder[a.severity] - severityOrder[b.severity];
            if (severityDiff !== 0)
                return severityDiff;
            return b.timestamp.getTime() - a.timestamp.getTime();
        });
        return (0, types_1.createSuccessResponse)({
            alerts,
            count: alerts?.length || 0,
        });
    }
    catch (error) {
        console.error('Error getting alerts:', error);
        return (0, types_1.createErrorResponse)(500, 'Failed to get alerts');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWFsZXJ0cy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1hbGVydHMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLDZCQUE2QjtBQUM3Qix5QkFBeUI7O0FBT3pCLDBCQTJEQztBQS9ERCwyQ0FBNkU7QUFDN0UseURBQWtGO0FBQ2xGLHlEQUF1RDtBQUVoRCxLQUFLLFVBQVUsT0FBTyxDQUFDLEtBQTJCO0lBQ3ZELElBQUksQ0FBQztRQUNILE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxjQUFjLEVBQUUsTUFBTSxDQUFDO1FBQzVDLE1BQU0sTUFBTSxHQUFHLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxNQUFNLENBQUM7UUFDbkQsTUFBTSxTQUFTLEdBQUcsS0FBSyxDQUFDLHFCQUFxQixFQUFFLFNBQVMsQ0FBQztRQUN6RCxNQUFNLE9BQU8sR0FBRyxLQUFLLENBQUMscUJBQXFCLEVBQUUsT0FBTyxDQUFDO1FBQ3JELE1BQU0sS0FBSyxHQUFHLEtBQUssQ0FBQyxxQkFBcUIsRUFBRSxLQUFLLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxLQUFLLENBQUMscUJBQXFCLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQztRQUVwRyxJQUFJLENBQUMsTUFBTSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDdkIsT0FBTyxJQUFBLDJCQUFtQixFQUFDLEdBQUcsRUFBRSxxREFBcUQsQ0FBQyxDQUFDO1FBQ3pGLENBQUM7UUFFRCxJQUFJLE1BQU0sQ0FBQztRQUVYLElBQUksTUFBTSxFQUFFLENBQUM7WUFDWCxxQkFBcUI7WUFDckIsTUFBTSxHQUFHLE1BQU0sSUFBQSx3QkFBZSxFQUM1QixNQUFNLEVBQ04sU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUMzQyxPQUFPLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDLE9BQU8sQ0FBQyxDQUFDLENBQUMsQ0FBQyxTQUFTLEVBQ3ZDLEtBQUssQ0FDTixDQUFDO1lBRUYsa0JBQWtCO1lBQ2xCLE1BQU0sSUFBQSw0QkFBYSxFQUFDO2dCQUNsQixTQUFTLEVBQUUsZUFBZTtnQkFDMUIsTUFBTSxFQUFFLEtBQUssQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUFHLElBQUksU0FBUztnQkFDakUsUUFBUSxFQUFFLFdBQVc7Z0JBQ3JCLE1BQU0sRUFBRSxhQUFhO2dCQUNyQixRQUFRLEVBQUUsZUFBZSxNQUFNLEVBQUU7Z0JBQ2pDLFNBQVMsRUFBRSxJQUFJLElBQUksRUFBRSxDQUFDLFdBQVcsRUFBRTtnQkFDbkMsT0FBTyxFQUFFLElBQUk7YUFDZCxDQUFDLENBQUM7UUFDTCxDQUFDO2FBQU0sSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNsQix1QkFBdUI7WUFDdkIsTUFBTSxHQUFHLE1BQU0sSUFBQSwwQkFBaUIsRUFDOUIsTUFBTSxFQUNOLFNBQVMsQ0FBQyxDQUFDLENBQUMsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxDQUFDLFNBQVMsRUFDM0MsT0FBTyxDQUFDLENBQUMsQ0FBQyxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsU0FBUyxFQUN2QyxLQUFLLENBQ04sQ0FBQztRQUNKLENBQUM7UUFFRCxnRkFBZ0Y7UUFDaEYsTUFBTSxhQUFhLEdBQUcsRUFBRSxRQUFRLEVBQUUsQ0FBQyxFQUFFLElBQUksRUFBRSxDQUFDLEVBQUUsTUFBTSxFQUFFLENBQUMsRUFBRSxHQUFHLEVBQUUsQ0FBQyxFQUFFLENBQUM7UUFDbEUsTUFBTSxFQUFFLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRTtZQUNwQixNQUFNLFlBQVksR0FBRyxhQUFhLENBQUMsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxHQUFHLGFBQWEsQ0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLENBQUM7WUFDM0UsSUFBSSxZQUFZLEtBQUssQ0FBQztnQkFBRSxPQUFPLFlBQVksQ0FBQztZQUM1QyxPQUFPLENBQUMsQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN2RCxDQUFDLENBQUMsQ0FBQztRQUVILE9BQU8sSUFBQSw2QkFBcUIsRUFBQztZQUMzQixNQUFNO1lBQ04sS0FBSyxFQUFFLE1BQU0sRUFBRSxNQUFNLElBQUksQ0FBQztTQUMzQixDQUFDLENBQUM7SUFDTCxDQUFDO0lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztRQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUJBQXVCLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDOUMsT0FBTyxJQUFBLDJCQUFtQixFQUFDLEdBQUcsRUFBRSxzQkFBc0IsQ0FBQyxDQUFDO0lBQzFELENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gR2V0IEFsZXJ0cyBMYW1iZGEgRnVuY3Rpb25cbi8vIFJlcXVpcmVtZW50czogOS4yLCA5LjNcblxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgY3JlYXRlU3VjY2Vzc1Jlc3BvbnNlLCBjcmVhdGVFcnJvclJlc3BvbnNlIH0gZnJvbSAnLi4vc2hhcmVkL3R5cGVzJztcbmltcG9ydCB7IGdldEFsZXJ0c0J5VXNlciwgZ2V0QWxlcnRzQnlTdGF0dXMgfSBmcm9tICcuLi9zaGFyZWQvZGF0YS1hY2Nlc3MvYWxlcnRzJztcbmltcG9ydCB7IGxvZ0F1ZGl0RXZlbnQgfSBmcm9tICcuLi9zaGFyZWQvYXVkaXQtbG9nZ2VyJztcblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgdHJ5IHtcbiAgICBjb25zdCB1c2VySWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8udXNlcklkO1xuICAgIGNvbnN0IHN0YXR1cyA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycz8uc3RhdHVzO1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IGV2ZW50LnF1ZXJ5U3RyaW5nUGFyYW1ldGVycz8uc3RhcnRUaW1lO1xuICAgIGNvbnN0IGVuZFRpbWUgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnM/LmVuZFRpbWU7XG4gICAgY29uc3QgbGltaXQgPSBldmVudC5xdWVyeVN0cmluZ1BhcmFtZXRlcnM/LmxpbWl0ID8gcGFyc2VJbnQoZXZlbnQucXVlcnlTdHJpbmdQYXJhbWV0ZXJzLmxpbWl0KSA6IDUwO1xuXG4gICAgaWYgKCF1c2VySWQgJiYgIXN0YXR1cykge1xuICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoNDAwLCAnRWl0aGVyIHVzZXJJZCBvciBzdGF0dXMgcXVlcnkgcGFyYW1ldGVyIGlzIHJlcXVpcmVkJyk7XG4gICAgfVxuXG4gICAgbGV0IGFsZXJ0cztcblxuICAgIGlmICh1c2VySWQpIHtcbiAgICAgIC8vIEdldCBhbGVydHMgYnkgdXNlclxuICAgICAgYWxlcnRzID0gYXdhaXQgZ2V0QWxlcnRzQnlVc2VyKFxuICAgICAgICB1c2VySWQsXG4gICAgICAgIHN0YXJ0VGltZSA/IG5ldyBEYXRlKHN0YXJ0VGltZSkgOiB1bmRlZmluZWQsXG4gICAgICAgIGVuZFRpbWUgPyBuZXcgRGF0ZShlbmRUaW1lKSA6IHVuZGVmaW5lZCxcbiAgICAgICAgbGltaXRcbiAgICAgICk7XG5cbiAgICAgIC8vIExvZyBhdWRpdCBldmVudFxuICAgICAgYXdhaXQgbG9nQXVkaXRFdmVudCh7XG4gICAgICAgIGV2ZW50VHlwZTogJ0FMRVJUU19WSUVXRUQnLFxuICAgICAgICB1c2VySWQ6IGV2ZW50LnJlcXVlc3RDb250ZXh0LmF1dGhvcml6ZXI/LmNsYWltcz8uc3ViIHx8ICd1bmtub3duJyxcbiAgICAgICAgdXNlclR5cGU6ICdzZWNvbmRhcnknLFxuICAgICAgICBhY3Rpb246ICdWSUVXX0FMRVJUUycsXG4gICAgICAgIHJlc291cmNlOiBgYWxlcnRzL3VzZXIvJHt1c2VySWR9YCxcbiAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICB9KTtcbiAgICB9IGVsc2UgaWYgKHN0YXR1cykge1xuICAgICAgLy8gR2V0IGFsZXJ0cyBieSBzdGF0dXNcbiAgICAgIGFsZXJ0cyA9IGF3YWl0IGdldEFsZXJ0c0J5U3RhdHVzKFxuICAgICAgICBzdGF0dXMsXG4gICAgICAgIHN0YXJ0VGltZSA/IG5ldyBEYXRlKHN0YXJ0VGltZSkgOiB1bmRlZmluZWQsXG4gICAgICAgIGVuZFRpbWUgPyBuZXcgRGF0ZShlbmRUaW1lKSA6IHVuZGVmaW5lZCxcbiAgICAgICAgbGltaXRcbiAgICAgICk7XG4gICAgfVxuXG4gICAgLy8gU29ydCBhbGVydHMgYnkgc2V2ZXJpdHkgKGNyaXRpY2FsIGZpcnN0KSBhbmQgdGhlbiBieSB0aW1lc3RhbXAgKG5ld2VzdCBmaXJzdClcbiAgICBjb25zdCBzZXZlcml0eU9yZGVyID0geyBjcml0aWNhbDogMCwgaGlnaDogMSwgbWVkaXVtOiAyLCBsb3c6IDMgfTtcbiAgICBhbGVydHM/LnNvcnQoKGEsIGIpID0+IHtcbiAgICAgIGNvbnN0IHNldmVyaXR5RGlmZiA9IHNldmVyaXR5T3JkZXJbYS5zZXZlcml0eV0gLSBzZXZlcml0eU9yZGVyW2Iuc2V2ZXJpdHldO1xuICAgICAgaWYgKHNldmVyaXR5RGlmZiAhPT0gMCkgcmV0dXJuIHNldmVyaXR5RGlmZjtcbiAgICAgIHJldHVybiBiLnRpbWVzdGFtcC5nZXRUaW1lKCkgLSBhLnRpbWVzdGFtcC5nZXRUaW1lKCk7XG4gICAgfSk7XG5cbiAgICByZXR1cm4gY3JlYXRlU3VjY2Vzc1Jlc3BvbnNlKHtcbiAgICAgIGFsZXJ0cyxcbiAgICAgIGNvdW50OiBhbGVydHM/Lmxlbmd0aCB8fCAwLFxuICAgIH0pO1xuICB9IGNhdGNoIChlcnJvcikge1xuICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGdldHRpbmcgYWxlcnRzOicsIGVycm9yKTtcbiAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg1MDAsICdGYWlsZWQgdG8gZ2V0IGFsZXJ0cycpO1xuICB9XG59XG4iXX0=