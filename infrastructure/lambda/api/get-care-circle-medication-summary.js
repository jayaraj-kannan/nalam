"use strict";
// Get Care Circle Medication Summary Lambda Function
// Requirements: 4.5, 2.4
// Provides medication adherence and schedule information for care circle members
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const types_1 = require("../shared/types");
const medications_1 = require("../shared/data-access/medications");
const access_control_1 = require("../shared/access-control");
const ADHERENCE_WINDOW_DAYS = 7;
/**
 * Calculate adherence score
 */
function calculateAdherenceScore(medications) {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - ADHERENCE_WINDOW_DAYS);
    const recentMedications = medications.filter(med => med.scheduledTime >= weekAgo);
    if (recentMedications.length === 0) {
        return 100;
    }
    const takenCount = recentMedications.filter(med => med.status === 'taken').length;
    return Math.round((takenCount / recentMedications.length) * 100);
}
/**
 * Get upcoming medications (next 24 hours)
 */
function getUpcomingMedications(medications) {
    const now = new Date();
    const tomorrow = new Date(now.getTime() + 24 * 60 * 60 * 1000);
    return medications
        .filter(med => med.status === 'scheduled' &&
        med.scheduledTime >= now &&
        med.scheduledTime <= tomorrow)
        .sort((a, b) => a.scheduledTime.getTime() - b.scheduledTime.getTime())
        .map(med => ({
        medicationName: med.medication.name,
        dosage: med.medication.dosage,
        scheduledTime: med.scheduledTime.toISOString(),
        status: med.status,
    }));
}
/**
 * Get recent medication activity (past 7 days)
 */
function getRecentActivity(medications) {
    const weekAgo = new Date();
    weekAgo.setDate(weekAgo.getDate() - ADHERENCE_WINDOW_DAYS);
    return medications
        .filter(med => med.scheduledTime >= weekAgo)
        .sort((a, b) => b.scheduledTime.getTime() - a.scheduledTime.getTime())
        .map(med => ({
        medicationName: med.medication.name,
        dosage: med.medication.dosage,
        scheduledTime: med.scheduledTime.toISOString(),
        takenTime: med.takenTime?.toISOString(),
        status: med.status,
    }));
}
async function handler(event) {
    try {
        // Get userId from path parameters
        const userId = event.pathParameters?.userId;
        if (!userId) {
            return (0, types_1.createErrorResponse)(400, 'userId is required in path');
        }
        // Get requesting user from authorizer context
        const requestingUserId = event.requestContext.authorizer?.claims?.sub;
        if (!requestingUserId) {
            return (0, types_1.createErrorResponse)(401, 'Unauthorized');
        }
        // Check if requesting user has permission to view medications
        const hasPermission = await (0, access_control_1.checkPermission)(requestingUserId, 'secondary', userId, 'medications', 'read');
        if (!hasPermission) {
            return (0, types_1.createErrorResponse)(403, 'You do not have permission to view this user\'s medication information');
        }
        // Get all medications
        const medications = await (0, medications_1.getMedicationsByUser)(userId);
        // Calculate statistics
        const weekAgo = new Date();
        weekAgo.setDate(weekAgo.getDate() - ADHERENCE_WINDOW_DAYS);
        const recentMedications = medications.filter(med => med.scheduledTime >= weekAgo);
        const missedCount = recentMedications.filter(med => med.status === 'missed').length;
        const takenCount = recentMedications.filter(med => med.status === 'taken').length;
        const adherenceScore = calculateAdherenceScore(medications);
        // Build summary
        const summary = {
            upcomingMedications: getUpcomingMedications(medications),
            recentActivity: getRecentActivity(medications),
            adherenceScore,
            missedCount,
            takenCount,
        };
        return (0, types_1.createSuccessResponse)({
            userId,
            summary,
            generatedAt: new Date().toISOString(),
        });
    }
    catch (error) {
        console.error('Error getting medication summary:', error);
        return (0, types_1.createErrorResponse)(500, 'Failed to retrieve medication summary');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZ2V0LWNhcmUtY2lyY2xlLW1lZGljYXRpb24tc3VtbWFyeS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImdldC1jYXJlLWNpcmNsZS1tZWRpY2F0aW9uLXN1bW1hcnkudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHFEQUFxRDtBQUNyRCx5QkFBeUI7QUFDekIsaUZBQWlGOztBQTJGakYsMEJBeURDO0FBakpELDJDQUErRjtBQUMvRixtRUFBeUU7QUFDekUsNkRBQTJEO0FBcUIzRCxNQUFNLHFCQUFxQixHQUFHLENBQUMsQ0FBQztBQUVoQzs7R0FFRztBQUNILFNBQVMsdUJBQXVCLENBQUMsV0FBK0I7SUFDOUQsTUFBTSxPQUFPLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztJQUMzQixPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLEVBQUUsR0FBRyxxQkFBcUIsQ0FBQyxDQUFDO0lBRTNELE1BQU0saUJBQWlCLEdBQUcsV0FBVyxDQUFDLE1BQU0sQ0FDMUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsYUFBYSxJQUFJLE9BQU8sQ0FDcEMsQ0FBQztJQUVGLElBQUksaUJBQWlCLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1FBQ25DLE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVELE1BQU0sVUFBVSxHQUFHLGlCQUFpQixDQUFDLE1BQU0sQ0FDekMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLE9BQU8sQ0FDOUIsQ0FBQyxNQUFNLENBQUM7SUFFVCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxVQUFVLEdBQUcsaUJBQWlCLENBQUMsTUFBTSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUM7QUFDbkUsQ0FBQztBQUVEOztHQUVHO0FBQ0gsU0FBUyxzQkFBc0IsQ0FBQyxXQUErQjtJQUM3RCxNQUFNLEdBQUcsR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO0lBQ3ZCLE1BQU0sUUFBUSxHQUFHLElBQUksSUFBSSxDQUFDLEdBQUcsQ0FBQyxPQUFPLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQztJQUUvRCxPQUFPLFdBQVc7U0FDZixNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FDWixHQUFHLENBQUMsTUFBTSxLQUFLLFdBQVc7UUFDMUIsR0FBRyxDQUFDLGFBQWEsSUFBSSxHQUFHO1FBQ3hCLEdBQUcsQ0FBQyxhQUFhLElBQUksUUFBUSxDQUM5QjtTQUNBLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLEdBQUcsQ0FBQyxDQUFDLGFBQWEsQ0FBQyxPQUFPLEVBQUUsQ0FBQztTQUNyRSxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBQ1gsY0FBYyxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsSUFBSTtRQUNuQyxNQUFNLEVBQUUsR0FBRyxDQUFDLFVBQVUsQ0FBQyxNQUFNO1FBQzdCLGFBQWEsRUFBRSxHQUFHLENBQUMsYUFBYSxDQUFDLFdBQVcsRUFBRTtRQUM5QyxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU07S0FDbkIsQ0FBQyxDQUFDLENBQUM7QUFDUixDQUFDO0FBRUQ7O0dBRUc7QUFDSCxTQUFTLGlCQUFpQixDQUFDLFdBQStCO0lBQ3hELE1BQU0sT0FBTyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7SUFDM0IsT0FBTyxDQUFDLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxFQUFFLEdBQUcscUJBQXFCLENBQUMsQ0FBQztJQUUzRCxPQUFPLFdBQVc7U0FDZixNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsYUFBYSxJQUFJLE9BQU8sQ0FBQztTQUMzQyxJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsYUFBYSxDQUFDLE9BQU8sRUFBRSxHQUFHLENBQUMsQ0FBQyxhQUFhLENBQUMsT0FBTyxFQUFFLENBQUM7U0FDckUsR0FBRyxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsQ0FBQztRQUNYLGNBQWMsRUFBRSxHQUFHLENBQUMsVUFBVSxDQUFDLElBQUk7UUFDbkMsTUFBTSxFQUFFLEdBQUcsQ0FBQyxVQUFVLENBQUMsTUFBTTtRQUM3QixhQUFhLEVBQUUsR0FBRyxDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUU7UUFDOUMsU0FBUyxFQUFFLEdBQUcsQ0FBQyxTQUFTLEVBQUUsV0FBVyxFQUFFO1FBQ3ZDLE1BQU0sRUFBRSxHQUFHLENBQUMsTUFBTTtLQUNuQixDQUFDLENBQUMsQ0FBQztBQUNSLENBQUM7QUFFTSxLQUFLLFVBQVUsT0FBTyxDQUFDLEtBQTJCO0lBQ3ZELElBQUksQ0FBQztRQUNILGtDQUFrQztRQUNsQyxNQUFNLE1BQU0sR0FBRyxLQUFLLENBQUMsY0FBYyxFQUFFLE1BQU0sQ0FBQztRQUM1QyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDWixPQUFPLElBQUEsMkJBQW1CLEVBQUMsR0FBRyxFQUFFLDRCQUE0QixDQUFDLENBQUM7UUFDaEUsQ0FBQztRQUVELDhDQUE4QztRQUM5QyxNQUFNLGdCQUFnQixHQUFHLEtBQUssQ0FBQyxjQUFjLENBQUMsVUFBVSxFQUFFLE1BQU0sRUFBRSxHQUFHLENBQUM7UUFDdEUsSUFBSSxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDdEIsT0FBTyxJQUFBLDJCQUFtQixFQUFDLEdBQUcsRUFBRSxjQUFjLENBQUMsQ0FBQztRQUNsRCxDQUFDO1FBRUQsOERBQThEO1FBQzlELE1BQU0sYUFBYSxHQUFHLE1BQU0sSUFBQSxnQ0FBZSxFQUN6QyxnQkFBZ0IsRUFDaEIsV0FBVyxFQUNYLE1BQU0sRUFDTixhQUFhLEVBQ2IsTUFBTSxDQUNQLENBQUM7UUFFRixJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7WUFDbkIsT0FBTyxJQUFBLDJCQUFtQixFQUFDLEdBQUcsRUFBRSx3RUFBd0UsQ0FBQyxDQUFDO1FBQzVHLENBQUM7UUFFRCxzQkFBc0I7UUFDdEIsTUFBTSxXQUFXLEdBQUcsTUFBTSxJQUFBLGtDQUFvQixFQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRXZELHVCQUF1QjtRQUN2QixNQUFNLE9BQU8sR0FBRyxJQUFJLElBQUksRUFBRSxDQUFDO1FBQzNCLE9BQU8sQ0FBQyxPQUFPLENBQUMsT0FBTyxDQUFDLE9BQU8sRUFBRSxHQUFHLHFCQUFxQixDQUFDLENBQUM7UUFDM0QsTUFBTSxpQkFBaUIsR0FBRyxXQUFXLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxPQUFPLENBQUMsQ0FBQztRQUVsRixNQUFNLFdBQVcsR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLFFBQVEsQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNwRixNQUFNLFVBQVUsR0FBRyxpQkFBaUIsQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLEVBQUUsQ0FBQyxHQUFHLENBQUMsTUFBTSxLQUFLLE9BQU8sQ0FBQyxDQUFDLE1BQU0sQ0FBQztRQUNsRixNQUFNLGNBQWMsR0FBRyx1QkFBdUIsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUU1RCxnQkFBZ0I7UUFDaEIsTUFBTSxPQUFPLEdBQXNCO1lBQ2pDLG1CQUFtQixFQUFFLHNCQUFzQixDQUFDLFdBQVcsQ0FBQztZQUN4RCxjQUFjLEVBQUUsaUJBQWlCLENBQUMsV0FBVyxDQUFDO1lBQzlDLGNBQWM7WUFDZCxXQUFXO1lBQ1gsVUFBVTtTQUNYLENBQUM7UUFFRixPQUFPLElBQUEsNkJBQXFCLEVBQUM7WUFDM0IsTUFBTTtZQUNOLE9BQU87WUFDUCxXQUFXLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7U0FDdEMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7UUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLG1DQUFtQyxFQUFFLEtBQUssQ0FBQyxDQUFDO1FBQzFELE9BQU8sSUFBQSwyQkFBbUIsRUFBQyxHQUFHLEVBQUUsdUNBQXVDLENBQUMsQ0FBQztJQUMzRSxDQUFDO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEdldCBDYXJlIENpcmNsZSBNZWRpY2F0aW9uIFN1bW1hcnkgTGFtYmRhIEZ1bmN0aW9uXG4vLyBSZXF1aXJlbWVudHM6IDQuNSwgMi40XG4vLyBQcm92aWRlcyBtZWRpY2F0aW9uIGFkaGVyZW5jZSBhbmQgc2NoZWR1bGUgaW5mb3JtYXRpb24gZm9yIGNhcmUgY2lyY2xlIG1lbWJlcnNcblxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgY3JlYXRlU3VjY2Vzc1Jlc3BvbnNlLCBjcmVhdGVFcnJvclJlc3BvbnNlLCBNZWRpY2F0aW9uUmVjb3JkIH0gZnJvbSAnLi4vc2hhcmVkL3R5cGVzJztcbmltcG9ydCB7IGdldE1lZGljYXRpb25zQnlVc2VyIH0gZnJvbSAnLi4vc2hhcmVkL2RhdGEtYWNjZXNzL21lZGljYXRpb25zJztcbmltcG9ydCB7IGNoZWNrUGVybWlzc2lvbiB9IGZyb20gJy4uL3NoYXJlZC9hY2Nlc3MtY29udHJvbCc7XG5cbmludGVyZmFjZSBNZWRpY2F0aW9uU3VtbWFyeSB7XG4gIHVwY29taW5nTWVkaWNhdGlvbnM6IEFycmF5PHtcbiAgICBtZWRpY2F0aW9uTmFtZTogc3RyaW5nO1xuICAgIGRvc2FnZTogc3RyaW5nO1xuICAgIHNjaGVkdWxlZFRpbWU6IHN0cmluZztcbiAgICBzdGF0dXM6IHN0cmluZztcbiAgfT47XG4gIHJlY2VudEFjdGl2aXR5OiBBcnJheTx7XG4gICAgbWVkaWNhdGlvbk5hbWU6IHN0cmluZztcbiAgICBkb3NhZ2U6IHN0cmluZztcbiAgICBzY2hlZHVsZWRUaW1lOiBzdHJpbmc7XG4gICAgdGFrZW5UaW1lPzogc3RyaW5nO1xuICAgIHN0YXR1czogc3RyaW5nO1xuICB9PjtcbiAgYWRoZXJlbmNlU2NvcmU6IG51bWJlcjtcbiAgbWlzc2VkQ291bnQ6IG51bWJlcjtcbiAgdGFrZW5Db3VudDogbnVtYmVyO1xufVxuXG5jb25zdCBBREhFUkVOQ0VfV0lORE9XX0RBWVMgPSA3O1xuXG4vKipcbiAqIENhbGN1bGF0ZSBhZGhlcmVuY2Ugc2NvcmVcbiAqL1xuZnVuY3Rpb24gY2FsY3VsYXRlQWRoZXJlbmNlU2NvcmUobWVkaWNhdGlvbnM6IE1lZGljYXRpb25SZWNvcmRbXSk6IG51bWJlciB7XG4gIGNvbnN0IHdlZWtBZ28gPSBuZXcgRGF0ZSgpO1xuICB3ZWVrQWdvLnNldERhdGUod2Vla0Fnby5nZXREYXRlKCkgLSBBREhFUkVOQ0VfV0lORE9XX0RBWVMpO1xuXG4gIGNvbnN0IHJlY2VudE1lZGljYXRpb25zID0gbWVkaWNhdGlvbnMuZmlsdGVyKFxuICAgIG1lZCA9PiBtZWQuc2NoZWR1bGVkVGltZSA+PSB3ZWVrQWdvXG4gICk7XG5cbiAgaWYgKHJlY2VudE1lZGljYXRpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgIHJldHVybiAxMDA7XG4gIH1cblxuICBjb25zdCB0YWtlbkNvdW50ID0gcmVjZW50TWVkaWNhdGlvbnMuZmlsdGVyKFxuICAgIG1lZCA9PiBtZWQuc3RhdHVzID09PSAndGFrZW4nXG4gICkubGVuZ3RoO1xuXG4gIHJldHVybiBNYXRoLnJvdW5kKCh0YWtlbkNvdW50IC8gcmVjZW50TWVkaWNhdGlvbnMubGVuZ3RoKSAqIDEwMCk7XG59XG5cbi8qKlxuICogR2V0IHVwY29taW5nIG1lZGljYXRpb25zIChuZXh0IDI0IGhvdXJzKVxuICovXG5mdW5jdGlvbiBnZXRVcGNvbWluZ01lZGljYXRpb25zKG1lZGljYXRpb25zOiBNZWRpY2F0aW9uUmVjb3JkW10pOiBNZWRpY2F0aW9uU3VtbWFyeVsndXBjb21pbmdNZWRpY2F0aW9ucyddIHtcbiAgY29uc3Qgbm93ID0gbmV3IERhdGUoKTtcbiAgY29uc3QgdG9tb3Jyb3cgPSBuZXcgRGF0ZShub3cuZ2V0VGltZSgpICsgMjQgKiA2MCAqIDYwICogMTAwMCk7XG5cbiAgcmV0dXJuIG1lZGljYXRpb25zXG4gICAgLmZpbHRlcihtZWQgPT4gXG4gICAgICBtZWQuc3RhdHVzID09PSAnc2NoZWR1bGVkJyAmJlxuICAgICAgbWVkLnNjaGVkdWxlZFRpbWUgPj0gbm93ICYmXG4gICAgICBtZWQuc2NoZWR1bGVkVGltZSA8PSB0b21vcnJvd1xuICAgIClcbiAgICAuc29ydCgoYSwgYikgPT4gYS5zY2hlZHVsZWRUaW1lLmdldFRpbWUoKSAtIGIuc2NoZWR1bGVkVGltZS5nZXRUaW1lKCkpXG4gICAgLm1hcChtZWQgPT4gKHtcbiAgICAgIG1lZGljYXRpb25OYW1lOiBtZWQubWVkaWNhdGlvbi5uYW1lLFxuICAgICAgZG9zYWdlOiBtZWQubWVkaWNhdGlvbi5kb3NhZ2UsXG4gICAgICBzY2hlZHVsZWRUaW1lOiBtZWQuc2NoZWR1bGVkVGltZS50b0lTT1N0cmluZygpLFxuICAgICAgc3RhdHVzOiBtZWQuc3RhdHVzLFxuICAgIH0pKTtcbn1cblxuLyoqXG4gKiBHZXQgcmVjZW50IG1lZGljYXRpb24gYWN0aXZpdHkgKHBhc3QgNyBkYXlzKVxuICovXG5mdW5jdGlvbiBnZXRSZWNlbnRBY3Rpdml0eShtZWRpY2F0aW9uczogTWVkaWNhdGlvblJlY29yZFtdKTogTWVkaWNhdGlvblN1bW1hcnlbJ3JlY2VudEFjdGl2aXR5J10ge1xuICBjb25zdCB3ZWVrQWdvID0gbmV3IERhdGUoKTtcbiAgd2Vla0Fnby5zZXREYXRlKHdlZWtBZ28uZ2V0RGF0ZSgpIC0gQURIRVJFTkNFX1dJTkRPV19EQVlTKTtcblxuICByZXR1cm4gbWVkaWNhdGlvbnNcbiAgICAuZmlsdGVyKG1lZCA9PiBtZWQuc2NoZWR1bGVkVGltZSA+PSB3ZWVrQWdvKVxuICAgIC5zb3J0KChhLCBiKSA9PiBiLnNjaGVkdWxlZFRpbWUuZ2V0VGltZSgpIC0gYS5zY2hlZHVsZWRUaW1lLmdldFRpbWUoKSlcbiAgICAubWFwKG1lZCA9PiAoe1xuICAgICAgbWVkaWNhdGlvbk5hbWU6IG1lZC5tZWRpY2F0aW9uLm5hbWUsXG4gICAgICBkb3NhZ2U6IG1lZC5tZWRpY2F0aW9uLmRvc2FnZSxcbiAgICAgIHNjaGVkdWxlZFRpbWU6IG1lZC5zY2hlZHVsZWRUaW1lLnRvSVNPU3RyaW5nKCksXG4gICAgICB0YWtlblRpbWU6IG1lZC50YWtlblRpbWU/LnRvSVNPU3RyaW5nKCksXG4gICAgICBzdGF0dXM6IG1lZC5zdGF0dXMsXG4gICAgfSkpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlcihldmVudDogQVBJR2F0ZXdheVByb3h5RXZlbnQpOiBQcm9taXNlPEFQSUdhdGV3YXlQcm94eVJlc3VsdD4ge1xuICB0cnkge1xuICAgIC8vIEdldCB1c2VySWQgZnJvbSBwYXRoIHBhcmFtZXRlcnNcbiAgICBjb25zdCB1c2VySWQgPSBldmVudC5wYXRoUGFyYW1ldGVycz8udXNlcklkO1xuICAgIGlmICghdXNlcklkKSB7XG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsICd1c2VySWQgaXMgcmVxdWlyZWQgaW4gcGF0aCcpO1xuICAgIH1cblxuICAgIC8vIEdldCByZXF1ZXN0aW5nIHVzZXIgZnJvbSBhdXRob3JpemVyIGNvbnRleHRcbiAgICBjb25zdCByZXF1ZXN0aW5nVXNlcklkID0gZXZlbnQucmVxdWVzdENvbnRleHQuYXV0aG9yaXplcj8uY2xhaW1zPy5zdWI7XG4gICAgaWYgKCFyZXF1ZXN0aW5nVXNlcklkKSB7XG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDEsICdVbmF1dGhvcml6ZWQnKTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiByZXF1ZXN0aW5nIHVzZXIgaGFzIHBlcm1pc3Npb24gdG8gdmlldyBtZWRpY2F0aW9uc1xuICAgIGNvbnN0IGhhc1Blcm1pc3Npb24gPSBhd2FpdCBjaGVja1Blcm1pc3Npb24oXG4gICAgICByZXF1ZXN0aW5nVXNlcklkLFxuICAgICAgJ3NlY29uZGFyeScsXG4gICAgICB1c2VySWQsXG4gICAgICAnbWVkaWNhdGlvbnMnLFxuICAgICAgJ3JlYWQnXG4gICAgKTtcblxuICAgIGlmICghaGFzUGVybWlzc2lvbikge1xuICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoNDAzLCAnWW91IGRvIG5vdCBoYXZlIHBlcm1pc3Npb24gdG8gdmlldyB0aGlzIHVzZXJcXCdzIG1lZGljYXRpb24gaW5mb3JtYXRpb24nKTtcbiAgICB9XG5cbiAgICAvLyBHZXQgYWxsIG1lZGljYXRpb25zXG4gICAgY29uc3QgbWVkaWNhdGlvbnMgPSBhd2FpdCBnZXRNZWRpY2F0aW9uc0J5VXNlcih1c2VySWQpO1xuXG4gICAgLy8gQ2FsY3VsYXRlIHN0YXRpc3RpY3NcbiAgICBjb25zdCB3ZWVrQWdvID0gbmV3IERhdGUoKTtcbiAgICB3ZWVrQWdvLnNldERhdGUod2Vla0Fnby5nZXREYXRlKCkgLSBBREhFUkVOQ0VfV0lORE9XX0RBWVMpO1xuICAgIGNvbnN0IHJlY2VudE1lZGljYXRpb25zID0gbWVkaWNhdGlvbnMuZmlsdGVyKG1lZCA9PiBtZWQuc2NoZWR1bGVkVGltZSA+PSB3ZWVrQWdvKTtcbiAgICBcbiAgICBjb25zdCBtaXNzZWRDb3VudCA9IHJlY2VudE1lZGljYXRpb25zLmZpbHRlcihtZWQgPT4gbWVkLnN0YXR1cyA9PT0gJ21pc3NlZCcpLmxlbmd0aDtcbiAgICBjb25zdCB0YWtlbkNvdW50ID0gcmVjZW50TWVkaWNhdGlvbnMuZmlsdGVyKG1lZCA9PiBtZWQuc3RhdHVzID09PSAndGFrZW4nKS5sZW5ndGg7XG4gICAgY29uc3QgYWRoZXJlbmNlU2NvcmUgPSBjYWxjdWxhdGVBZGhlcmVuY2VTY29yZShtZWRpY2F0aW9ucyk7XG5cbiAgICAvLyBCdWlsZCBzdW1tYXJ5XG4gICAgY29uc3Qgc3VtbWFyeTogTWVkaWNhdGlvblN1bW1hcnkgPSB7XG4gICAgICB1cGNvbWluZ01lZGljYXRpb25zOiBnZXRVcGNvbWluZ01lZGljYXRpb25zKG1lZGljYXRpb25zKSxcbiAgICAgIHJlY2VudEFjdGl2aXR5OiBnZXRSZWNlbnRBY3Rpdml0eShtZWRpY2F0aW9ucyksXG4gICAgICBhZGhlcmVuY2VTY29yZSxcbiAgICAgIG1pc3NlZENvdW50LFxuICAgICAgdGFrZW5Db3VudCxcbiAgICB9O1xuXG4gICAgcmV0dXJuIGNyZWF0ZVN1Y2Nlc3NSZXNwb25zZSh7XG4gICAgICB1c2VySWQsXG4gICAgICBzdW1tYXJ5LFxuICAgICAgZ2VuZXJhdGVkQXQ6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKSxcbiAgICB9KTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZXR0aW5nIG1lZGljYXRpb24gc3VtbWFyeTonLCBlcnJvcik7XG4gICAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoNTAwLCAnRmFpbGVkIHRvIHJldHJpZXZlIG1lZGljYXRpb24gc3VtbWFyeScpO1xuICB9XG59XG4iXX0=