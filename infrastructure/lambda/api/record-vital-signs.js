"use strict";
// Record Vital Signs API Endpoint
// Requirements: 1.1, 1.4 - Store vital signs with timestamp and validation
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const types_1 = require("../shared/types");
const timestream_client_1 = require("../shared/timestream-client");
const audit_logger_1 = require("../shared/audit-logger");
const anomaly_detection_1 = require("../shared/anomaly-detection");
const users_1 = require("../shared/data-access/users");
/**
 * Normal ranges for vital signs validation
 */
const VITAL_RANGES = {
    heartRate: { min: 40, max: 200, unit: 'bpm' },
    systolicBP: { min: 70, max: 200, unit: 'mmHg' },
    diastolicBP: { min: 40, max: 130, unit: 'mmHg' },
    temperature: { min: 95.0, max: 105.0, unit: 'F' },
    oxygenSaturation: { min: 70, max: 100, unit: '%' },
    weight: { min: 50, max: 500, unit: 'lbs' },
};
/**
 * Validate vital signs against acceptable ranges
 */
function validateVitalSigns(vitals) {
    const errors = [];
    if (vitals.heartRate !== undefined) {
        if (vitals.heartRate < VITAL_RANGES.heartRate.min || vitals.heartRate > VITAL_RANGES.heartRate.max) {
            errors.push(`Heart rate must be between ${VITAL_RANGES.heartRate.min} and ${VITAL_RANGES.heartRate.max} ${VITAL_RANGES.heartRate.unit}`);
        }
    }
    if (vitals.bloodPressure) {
        if (vitals.bloodPressure.systolic < VITAL_RANGES.systolicBP.min ||
            vitals.bloodPressure.systolic > VITAL_RANGES.systolicBP.max) {
            errors.push(`Systolic blood pressure must be between ${VITAL_RANGES.systolicBP.min} and ${VITAL_RANGES.systolicBP.max} ${VITAL_RANGES.systolicBP.unit}`);
        }
        if (vitals.bloodPressure.diastolic < VITAL_RANGES.diastolicBP.min ||
            vitals.bloodPressure.diastolic > VITAL_RANGES.diastolicBP.max) {
            errors.push(`Diastolic blood pressure must be between ${VITAL_RANGES.diastolicBP.min} and ${VITAL_RANGES.diastolicBP.max} ${VITAL_RANGES.diastolicBP.unit}`);
        }
    }
    if (vitals.temperature !== undefined) {
        if (vitals.temperature < VITAL_RANGES.temperature.min || vitals.temperature > VITAL_RANGES.temperature.max) {
            errors.push(`Temperature must be between ${VITAL_RANGES.temperature.min} and ${VITAL_RANGES.temperature.max} ${VITAL_RANGES.temperature.unit}`);
        }
    }
    if (vitals.oxygenSaturation !== undefined) {
        if (vitals.oxygenSaturation < VITAL_RANGES.oxygenSaturation.min ||
            vitals.oxygenSaturation > VITAL_RANGES.oxygenSaturation.max) {
            errors.push(`Oxygen saturation must be between ${VITAL_RANGES.oxygenSaturation.min} and ${VITAL_RANGES.oxygenSaturation.max} ${VITAL_RANGES.oxygenSaturation.unit}`);
        }
    }
    if (vitals.weight !== undefined) {
        if (vitals.weight < VITAL_RANGES.weight.min || vitals.weight > VITAL_RANGES.weight.max) {
            errors.push(`Weight must be between ${VITAL_RANGES.weight.min} and ${VITAL_RANGES.weight.max} ${VITAL_RANGES.weight.unit}`);
        }
    }
    return { valid: errors.length === 0, errors };
}
/**
 * Record vital signs for a user
 * POST /api/v1/health/vitals
 */
async function handler(event) {
    try {
        // Extract user info from authorizer context
        const userId = event.requestContext.authorizer?.principalId;
        const userType = event.requestContext.authorizer?.userType;
        if (!userId || !userType) {
            return (0, types_1.createErrorResponse)(401, 'Unauthorized: Missing user context');
        }
        // Parse request body
        if (!event.body) {
            return (0, types_1.createErrorResponse)(400, 'Missing request body');
        }
        const body = JSON.parse(event.body);
        const { vitals, deviceId } = body;
        if (!vitals) {
            return (0, types_1.createErrorResponse)(400, 'Missing vitals data');
        }
        // Determine target user ID (primary user records for themselves, secondary user cannot record)
        let targetUserId = userId;
        if (userType === 'secondary') {
            // Secondary users cannot record vital signs
            return (0, types_1.createErrorResponse)(403, 'Forbidden: Secondary users cannot record vital signs');
        }
        // Generate timestamp
        const timestamp = new Date();
        // Construct VitalSigns object
        const vitalSigns = {
            heartRate: vitals.heartRate,
            bloodPressure: vitals.bloodPressure
                ? {
                    systolic: vitals.bloodPressure.systolic,
                    diastolic: vitals.bloodPressure.diastolic,
                }
                : undefined,
            temperature: vitals.temperature,
            oxygenSaturation: vitals.oxygenSaturation,
            weight: vitals.weight,
            timestamp,
            source: deviceId ? 'device' : 'manual',
        };
        // Validate vital signs
        const validation = validateVitalSigns(vitalSigns);
        if (!validation.valid) {
            return (0, types_1.createErrorResponse)(400, `Validation failed: ${validation.errors.join(', ')}`);
        }
        // Get user's baseline vitals for anomaly detection
        const user = await (0, users_1.getUser)(targetUserId);
        const baselineVitals = user?.healthProfile?.baselineVitals;
        // Detect anomalies
        const anomalies = (0, anomaly_detection_1.detectAnomalies)(vitalSigns, baselineVitals);
        const hasAnomalies = anomalies.length > 0;
        const shouldAlert = (0, anomaly_detection_1.shouldTriggerAlert)(anomalies);
        // Store in Timestream
        await (0, timestream_client_1.writeVitalSigns)(targetUserId, {
            heartRate: vitalSigns.heartRate,
            systolicBP: vitalSigns.bloodPressure?.systolic,
            diastolicBP: vitalSigns.bloodPressure?.diastolic,
            temperature: vitalSigns.temperature,
            oxygenSaturation: vitalSigns.oxygenSaturation,
            weight: vitalSigns.weight,
        }, timestamp, vitalSigns.source);
        // Log data access
        await (0, audit_logger_1.logDataAccess)(userId, userType, targetUserId, 'vitals', 'write', true, ['vitals'], {
            source: vitalSigns.source,
            deviceId,
            timestamp: timestamp.toISOString(),
            anomaliesDetected: hasAnomalies,
            alertTriggered: shouldAlert,
        });
        // TODO: Trigger alert generation if anomalies detected (will be implemented in task 6)
        // This will be handled by the Alert Management Service
        return (0, types_1.createSuccessResponse)({
            message: 'Vital signs recorded successfully',
            userId: targetUserId,
            timestamp: timestamp.toISOString(),
            vitals: vitalSigns,
            anomalies: hasAnomalies ? anomalies : undefined,
            alertTriggered: shouldAlert,
        });
    }
    catch (error) {
        console.error('Record vital signs error:', error);
        return (0, types_1.createErrorResponse)(500, 'Internal server error');
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVjb3JkLXZpdGFsLXNpZ25zLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVjb3JkLXZpdGFsLXNpZ25zLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxrQ0FBa0M7QUFDbEMsMkVBQTJFOztBQXdGM0UsMEJBc0dDO0FBM0xELDJDQUF5RjtBQUN6RixtRUFBOEQ7QUFDOUQseURBQXVEO0FBQ3ZELG1FQUFzRztBQUN0Ryx1REFBc0Q7QUFFdEQ7O0dBRUc7QUFDSCxNQUFNLFlBQVksR0FBRztJQUNuQixTQUFTLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRTtJQUM3QyxVQUFVLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRTtJQUMvQyxXQUFXLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLE1BQU0sRUFBRTtJQUNoRCxXQUFXLEVBQUUsRUFBRSxHQUFHLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFLEdBQUcsRUFBRTtJQUNqRCxnQkFBZ0IsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsR0FBRyxFQUFFO0lBQ2xELE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFO0NBQzNDLENBQUM7QUFFRjs7R0FFRztBQUNILFNBQVMsa0JBQWtCLENBQUMsTUFBa0I7SUFDNUMsTUFBTSxNQUFNLEdBQWEsRUFBRSxDQUFDO0lBRTVCLElBQUksTUFBTSxDQUFDLFNBQVMsS0FBSyxTQUFTLEVBQUUsQ0FBQztRQUNuQyxJQUFJLE1BQU0sQ0FBQyxTQUFTLEdB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O1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQywyQkFBMkIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNsRCxPQUFPLElBQUEsMkJBQW1CLEVBQUMsR0FBRyxFQUFFLHVCQUF1QixDQUFDLENBQUM7SUFDM0QsQ0FBQztBQUNILENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBSZWNvcmQgVml0YWwgU2lnbnMgQVBJIEVuZHBvaW50XG4vLyBSZXF1aXJlbWVudHM6IDEuMSwgMS40IC0gU3RvcmUgdml0YWwgc2lnbnMgd2l0aCB0aW1lc3RhbXAgYW5kIHZhbGlkYXRpb25cblxuaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQsIEFQSUdhdGV3YXlQcm94eVJlc3VsdCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgY3JlYXRlU3VjY2Vzc1Jlc3BvbnNlLCBjcmVhdGVFcnJvclJlc3BvbnNlLCBWaXRhbFNpZ25zIH0gZnJvbSAnLi4vc2hhcmVkL3R5cGVzJztcbmltcG9ydCB7IHdyaXRlVml0YWxTaWducyB9IGZyb20gJy4uL3NoYXJlZC90aW1lc3RyZWFtLWNsaWVudCc7XG5pbXBvcnQgeyBsb2dEYXRhQWNjZXNzIH0gZnJvbSAnLi4vc2hhcmVkL2F1ZGl0LWxvZ2dlcic7XG5pbXBvcnQgeyBkZXRlY3RBbm9tYWxpZXMsIHNob3VsZFRyaWdnZXJBbGVydCwgZ2V0SGlnaGVzdFNldmVyaXR5IH0gZnJvbSAnLi4vc2hhcmVkL2Fub21hbHktZGV0ZWN0aW9uJztcbmltcG9ydCB7IGdldFVzZXIgfSBmcm9tICcuLi9zaGFyZWQvZGF0YS1hY2Nlc3MvdXNlcnMnO1xuXG4vKipcbiAqIE5vcm1hbCByYW5nZXMgZm9yIHZpdGFsIHNpZ25zIHZhbGlkYXRpb25cbiAqL1xuY29uc3QgVklUQUxfUkFOR0VTID0ge1xuICBoZWFydFJhdGU6IHsgbWluOiA0MCwgbWF4OiAyMDAsIHVuaXQ6ICdicG0nIH0sXG4gIHN5c3RvbGljQlA6IHsgbWluOiA3MCwgbWF4OiAyMDAsIHVuaXQ6ICdtbUhnJyB9LFxuICBkaWFzdG9saWNCUDogeyBtaW46IDQwLCBtYXg6IDEzMCwgdW5pdDogJ21tSGcnIH0sXG4gIHRlbXBlcmF0dXJlOiB7IG1pbjogOTUuMCwgbWF4OiAxMDUuMCwgdW5pdDogJ0YnIH0sXG4gIG94eWdlblNhdHVyYXRpb246IHsgbWluOiA3MCwgbWF4OiAxMDAsIHVuaXQ6ICclJyB9LFxuICB3ZWlnaHQ6IHsgbWluOiA1MCwgbWF4OiA1MDAsIHVuaXQ6ICdsYnMnIH0sXG59O1xuXG4vKipcbiAqIFZhbGlkYXRlIHZpdGFsIHNpZ25zIGFnYWluc3QgYWNjZXB0YWJsZSByYW5nZXNcbiAqL1xuZnVuY3Rpb24gdmFsaWRhdGVWaXRhbFNpZ25zKHZpdGFsczogVml0YWxTaWducyk6IHsgdmFsaWQ6IGJvb2xlYW47IGVycm9yczogc3RyaW5nW10gfSB7XG4gIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcblxuICBpZiAodml0YWxzLmhlYXJ0UmF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKHZpdGFscy5oZWFydFJhdGUgPCBWSVRBTF9SQU5HRVMuaGVhcnRSYXRlLm1pbiB8fCB2aXRhbHMuaGVhcnRSYXRlID4gVklUQUxfUkFOR0VTLmhlYXJ0UmF0ZS5tYXgpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgSGVhcnQgcmF0ZSBtdXN0IGJlIGJldHdlZW4gJHtWSVRBTF9SQU5HRVMuaGVhcnRSYXRlLm1pbn0gYW5kICR7VklUQUxfUkFOR0VTLmhlYXJ0UmF0ZS5tYXh9ICR7VklUQUxfUkFOR0VTLmhlYXJ0UmF0ZS51bml0fWBcbiAgICAgICk7XG4gICAgfVxuICB9XG5cbiAgaWYgKHZpdGFscy5ibG9vZFByZXNzdXJlKSB7XG4gICAgaWYgKFxuICAgICAgdml0YWxzLmJsb29kUHJlc3N1cmUuc3lzdG9saWMgPCBWSVRBTF9SQU5HRVMuc3lzdG9saWNCUC5taW4gfHxcbiAgICAgIHZpdGFscy5ibG9vZFByZXNzdXJlLnN5c3RvbGljID4gVklUQUxfUkFOR0VTLnN5c3RvbGljQlAubWF4XG4gICAgKSB7XG4gICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgYFN5c3RvbGljIGJsb29kIHByZXNzdXJlIG11c3QgYmUgYmV0d2VlbiAke1ZJVEFMX1JBTkdFUy5zeXN0b2xpY0JQLm1pbn0gYW5kICR7VklUQUxfUkFOR0VTLnN5c3RvbGljQlAubWF4fSAke1ZJVEFMX1JBTkdFUy5zeXN0b2xpY0JQLnVuaXR9YFxuICAgICAgKTtcbiAgICB9XG4gICAgaWYgKFxuICAgICAgdml0YWxzLmJsb29kUHJlc3N1cmUuZGlhc3RvbGljIDwgVklUQUxfUkFOR0VTLmRpYXN0b2xpY0JQLm1pbiB8fFxuICAgICAgdml0YWxzLmJsb29kUHJlc3N1cmUuZGlhc3RvbGljID4gVklUQUxfUkFOR0VTLmRpYXN0b2xpY0JQLm1heFxuICAgICkge1xuICAgICAgZXJyb3JzLnB1c2goXG4gICAgICAgIGBEaWFzdG9saWMgYmxvb2QgcHJlc3N1cmUgbXVzdCBiZSBiZXR3ZWVuICR7VklUQUxfUkFOR0VTLmRpYXN0b2xpY0JQLm1pbn0gYW5kICR7VklUQUxfUkFOR0VTLmRpYXN0b2xpY0JQLm1heH0gJHtWSVRBTF9SQU5HRVMuZGlhc3RvbGljQlAudW5pdH1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGlmICh2aXRhbHMudGVtcGVyYXR1cmUgIT09IHVuZGVmaW5lZCkge1xuICAgIGlmICh2aXRhbHMudGVtcGVyYXR1cmUgPCBWSVRBTF9SQU5HRVMudGVtcGVyYXR1cmUubWluIHx8IHZpdGFscy50ZW1wZXJhdHVyZSA+IFZJVEFMX1JBTkdFUy50ZW1wZXJhdHVyZS5tYXgpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgVGVtcGVyYXR1cmUgbXVzdCBiZSBiZXR3ZWVuICR7VklUQUxfUkFOR0VTLnRlbXBlcmF0dXJlLm1pbn0gYW5kICR7VklUQUxfUkFOR0VTLnRlbXBlcmF0dXJlLm1heH0gJHtWSVRBTF9SQU5HRVMudGVtcGVyYXR1cmUudW5pdH1gXG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIGlmICh2aXRhbHMub3h5Z2VuU2F0dXJhdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKFxuICAgICAgdml0YWxzLm94eWdlblNhdHVyYXRpb24gPCBWSVRBTF9SQU5HRVMub3h5Z2VuU2F0dXJhdGlvbi5taW4gfHxcbiAgICAgIHZpdGFscy5veHlnZW5TYXR1cmF0aW9uID4gVklUQUxfUkFOR0VTLm94eWdlblNhdHVyYXRpb24ubWF4XG4gICAgKSB7XG4gICAgICBlcnJvcnMucHVzaChcbiAgICAgICAgYE94eWdlbiBzYXR1cmF0aW9uIG11c3QgYmUgYmV0d2VlbiAke1ZJVEFMX1JBTkdFUy5veHlnZW5TYXR1cmF0aW9uLm1pbn0gYW5kICR7VklUQUxfUkFOR0VTLm94eWdlblNhdHVyYXRpb24ubWF4fSAke1ZJVEFMX1JBTkdFUy5veHlnZW5TYXR1cmF0aW9uLnVuaXR9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICBpZiAodml0YWxzLndlaWdodCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgaWYgKHZpdGFscy53ZWlnaHQgPCBWSVRBTF9SQU5HRVMud2VpZ2h0Lm1pbiB8fCB2aXRhbHMud2VpZ2h0ID4gVklUQUxfUkFOR0VTLndlaWdodC5tYXgpIHtcbiAgICAgIGVycm9ycy5wdXNoKFxuICAgICAgICBgV2VpZ2h0IG11c3QgYmUgYmV0d2VlbiAke1ZJVEFMX1JBTkdFUy53ZWlnaHQubWlufSBhbmQgJHtWSVRBTF9SQU5HRVMud2VpZ2h0Lm1heH0gJHtWSVRBTF9SQU5HRVMud2VpZ2h0LnVuaXR9YFxuICAgICAgKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4geyB2YWxpZDogZXJyb3JzLmxlbmd0aCA9PT0gMCwgZXJyb3JzIH07XG59XG5cbi8qKlxuICogUmVjb3JkIHZpdGFsIHNpZ25zIGZvciBhIHVzZXJcbiAqIFBPU1QgL2FwaS92MS9oZWFsdGgvdml0YWxzXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50OiBBUElHYXRld2F5UHJveHlFdmVudCk6IFByb21pc2U8QVBJR2F0ZXdheVByb3h5UmVzdWx0PiB7XG4gIHRyeSB7XG4gICAgLy8gRXh0cmFjdCB1c2VyIGluZm8gZnJvbSBhdXRob3JpemVyIGNvbnRleHRcbiAgICBjb25zdCB1c2VySWQgPSBldmVudC5yZXF1ZXN0Q29udGV4dC5hdXRob3JpemVyPy5wcmluY2lwYWxJZDtcbiAgICBjb25zdCB1c2VyVHlwZSA9IGV2ZW50LnJlcXVlc3RDb250ZXh0LmF1dGhvcml6ZXI/LnVzZXJUeXBlIGFzICdwcmltYXJ5JyB8ICdzZWNvbmRhcnknO1xuXG4gICAgaWYgKCF1c2VySWQgfHwgIXVzZXJUeXBlKSB7XG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDEsICdVbmF1dGhvcml6ZWQ6IE1pc3NpbmcgdXNlciBjb250ZXh0Jyk7XG4gICAgfVxuXG4gICAgLy8gUGFyc2UgcmVxdWVzdCBib2R5XG4gICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsICdNaXNzaW5nIHJlcXVlc3QgYm9keScpO1xuICAgIH1cblxuICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xuICAgIGNvbnN0IHsgdml0YWxzLCBkZXZpY2VJZCB9ID0gYm9keTtcblxuICAgIGlmICghdml0YWxzKSB7XG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsICdNaXNzaW5nIHZpdGFscyBkYXRhJyk7XG4gICAgfVxuXG4gICAgLy8gRGV0ZXJtaW5lIHRhcmdldCB1c2VyIElEIChwcmltYXJ5IHVzZXIgcmVjb3JkcyBmb3IgdGhlbXNlbHZlcywgc2Vjb25kYXJ5IHVzZXIgY2Fubm90IHJlY29yZClcbiAgICBsZXQgdGFyZ2V0VXNlcklkID0gdXNlcklkO1xuICAgIGlmICh1c2VyVHlwZSA9PT0gJ3NlY29uZGFyeScpIHtcbiAgICAgIC8vIFNlY29uZGFyeSB1c2VycyBjYW5ub3QgcmVjb3JkIHZpdGFsIHNpZ25zXG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDMsICdGb3JiaWRkZW46IFNlY29uZGFyeSB1c2VycyBjYW5ub3QgcmVjb3JkIHZpdGFsIHNpZ25zJyk7XG4gICAgfVxuXG4gICAgLy8gR2VuZXJhdGUgdGltZXN0YW1wXG4gICAgY29uc3QgdGltZXN0YW1wID0gbmV3IERhdGUoKTtcblxuICAgIC8vIENvbnN0cnVjdCBWaXRhbFNpZ25zIG9iamVjdFxuICAgIGNvbnN0IHZpdGFsU2lnbnM6IFZpdGFsU2lnbnMgPSB7XG4gICAgICBoZWFydFJhdGU6IHZpdGFscy5oZWFydFJhdGUsXG4gICAgICBibG9vZFByZXNzdXJlOiB2aXRhbHMuYmxvb2RQcmVzc3VyZVxuICAgICAgICA/IHtcbiAgICAgICAgICAgIHN5c3RvbGljOiB2aXRhbHMuYmxvb2RQcmVzc3VyZS5zeXN0b2xpYyxcbiAgICAgICAgICAgIGRpYXN0b2xpYzogdml0YWxzLmJsb29kUHJlc3N1cmUuZGlhc3RvbGljLFxuICAgICAgICAgIH1cbiAgICAgICAgOiB1bmRlZmluZWQsXG4gICAgICB0ZW1wZXJhdHVyZTogdml0YWxzLnRlbXBlcmF0dXJlLFxuICAgICAgb3h5Z2VuU2F0dXJhdGlvbjogdml0YWxzLm94eWdlblNhdHVyYXRpb24sXG4gICAgICB3ZWlnaHQ6IHZpdGFscy53ZWlnaHQsXG4gICAgICB0aW1lc3RhbXAsXG4gICAgICBzb3VyY2U6IGRldmljZUlkID8gJ2RldmljZScgOiAnbWFudWFsJyxcbiAgICB9O1xuXG4gICAgLy8gVmFsaWRhdGUgdml0YWwgc2lnbnNcbiAgICBjb25zdCB2YWxpZGF0aW9uID0gdmFsaWRhdGVWaXRhbFNpZ25zKHZpdGFsU2lnbnMpO1xuICAgIGlmICghdmFsaWRhdGlvbi52YWxpZCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoNDAwLCBgVmFsaWRhdGlvbiBmYWlsZWQ6ICR7dmFsaWRhdGlvbi5lcnJvcnMuam9pbignLCAnKX1gKTtcbiAgICB9XG5cbiAgICAvLyBHZXQgdXNlcidzIGJhc2VsaW5lIHZpdGFscyBmb3IgYW5vbWFseSBkZXRlY3Rpb25cbiAgICBjb25zdCB1c2VyID0gYXdhaXQgZ2V0VXNlcih0YXJnZXRVc2VySWQpO1xuICAgIGNvbnN0IGJhc2VsaW5lVml0YWxzID0gdXNlcj8uaGVhbHRoUHJvZmlsZT8uYmFzZWxpbmVWaXRhbHM7XG5cbiAgICAvLyBEZXRlY3QgYW5vbWFsaWVzXG4gICAgY29uc3QgYW5vbWFsaWVzID0gZGV0ZWN0QW5vbWFsaWVzKHZpdGFsU2lnbnMsIGJhc2VsaW5lVml0YWxzKTtcbiAgICBjb25zdCBoYXNBbm9tYWxpZXMgPSBhbm9tYWxpZXMubGVuZ3RoID4gMDtcbiAgICBjb25zdCBzaG91bGRBbGVydCA9IHNob3VsZFRyaWdnZXJBbGVydChhbm9tYWxpZXMpO1xuXG4gICAgLy8gU3RvcmUgaW4gVGltZXN0cmVhbVxuICAgIGF3YWl0IHdyaXRlVml0YWxTaWducyhcbiAgICAgIHRhcmdldFVzZXJJZCxcbiAgICAgIHtcbiAgICAgICAgaGVhcnRSYXRlOiB2aXRhbFNpZ25zLmhlYXJ0UmF0ZSxcbiAgICAgICAgc3lzdG9saWNCUDogdml0YWxTaWducy5ibG9vZFByZXNzdXJlPy5zeXN0b2xpYyxcbiAgICAgICAgZGlhc3RvbGljQlA6IHZpdGFsU2lnbnMuYmxvb2RQcmVzc3VyZT8uZGlhc3RvbGljLFxuICAgICAgICB0ZW1wZXJhdHVyZTogdml0YWxTaWducy50ZW1wZXJhdHVyZSxcbiAgICAgICAgb3h5Z2VuU2F0dXJhdGlvbjogdml0YWxTaWducy5veHlnZW5TYXR1cmF0aW9uLFxuICAgICAgICB3ZWlnaHQ6IHZpdGFsU2lnbnMud2VpZ2h0LFxuICAgICAgfSxcbiAgICAgIHRpbWVzdGFtcCxcbiAgICAgIHZpdGFsU2lnbnMuc291cmNlXG4gICAgKTtcblxuICAgIC8vIExvZyBkYXRhIGFjY2Vzc1xuICAgIGF3YWl0IGxvZ0RhdGFBY2Nlc3ModXNlcklkLCB1c2VyVHlwZSwgdGFyZ2V0VXNlcklkLCAndml0YWxzJywgJ3dyaXRlJywgdHJ1ZSwgWyd2aXRhbHMnXSwge1xuICAgICAgc291cmNlOiB2aXRhbFNpZ25zLnNvdXJjZSxcbiAgICAgIGRldmljZUlkLFxuICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAudG9JU09TdHJpbmcoKSxcbiAgICAgIGFub21hbGllc0RldGVjdGVkOiBoYXNBbm9tYWxpZXMsXG4gICAgICBhbGVydFRyaWdnZXJlZDogc2hvdWxkQWxlcnQsXG4gICAgfSk7XG5cbiAgICAvLyBUT0RPOiBUcmlnZ2VyIGFsZXJ0IGdlbmVyYXRpb24gaWYgYW5vbWFsaWVzIGRldGVjdGVkICh3aWxsIGJlIGltcGxlbWVudGVkIGluIHRhc2sgNilcbiAgICAvLyBUaGlzIHdpbGwgYmUgaGFuZGxlZCBieSB0aGUgQWxlcnQgTWFuYWdlbWVudCBTZXJ2aWNlXG5cbiAgICByZXR1cm4gY3JlYXRlU3VjY2Vzc1Jlc3BvbnNlKHtcbiAgICAgIG1lc3NhZ2U6ICdWaXRhbCBzaWducyByZWNvcmRlZCBzdWNjZXNzZnVsbHknLFxuICAgICAgdXNlcklkOiB0YXJnZXRVc2VySWQsXG4gICAgICB0aW1lc3RhbXA6IHRpbWVzdGFtcC50b0lTT1N0cmluZygpLFxuICAgICAgdml0YWxzOiB2aXRhbFNpZ25zLFxuICAgICAgYW5vbWFsaWVzOiBoYXNBbm9tYWxpZXMgPyBhbm9tYWxpZXMgOiB1bmRlZmluZWQsXG4gICAgICBhbGVydFRyaWdnZXJlZDogc2hvdWxkQWxlcnQsXG4gICAgfSk7XG4gIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgY29uc29sZS5lcnJvcignUmVjb3JkIHZpdGFsIHNpZ25zIGVycm9yOicsIGVycm9yKTtcbiAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg1MDAsICdJbnRlcm5hbCBzZXJ2ZXIgZXJyb3InKTtcbiAgfVxufVxuIl19