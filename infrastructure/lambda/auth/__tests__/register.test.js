"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
// Mock AWS SDK clients before importing handler
jest.mock('@aws-sdk/client-cognito-identity-provider');
jest.mock('@aws-sdk/client-dynamodb');
jest.mock('@aws-sdk/lib-dynamodb');
const client_cognito_identity_provider_1 = require("@aws-sdk/client-cognito-identity-provider");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
const register_1 = require("../register");
const mockCognitoSend = jest.fn();
const mockDynamoSend = jest.fn();
client_cognito_identity_provider_1.CognitoIdentityProviderClient.mockImplementation(() => ({
    send: mockCognitoSend,
}));
lib_dynamodb_1.DynamoDBDocumentClient.from.mockReturnValue({
    send: mockDynamoSend,
});
describe('Register Lambda Function', () => {
    beforeEach(() => {
        jest.clearAllMocks();
        process.env.PRIMARY_USER_POOL_ID = 'test-primary-pool';
        process.env.SECONDARY_USER_POOL_ID = 'test-secondary-pool';
        process.env.PRIMARY_USER_POOL_CLIENT_ID = 'test-primary-client';
        process.env.SECONDARY_USER_POOL_CLIENT_ID = 'test-secondary-client';
        process.env.USERS_TABLE = 'test-users-table';
    });
    const createEvent = (body) => ({
        body: JSON.stringify(body),
        headers: {},
        multiValueHeaders: {},
        httpMethod: 'POST',
        isBase64Encoded: false,
        path: '/auth/register',
        pathParameters: null,
        queryStringParameters: null,
        multiValueQueryStringParameters: null,
        stageVariables: null,
        requestContext: {},
        resource: '',
    });
    test('should successfully register a primary user', async () => {
        const requestBody = {
            email: 'primary@example.com',
            password: 'SecurePass123!',
            userType: 'primary',
            profile: {
                firstName: 'John',
                lastName: 'Doe',
                email: 'primary@example.com',
                phone: '+1234567890',
                dateOfBirth: '1950-01-01',
            },
            phoneNumber: '+1234567890',
        };
        mockCognitoSend.mockResolvedValueOnce({
            UserSub: 'test-user-id-123',
        });
        mockCognitoSend.mockResolvedValueOnce({}); // AdminAddUserToGroupCommand
        mockDynamoSend.mockResolvedValueOnce({});
        const event = createEvent(requestBody);
        const result = await (0, register_1.handler)(event);
        expect(result.statusCode).toBe(200);
        const body = JSON.parse(result.body);
        expect(body.userId).toBe('test-user-id-123');
        expect(body.userType).toBe('primary');
        expect(body.emailVerificationRequired).toBe(true);
        expect(mockCognitoSend).toHaveBeenCalledWith(expect.any(client_cognito_identity_provider_1.SignUpCommand));
        expect(mockDynamoSend).toHaveBeenCalledWith(expect.any(lib_dynamodb_1.PutCommand));
    });
    test('should successfully register a secondary user', async () => {
        const requestBody = {
            email: 'secondary@example.com',
            password: 'SecurePass123!',
            userType: 'secondary',
            profile: {
                firstName: 'Jane',
                lastName: 'Smith',
                email: 'secondary@example.com',
                phone: '+1234567890',
                dateOfBirth: '1980-01-01',
            },
        };
        mockCognitoSend.mockResolvedValueOnce({
            UserSub: 'test-user-id-456',
        });
        mockCognitoSend.mockResolvedValueOnce({});
        mockDynamoSend.mockResolvedValueOnce({});
        const event = createEvent(requestBody);
        const result = await (0, register_1.handler)(event);
        expect(result.statusCode).toBe(200);
        const body = JSON.parse(result.body);
        expect(body.userId).toBe('test-user-id-456');
        expect(body.userType).toBe('secondary');
    });
    test('should return 400 when request body is missing', async () => {
        const event = createEvent(null);
        event.body = null;
        const result = await (0, register_1.handler)(event);
        expect(result.statusCode).toBe(400);
        const body = JSON.parse(result.body);
        expect(body.error).toBe('Request body is required');
    });
    test('should return 400 when required fields are missing', async () => {
        const requestBody = {
            email: 'test@example.com',
            // Missing password, userType, profile
        };
        const event = createEvent(requestBody);
        const result = await (0, register_1.handler)(event);
        expect(result.statusCode).toBe(400);
        const body = JSON.parse(result.body);
        expect(body.error).toContain('Missing required fields');
    });
    test('should return 400 when userType is invalid', async () => {
        const requestBody = {
            email: 'test@example.com',
            password: 'SecurePass123!',
            userType: 'invalid',
            profile: {
                firstName: 'Test',
                lastName: 'User',
                email: 'test@example.com',
                phone: '+1234567890',
                dateOfBirth: '1990-01-01',
            },
        };
        const event = createEvent(requestBody);
        const result = await (0, register_1.handler)(event);
        expect(result.statusCode).toBe(400);
        const body = JSON.parse(result.body);
        expect(body.error).toContain('userType must be either "primary" or "secondary"');
    });
    test('should return 409 when user already exists', async () => {
        const requestBody = {
            email: 'existing@example.com',
            password: 'SecurePass123!',
            userType: 'primary',
            profile: {
                firstName: 'Existing',
                lastName: 'User',
                email: 'existing@example.com',
                phone: '+1234567890',
                dateOfBirth: '1950-01-01',
            },
        };
        const error = new Error('User already exists');
        error.name = 'UsernameExistsException';
        mockCognitoSend.mockRejectedValueOnce(error);
        const event = createEvent(requestBody);
        const result = await (0, register_1.handler)(event);
        expect(result.statusCode).toBe(409);
        const body = JSON.parse(result.body);
        expect(body.error).toContain('already exists');
    });
    test('should return 400 when password is invalid', async () => {
        const requestBody = {
            email: 'test@example.com',
            password: 'weak',
            userType: 'primary',
            profile: {
                firstName: 'Test',
                lastName: 'User',
                email: 'test@example.com',
                phone: '+1234567890',
                dateOfBirth: '1950-01-01',
            },
        };
        const error = new Error('Password does not meet requirements');
        error.name = 'InvalidPasswordException';
        mockCognitoSend.mockRejectedValueOnce(error);
        const event = createEvent(requestBody);
        const result = await (0, register_1.handler)(event);
        expect(result.statusCode).toBe(400);
        const body = JSON.parse(result.body);
        expect(body.error).toContain('Password does not meet requirements');
    });
    test('should handle DynamoDB errors gracefully', async () => {
        const requestBody = {
            email: 'test@example.com',
            password: 'SecurePass123!',
            userType: 'primary',
            profile: {
                firstName: 'Test',
                lastName: 'User',
                email: 'test@example.com',
                phone: '+1234567890',
                dateOfBirth: '1950-01-01',
            },
        };
        mockCognitoSend.mockResolvedValueOnce({
            UserSub: 'test-user-id-789',
        });
        mockCognitoSend.mockResolvedValueOnce({});
        mockDynamoSend.mockRejectedValueOnce(new Error('DynamoDB error'));
        const event = createEvent(requestBody);
        const result = await (0, register_1.handler)(event);
        expect(result.statusCode).toBe(500);
        const body = JSON.parse(result.body);
        expect(body.error).toContain('Registration failed');
    });
    test('should create primary user with default baseline vitals', async () => {
        const requestBody = {
            email: 'primary@example.com',
            password: 'SecurePass123!',
            userType: 'primary',
            profile: {
                firstName: 'John',
                lastName: 'Doe',
                email: 'primary@example.com',
                phone: '+1234567890',
                dateOfBirth: '1950-01-01',
            },
        };
        mockCognitoSend.mockResolvedValueOnce({
            UserSub: 'test-user-id-123',
        });
        mockCognitoSend.mockResolvedValueOnce({});
        mockDynamoSend.mockResolvedValueOnce({});
        const event = createEvent(requestBody);
        await (0, register_1.handler)(event);
        expect(mockDynamoSend).toHaveBeenCalledWith(expect.objectContaining({
            input: expect.objectContaining({
                Item: expect.objectContaining({
                    healthProfile: expect.objectContaining({
                        baselineVitals: expect.objectContaining({
                            heartRate: { min: 60, max: 100 },
                            bloodPressure: {
                                systolic: { min: 90, max: 140 },
                                diastolic: { min: 60, max: 90 },
                            },
                        }),
                    }),
                }),
            }),
        }));
    });
});
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXIudGVzdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInJlZ2lzdGVyLnRlc3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7QUFFQSxnREFBZ0Q7QUFDaEQsSUFBSSxDQUFDLElBQUksQ0FBQywyQ0FBMkMsQ0FBQyxDQUFDO0FBQ3ZELElBQUksQ0FBQyxJQUFJLENBQUMsMEJBQTBCLENBQUMsQ0FBQztBQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLHVCQUF1QixDQUFDLENBQUM7QUFFbkMsZ0dBQXFJO0FBQ3JJLHdEQUEyRTtBQUMzRSwwQ0FBc0M7QUFFdEMsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDO0FBQ2xDLE1BQU0sY0FBYyxHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztBQUVoQyxnRUFBMkMsQ0FBQyxrQkFBa0IsQ0FBQyxHQUFHLEVBQUUsQ0FBQyxDQUFDO0lBQ3JFLElBQUksRUFBRSxlQUFlO0NBQ3RCLENBQUMsQ0FBQyxDQUFDO0FBRUgscUNBQXNCLENBQUMsSUFBa0IsQ0FBQyxlQUFlLENBQUM7SUFDekQsSUFBSSxFQUFFLGNBQWM7Q0FDckIsQ0FBQyxDQUFDO0FBRUgsUUFBUSxDQUFDLDBCQUEwQixFQUFFLEdBQUcsRUFBRTtJQUN4QyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2QsSUFBSSxDQUFDLGFBQWEsRUFBRSxDQUFDO1FBQ3JCLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLEdBQUcsbUJBQW1CLENBQUM7UUFDdkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyxzQkFBc0IsR0FBRyxxQkFBcUIsQ0FBQztRQUMzRCxPQUFPLENBQUMsR0FBRyxDQUFDLDJCQUEyQixHQUFHLHFCQUFxQixDQUFDO1FBQ2hFLE9BQU8sQ0FBQyxHQUFHLENBQUMsNkJBQTZCLEdBQUcsdUJBQXVCLENBQUM7UUFDcEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFXLEdBQUcsa0JBQWtCLENBQUM7SUFDL0MsQ0FB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MUMsY0FBYyxDQUFDLHFCQUFxQixDQUFDLEVBQUUsQ0FBQyxDQUFDO1FBRXpDLE1BQU0sS0FBSyxHQUFHLFdBQVcsQ0FBQyxXQUFXLENBQUMsQ0FBQztRQUN2QyxNQUFNLElBQUEsa0JBQU8sRUFBQyxLQUFLLENBQUMsQ0FBQztRQUVyQixNQUFNLENBQUMsY0FBYyxDQUFDLENBQUMsb0JBQW9CLENBQ3pDLE1BQU0sQ0FBQyxnQkFBZ0IsQ0FBQztZQUN0QixLQUFLLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDO2dCQUM3QixJQUFJLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDO29CQUM1QixhQUFhLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDO3dCQUNyQyxjQUFjLEVBQUUsTUFBTSxDQUFDLGdCQUFnQixDQUFDOzRCQUN0QyxTQUFTLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7NEJBQ2hDLGFBQWEsRUFBRTtnQ0FDYixRQUFRLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxHQUFHLEVBQUU7Z0NBQy9CLFNBQVMsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRTs2QkFDaEM7eUJBQ0YsQ0FBQztxQkFDSCxDQUFDO2lCQUNILENBQUM7YUFDSCxDQUFDO1NBQ0gsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgQVBJR2F0ZXdheVByb3h5RXZlbnQgfSBmcm9tICdhd3MtbGFtYmRhJztcblxuLy8gTW9jayBBV1MgU0RLIGNsaWVudHMgYmVmb3JlIGltcG9ydGluZyBoYW5kbGVyXG5qZXN0Lm1vY2soJ0Bhd3Mtc2RrL2NsaWVudC1jb2duaXRvLWlkZW50aXR5LXByb3ZpZGVyJyk7XG5qZXN0Lm1vY2soJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYicpO1xuamVzdC5tb2NrKCdAYXdzLXNkay9saWItZHluYW1vZGInKTtcblxuaW1wb3J0IHsgQ29nbml0b0lkZW50aXR5UHJvdmlkZXJDbGllbnQsIFNpZ25VcENvbW1hbmQsIEFkbWluQWRkVXNlclRvR3JvdXBDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNvZ25pdG8taWRlbnRpdHktcHJvdmlkZXInO1xuaW1wb3J0IHsgRHluYW1vREJEb2N1bWVudENsaWVudCwgUHV0Q29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5pbXBvcnQgeyBoYW5kbGVyIH0gZnJvbSAnLi4vcmVnaXN0ZXInO1xuXG5jb25zdCBtb2NrQ29nbml0b1NlbmQgPSBqZXN0LmZuKCk7XG5jb25zdCBtb2NrRHluYW1vU2VuZCA9IGplc3QuZm4oKTtcblxuKENvZ25pdG9JZGVudGl0eVByb3ZpZGVyQ2xpZW50IGFzIGplc3QuTW9jaykubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+ICh7XG4gIHNlbmQ6IG1vY2tDb2duaXRvU2VuZCxcbn0pKTtcblxuKER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbSBhcyBqZXN0Lk1vY2spLm1vY2tSZXR1cm5WYWx1ZSh7XG4gIHNlbmQ6IG1vY2tEeW5hbW9TZW5kLFxufSk7XG5cbmRlc2NyaWJlKCdSZWdpc3RlciBMYW1iZGEgRnVuY3Rpb24nLCAoKSA9PiB7XG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICAgIHByb2Nlc3MuZW52LlBSSU1BUllfVVNFUl9QT09MX0lEID0gJ3Rlc3QtcHJpbWFyeS1wb29sJztcbiAgICBwcm9jZXNzLmVudi5TRUNPTkRBUllfVVNFUl9QT09MX0lEID0gJ3Rlc3Qtc2Vjb25kYXJ5LXBvb2wnO1xuICAgIHByb2Nlc3MuZW52LlBSSU1BUllfVVNFUl9QT09MX0NMSUVOVF9JRCA9ICd0ZXN0LXByaW1hcnktY2xpZW50JztcbiAgICBwcm9jZXNzLmVudi5TRUNPTkRBUllfVVNFUl9QT09MX0NMSUVOVF9JRCA9ICd0ZXN0LXNlY29uZGFyeS1jbGllbnQnO1xuICAgIHByb2Nlc3MuZW52LlVTRVJTX1RBQkxFID0gJ3Rlc3QtdXNlcnMtdGFibGUnO1xuICB9KTtcblxuICBjb25zdCBjcmVhdGVFdmVudCA9IChib2R5OiBhbnkpOiBBUElHYXRld2F5UHJveHlFdmVudCA9PiAoe1xuICAgIGJvZHk6IEpTT04uc3RyaW5naWZ5KGJvZHkpLFxuICAgIGhlYWRlcnM6IHt9LFxuICAgIG11bHRpVmFsdWVIZWFkZXJzOiB7fSxcbiAgICBodHRwTWV0aG9kOiAnUE9TVCcsXG4gICAgaXNCYXNlNjRFbmNvZGVkOiBmYWxzZSxcbiAgICBwYXRoOiAnL2F1dGgvcmVnaXN0ZXInLFxuICAgIHBhdGhQYXJhbWV0ZXJzOiBudWxsLFxuICAgIHF1ZXJ5U3RyaW5nUGFyYW1ldGVyczogbnVsbCxcbiAgICBtdWx0aVZhbHVlUXVlcnlTdHJpbmdQYXJhbWV0ZXJzOiBudWxsLFxuICAgIHN0YWdlVmFyaWFibGVzOiBudWxsLFxuICAgIHJlcXVlc3RDb250ZXh0OiB7fSBhcyBhbnksXG4gICAgcmVzb3VyY2U6ICcnLFxuICB9KTtcblxuICB0ZXN0KCdzaG91bGQgc3VjY2Vzc2Z1bGx5IHJlZ2lzdGVyIGEgcHJpbWFyeSB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgZW1haWw6ICdwcmltYXJ5QGV4YW1wbGUuY29tJyxcbiAgICAgIHBhc3N3b3JkOiAnU2VjdXJlUGFzczEyMyEnLFxuICAgICAgdXNlclR5cGU6ICdwcmltYXJ5JyxcbiAgICAgIHByb2ZpbGU6IHtcbiAgICAgICAgZmlyc3ROYW1lOiAnSm9obicsXG4gICAgICAgIGxhc3ROYW1lOiAnRG9lJyxcbiAgICAgICAgZW1haWw6ICdwcmltYXJ5QGV4YW1wbGUuY29tJyxcbiAgICAgICAgcGhvbmU6ICcrMTIzNDU2Nzg5MCcsXG4gICAgICAgIGRhdGVPZkJpcnRoOiAnMTk1MC0wMS0wMScsXG4gICAgICB9LFxuICAgICAgcGhvbmVOdW1iZXI6ICcrMTIzNDU2Nzg5MCcsXG4gICAgfTtcblxuICAgIG1vY2tDb2duaXRvU2VuZC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgVXNlclN1YjogJ3Rlc3QtdXNlci1pZC0xMjMnLFxuICAgIH0pO1xuICAgIG1vY2tDb2duaXRvU2VuZC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe30pOyAvLyBBZG1pbkFkZFVzZXJUb0dyb3VwQ29tbWFuZFxuICAgIG1vY2tEeW5hbW9TZW5kLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7fSk7XG5cbiAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHJlcXVlc3RCb2R5KTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSgyMDApO1xuICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICBleHBlY3QoYm9keS51c2VySWQpLnRvQmUoJ3Rlc3QtdXNlci1pZC0xMjMnKTtcbiAgICBleHBlY3QoYm9keS51c2VyVHlwZSkudG9CZSgncHJpbWFyeScpO1xuICAgIGV4cGVjdChib2R5LmVtYWlsVmVyaWZpY2F0aW9uUmVxdWlyZWQpLnRvQmUodHJ1ZSk7XG4gICAgZXhwZWN0KG1vY2tDb2duaXRvU2VuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoZXhwZWN0LmFueShTaWduVXBDb21tYW5kKSk7XG4gICAgZXhwZWN0KG1vY2tEeW5hbW9TZW5kKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3QuYW55KFB1dENvbW1hbmQpKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHN1Y2Nlc3NmdWxseSByZWdpc3RlciBhIHNlY29uZGFyeSB1c2VyJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgZW1haWw6ICdzZWNvbmRhcnlAZXhhbXBsZS5jb20nLFxuICAgICAgcGFzc3dvcmQ6ICdTZWN1cmVQYXNzMTIzIScsXG4gICAgICB1c2VyVHlwZTogJ3NlY29uZGFyeScsXG4gICAgICBwcm9maWxlOiB7XG4gICAgICAgIGZpcnN0TmFtZTogJ0phbmUnLFxuICAgICAgICBsYXN0TmFtZTogJ1NtaXRoJyxcbiAgICAgICAgZW1haWw6ICdzZWNvbmRhcnlAZXhhbXBsZS5jb20nLFxuICAgICAgICBwaG9uZTogJysxMjM0NTY3ODkwJyxcbiAgICAgICAgZGF0ZU9mQmlydGg6ICcxOTgwLTAxLTAxJyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIG1vY2tDb2duaXRvU2VuZC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgVXNlclN1YjogJ3Rlc3QtdXNlci1pZC00NTYnLFxuICAgIH0pO1xuICAgIG1vY2tDb2duaXRvU2VuZC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe30pO1xuICAgIG1vY2tEeW5hbW9TZW5kLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7fSk7XG5cbiAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHJlcXVlc3RCb2R5KTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSgyMDApO1xuICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICBleHBlY3QoYm9keS51c2VySWQpLnRvQmUoJ3Rlc3QtdXNlci1pZC00NTYnKTtcbiAgICBleHBlY3QoYm9keS51c2VyVHlwZSkudG9CZSgnc2Vjb25kYXJ5Jyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCByZXR1cm4gNDAwIHdoZW4gcmVxdWVzdCBib2R5IGlzIG1pc3NpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudChudWxsKTtcbiAgICBldmVudC5ib2R5ID0gbnVsbDtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGhhbmRsZXIoZXZlbnQpO1xuXG4gICAgZXhwZWN0KHJlc3VsdC5zdGF0dXNDb2RlKS50b0JlKDQwMCk7XG4gICAgY29uc3QgYm9keSA9IEpTT04ucGFyc2UocmVzdWx0LmJvZHkpO1xuICAgIGV4cGVjdChib2R5LmVycm9yKS50b0JlKCdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHJldHVybiA0MDAgd2hlbiByZXF1aXJlZCBmaWVsZHMgYXJlIG1pc3NpbmcnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVxdWVzdEJvZHkgPSB7XG4gICAgICBlbWFpbDogJ3Rlc3RAZXhhbXBsZS5jb20nLFxuICAgICAgLy8gTWlzc2luZyBwYXNzd29yZCwgdXNlclR5cGUsIHByb2ZpbGVcbiAgICB9O1xuXG4gICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudChyZXF1ZXN0Qm9keSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcbiAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShyZXN1bHQuYm9keSk7XG4gICAgZXhwZWN0KGJvZHkuZXJyb3IpLnRvQ29udGFpbignTWlzc2luZyByZXF1aXJlZCBmaWVsZHMnKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHJldHVybiA0MDAgd2hlbiB1c2VyVHlwZSBpcyBpbnZhbGlkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgIHBhc3N3b3JkOiAnU2VjdXJlUGFzczEyMyEnLFxuICAgICAgdXNlclR5cGU6ICdpbnZhbGlkJyxcbiAgICAgIHByb2ZpbGU6IHtcbiAgICAgICAgZmlyc3ROYW1lOiAnVGVzdCcsXG4gICAgICAgIGxhc3ROYW1lOiAnVXNlcicsXG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgICAgIHBob25lOiAnKzEyMzQ1Njc4OTAnLFxuICAgICAgICBkYXRlT2ZCaXJ0aDogJzE5OTAtMDEtMDEnLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudChyZXF1ZXN0Qm9keSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDAwKTtcbiAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShyZXN1bHQuYm9keSk7XG4gICAgZXhwZWN0KGJvZHkuZXJyb3IpLnRvQ29udGFpbigndXNlclR5cGUgbXVzdCBiZSBlaXRoZXIgXCJwcmltYXJ5XCIgb3IgXCJzZWNvbmRhcnlcIicpO1xuICB9KTtcblxuICB0ZXN0KCdzaG91bGQgcmV0dXJuIDQwOSB3aGVuIHVzZXIgYWxyZWFkeSBleGlzdHMnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVxdWVzdEJvZHkgPSB7XG4gICAgICBlbWFpbDogJ2V4aXN0aW5nQGV4YW1wbGUuY29tJyxcbiAgICAgIHBhc3N3b3JkOiAnU2VjdXJlUGFzczEyMyEnLFxuICAgICAgdXNlclR5cGU6ICdwcmltYXJ5JyxcbiAgICAgIHByb2ZpbGU6IHtcbiAgICAgICAgZmlyc3ROYW1lOiAnRXhpc3RpbmcnLFxuICAgICAgICBsYXN0TmFtZTogJ1VzZXInLFxuICAgICAgICBlbWFpbDogJ2V4aXN0aW5nQGV4YW1wbGUuY29tJyxcbiAgICAgICAgcGhvbmU6ICcrMTIzNDU2Nzg5MCcsXG4gICAgICAgIGRhdGVPZkJpcnRoOiAnMTk1MC0wMS0wMScsXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignVXNlciBhbHJlYWR5IGV4aXN0cycpO1xuICAgIGVycm9yLm5hbWUgPSAnVXNlcm5hbWVFeGlzdHNFeGNlcHRpb24nO1xuICAgIG1vY2tDb2duaXRvU2VuZC5tb2NrUmVqZWN0ZWRWYWx1ZU9uY2UoZXJyb3IpO1xuXG4gICAgY29uc3QgZXZlbnQgPSBjcmVhdGVFdmVudChyZXF1ZXN0Qm9keSk7XG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgaGFuZGxlcihldmVudCk7XG5cbiAgICBleHBlY3QocmVzdWx0LnN0YXR1c0NvZGUpLnRvQmUoNDA5KTtcbiAgICBjb25zdCBib2R5ID0gSlNPTi5wYXJzZShyZXN1bHQuYm9keSk7XG4gICAgZXhwZWN0KGJvZHkuZXJyb3IpLnRvQ29udGFpbignYWxyZWFkeSBleGlzdHMnKTtcbiAgfSk7XG5cbiAgdGVzdCgnc2hvdWxkIHJldHVybiA0MDAgd2hlbiBwYXNzd29yZCBpcyBpbnZhbGlkJywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgIHBhc3N3b3JkOiAnd2VhaycsXG4gICAgICB1c2VyVHlwZTogJ3ByaW1hcnknLFxuICAgICAgcHJvZmlsZToge1xuICAgICAgICBmaXJzdE5hbWU6ICdUZXN0JyxcbiAgICAgICAgbGFzdE5hbWU6ICdVc2VyJyxcbiAgICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgICAgcGhvbmU6ICcrMTIzNDU2Nzg5MCcsXG4gICAgICAgIGRhdGVPZkJpcnRoOiAnMTk1MC0wMS0wMScsXG4gICAgICB9LFxuICAgIH07XG5cbiAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcignUGFzc3dvcmQgZG9lcyBub3QgbWVldCByZXF1aXJlbWVudHMnKTtcbiAgICBlcnJvci5uYW1lID0gJ0ludmFsaWRQYXNzd29yZEV4Y2VwdGlvbic7XG4gICAgbW9ja0NvZ25pdG9TZW5kLm1vY2tSZWplY3RlZFZhbHVlT25jZShlcnJvcik7XG5cbiAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHJlcXVlc3RCb2R5KTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg0MDApO1xuICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICBleHBlY3QoYm9keS5lcnJvcikudG9Db250YWluKCdQYXNzd29yZCBkb2VzIG5vdCBtZWV0IHJlcXVpcmVtZW50cycpO1xuICB9KTtcblxuICB0ZXN0KCdzaG91bGQgaGFuZGxlIER5bmFtb0RCIGVycm9ycyBncmFjZWZ1bGx5JywgYXN5bmMgKCkgPT4ge1xuICAgIGNvbnN0IHJlcXVlc3RCb2R5ID0ge1xuICAgICAgZW1haWw6ICd0ZXN0QGV4YW1wbGUuY29tJyxcbiAgICAgIHBhc3N3b3JkOiAnU2VjdXJlUGFzczEyMyEnLFxuICAgICAgdXNlclR5cGU6ICdwcmltYXJ5JyxcbiAgICAgIHByb2ZpbGU6IHtcbiAgICAgICAgZmlyc3ROYW1lOiAnVGVzdCcsXG4gICAgICAgIGxhc3ROYW1lOiAnVXNlcicsXG4gICAgICAgIGVtYWlsOiAndGVzdEBleGFtcGxlLmNvbScsXG4gICAgICAgIHBob25lOiAnKzEyMzQ1Njc4OTAnLFxuICAgICAgICBkYXRlT2ZCaXJ0aDogJzE5NTAtMDEtMDEnLFxuICAgICAgfSxcbiAgICB9O1xuXG4gICAgbW9ja0NvZ25pdG9TZW5kLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7XG4gICAgICBVc2VyU3ViOiAndGVzdC11c2VyLWlkLTc4OScsXG4gICAgfSk7XG4gICAgbW9ja0NvZ25pdG9TZW5kLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7fSk7XG4gICAgbW9ja0R5bmFtb1NlbmQubW9ja1JlamVjdGVkVmFsdWVPbmNlKG5ldyBFcnJvcignRHluYW1vREIgZXJyb3InKSk7XG5cbiAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHJlcXVlc3RCb2R5KTtcbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgIGV4cGVjdChyZXN1bHQuc3RhdHVzQ29kZSkudG9CZSg1MDApO1xuICAgIGNvbnN0IGJvZHkgPSBKU09OLnBhcnNlKHJlc3VsdC5ib2R5KTtcbiAgICBleHBlY3QoYm9keS5lcnJvcikudG9Db250YWluKCdSZWdpc3RyYXRpb24gZmFpbGVkJyk7XG4gIH0pO1xuXG4gIHRlc3QoJ3Nob3VsZCBjcmVhdGUgcHJpbWFyeSB1c2VyIHdpdGggZGVmYXVsdCBiYXNlbGluZSB2aXRhbHMnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgcmVxdWVzdEJvZHkgPSB7XG4gICAgICBlbWFpbDogJ3ByaW1hcnlAZXhhbXBsZS5jb20nLFxuICAgICAgcGFzc3dvcmQ6ICdTZWN1cmVQYXNzMTIzIScsXG4gICAgICB1c2VyVHlwZTogJ3ByaW1hcnknLFxuICAgICAgcHJvZmlsZToge1xuICAgICAgICBmaXJzdE5hbWU6ICdKb2huJyxcbiAgICAgICAgbGFzdE5hbWU6ICdEb2UnLFxuICAgICAgICBlbWFpbDogJ3ByaW1hcnlAZXhhbXBsZS5jb20nLFxuICAgICAgICBwaG9uZTogJysxMjM0NTY3ODkwJyxcbiAgICAgICAgZGF0ZU9mQmlydGg6ICcxOTUwLTAxLTAxJyxcbiAgICAgIH0sXG4gICAgfTtcblxuICAgIG1vY2tDb2duaXRvU2VuZC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe1xuICAgICAgVXNlclN1YjogJ3Rlc3QtdXNlci1pZC0xMjMnLFxuICAgIH0pO1xuICAgIG1vY2tDb2duaXRvU2VuZC5tb2NrUmVzb2x2ZWRWYWx1ZU9uY2Uoe30pO1xuICAgIG1vY2tEeW5hbW9TZW5kLm1vY2tSZXNvbHZlZFZhbHVlT25jZSh7fSk7XG5cbiAgICBjb25zdCBldmVudCA9IGNyZWF0ZUV2ZW50KHJlcXVlc3RCb2R5KTtcbiAgICBhd2FpdCBoYW5kbGVyKGV2ZW50KTtcblxuICAgIGV4cGVjdChtb2NrRHluYW1vU2VuZCkudG9IYXZlQmVlbkNhbGxlZFdpdGgoXG4gICAgICBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgIGlucHV0OiBleHBlY3Qub2JqZWN0Q29udGFpbmluZyh7XG4gICAgICAgICAgSXRlbTogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgaGVhbHRoUHJvZmlsZTogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICBiYXNlbGluZVZpdGFsczogZXhwZWN0Lm9iamVjdENvbnRhaW5pbmcoe1xuICAgICAgICAgICAgICAgIGhlYXJ0UmF0ZTogeyBtaW46IDYwLCBtYXg6IDEwMCB9LFxuICAgICAgICAgICAgICAgIGJsb29kUHJlc3N1cmU6IHtcbiAgICAgICAgICAgICAgICAgIHN5c3RvbGljOiB7IG1pbjogOTAsIG1heDogMTQwIH0sXG4gICAgICAgICAgICAgICAgICBkaWFzdG9saWM6IHsgbWluOiA2MCwgbWF4OiA5MCB9LFxuICAgICAgICAgICAgICAgIH0sXG4gICAgICAgICAgICAgIH0pLFxuICAgICAgICAgICAgfSksXG4gICAgICAgICAgfSksXG4gICAgICAgIH0pLFxuICAgICAgfSlcbiAgICApO1xuICB9KTtcbn0pO1xuIl19