"use strict";
// Device Connectivity Monitoring Lambda Function
// Requirements: 7.1, 7.5
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const util_dynamodb_1 = require("@aws-sdk/util-dynamodb");
const devices_1 = require("../shared/data-access/devices");
const eventBridgeClient = new client_eventbridge_1.EventBridgeClient({});
const dynamoClient = new client_dynamodb_1.DynamoDBClient({});
const DEVICES_TABLE = process.env.DEVICES_TABLE;
const EVENT_BUS_NAME = process.env.EVENT_BUS_NAME;
// 15 minutes in milliseconds
const SYNC_INTERVAL_MS = 15 * 60 * 1000;
// Grace period before marking as disconnected (20 minutes)
const DISCONNECT_THRESHOLD_MS = 20 * 60 * 1000;
async function handler(event) {
    console.log('Connectivity monitoring triggered:', JSON.stringify(event, null, 2));
    try {
        // Check if this is a device status update from IoT
        if ('deviceId' in event && 'status' in event) {
            await handleDeviceStatusUpdate(event);
            return;
        }
        // Otherwise, this is a scheduled check
        await checkAllDeviceConnectivity();
    }
    catch (error) {
        console.error('Error monitoring device connectivity:', error);
        throw error;
    }
}
async function handleDeviceStatusUpdate(payload) {
    console.log(`Device status update: ${payload.deviceId} - ${payload.status}`);
    // Update device status in database
    await (0, devices_1.updateDeviceStatus)(payload.deviceId, payload.status, new Date(payload.timestamp));
    // If device disconnected, send notification
    if (payload.status === 'disconnected') {
        await publishEvent('device.disconnected', {
            deviceId: payload.deviceId,
            timestamp: payload.timestamp,
        });
    }
    else if (payload.status === 'connected') {
        await publishEvent('device.connected', {
            deviceId: payload.deviceId,
            timestamp: payload.timestamp,
        });
    }
}
async function checkAllDeviceConnectivity() {
    console.log('Checking connectivity for all devices');
    // Scan all devices
    const scanCommand = new client_dynamodb_1.ScanCommand({
        TableName: DEVICES_TABLE,
    });
    const result = await dynamoClient.send(scanCommand);
    if (!result.Items || result.Items.length === 0) {
        console.log('No devices found');
        return;
    }
    const devices = result.Items.map((item) => (0, util_dynamodb_1.unmarshall)(item));
    const now = Date.now();
    let disconnectedCount = 0;
    let reconnectedCount = 0;
    for (const device of devices) {
        // Skip devices that are already in error state
        if (device.status === 'error') {
            continue;
        }
        // Check last sync time
        const lastSync = device.lastSync ? new Date(device.lastSync).getTime() : 0;
        const timeSinceSync = now - lastSync;
        // Device should sync every 15 minutes
        if (timeSinceSync > DISCONNECT_THRESHOLD_MS) {
            // Device hasn't synced in over 20 minutes - mark as disconnected
            if (device.status !== 'disconnected') {
                console.log(`Device ${device.id} is disconnected (last sync: ${new Date(lastSync).toISOString()})`);
                await (0, devices_1.updateDeviceStatus)(device.id, 'disconnected');
                disconnectedCount++;
                // Send notification
                await publishEvent('device.connectivity.lost', {
                    deviceId: device.id,
                    userId: device.userId,
                    lastSync: device.lastSync,
                    timeSinceSync: Math.floor(timeSinceSync / 1000 / 60), // minutes
                });
            }
        }
        else {
            // Device is syncing regularly
            if (device.status === 'disconnected') {
                console.log(`Device ${device.id} has reconnected`);
                await (0, devices_1.updateDeviceStatus)(device.id, 'connected');
                reconnectedCount++;
                // Send notification
                await publishEvent('device.connectivity.restored', {
                    deviceId: device.id,
                    userId: device.userId,
                    lastSync: device.lastSync,
                });
            }
        }
    }
    console.log(`Connectivity check complete: ${disconnectedCount} disconnected, ${reconnectedCount} reconnected`);
}
async function publishEvent(eventType, detail) {
    const command = new client_eventbridge_1.PutEventsCommand({
        Entries: [
            {
                Source: 'healthcare.device.connectivity',
                DetailType: eventType,
                Detail: JSON.stringify(detail),
                EventBusName: EVENT_BUS_NAME,
            },
        ],
    });
    await eventBridgeClient.send(command);
    console.log(`Published event: ${eventType}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibW9uaXRvci1jb25uZWN0aXZpdHkuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtb25pdG9yLWNvbm5lY3Rpdml0eS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsaURBQWlEO0FBQ2pELHlCQUF5Qjs7QUEyQnpCLDBCQWdCQztBQXhDRCxvRUFBa0Y7QUFDbEYsOERBQXVFO0FBQ3ZFLDBEQUFvRDtBQUVwRCwyREFBbUU7QUFFbkUsTUFBTSxpQkFBaUIsR0FBRyxJQUFJLHNDQUFpQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3BELE1BQU0sWUFBWSxHQUFHLElBQUksZ0NBQWMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUU1QyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQUNqRCxNQUFNLGNBQWMsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWUsQ0FBQztBQUVuRCw2QkFBNkI7QUFDN0IsTUFBTSxnQkFBZ0IsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQUV4QywyREFBMkQ7QUFDM0QsTUFBTSx1QkFBdUIsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQztBQVF4QyxLQUFLLFVBQVUsT0FBTyxDQUFDLEtBQThEO0lBQzFGLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0NBQW9DLEVBQUUsSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLEVBQUUsSUFBSSxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFFbEYsSUFBSSxDQUFDO1FBQ0gsbURBQW1EO1FBQ25ELElBQUksVUFBVSxJQUFJLEtBQUssSUFBSSxRQUFRLElBQUksS0FBSyxFQUFFLENBQUM7WUFDN0MsTUFBTSx3QkFBd0IsQ0FBQyxLQUE0QixDQUFDLENBQUM7WUFDN0QsT0FBTztRQUNULENBQUM7UUFFRCx1Q0FBdUM7UUFDdkMsTUFBTSwwQkFBMEIsRUFBRSxDQUFDO0lBQ3JDLENBQUM7SUFBQyxPQUFPLEtBQUssRUFB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SSxxQ0FBZ0IsQ0FBQztRQUNuQyxPQUFPLEVBQUU7WUFDUDtnQkFDRSxNQUFNLEVBQUUsZ0NBQWdDO2dCQUN4QyxVQUFVLEVBQUUsU0FBUztnQkFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO2dCQUM5QixZQUFZLEVBQUUsY0FBYzthQUM3QjtTQUNGO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsTUFBTSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsU0FBUyxFQUFFLENBQUMsQ0FBQztBQUMvQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gRGV2aWNlIENvbm5lY3Rpdml0eSBNb25pdG9yaW5nIExhbWJkYSBGdW5jdGlvblxuLy8gUmVxdWlyZW1lbnRzOiA3LjEsIDcuNVxuXG5pbXBvcnQgeyBFdmVudEJyaWRnZUV2ZW50IH0gZnJvbSAnYXdzLWxhbWJkYSc7XG5pbXBvcnQgeyBFdmVudEJyaWRnZUNsaWVudCwgUHV0RXZlbnRzQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1ldmVudGJyaWRnZSc7XG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCwgU2NhbkNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtZHluYW1vZGInO1xuaW1wb3J0IHsgdW5tYXJzaGFsbCB9IGZyb20gJ0Bhd3Mtc2RrL3V0aWwtZHluYW1vZGInO1xuaW1wb3J0IHsgSGVhbHRoRGV2aWNlIH0gZnJvbSAnLi4vc2hhcmVkL3R5cGVzJztcbmltcG9ydCB7IHVwZGF0ZURldmljZVN0YXR1cyB9IGZyb20gJy4uL3NoYXJlZC9kYXRhLWFjY2Vzcy9kZXZpY2VzJztcblxuY29uc3QgZXZlbnRCcmlkZ2VDbGllbnQgPSBuZXcgRXZlbnRCcmlkZ2VDbGllbnQoe30pO1xuY29uc3QgZHluYW1vQ2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHt9KTtcblxuY29uc3QgREVWSUNFU19UQUJMRSA9IHByb2Nlc3MuZW52LkRFVklDRVNfVEFCTEUhO1xuY29uc3QgRVZFTlRfQlVTX05BTUUgPSBwcm9jZXNzLmVudi5FVkVOVF9CVVNfTkFNRSE7XG5cbi8vIDE1IG1pbnV0ZXMgaW4gbWlsbGlzZWNvbmRzXG5jb25zdCBTWU5DX0lOVEVSVkFMX01TID0gMTUgKiA2MCAqIDEwMDA7XG5cbi8vIEdyYWNlIHBlcmlvZCBiZWZvcmUgbWFya2luZyBhcyBkaXNjb25uZWN0ZWQgKDIwIG1pbnV0ZXMpXG5jb25zdCBESVNDT05ORUNUX1RIUkVTSE9MRF9NUyA9IDIwICogNjAgKiAxMDAwO1xuXG5pbnRlcmZhY2UgRGV2aWNlU3RhdHVzUGF5bG9hZCB7XG4gIGRldmljZUlkOiBzdHJpbmc7XG4gIHN0YXR1czogJ2Nvbm5lY3RlZCcgfCAnZGlzY29ubmVjdGVkJztcbiAgdGltZXN0YW1wOiBzdHJpbmc7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBoYW5kbGVyKGV2ZW50OiBFdmVudEJyaWRnZUV2ZW50PHN0cmluZywgdW5rbm93bj4gfCBEZXZpY2VTdGF0dXNQYXlsb2FkKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnNvbGUubG9nKCdDb25uZWN0aXZpdHkgbW9uaXRvcmluZyB0cmlnZ2VyZWQ6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcblxuICB0cnkge1xuICAgIC8vIENoZWNrIGlmIHRoaXMgaXMgYSBkZXZpY2Ugc3RhdHVzIHVwZGF0ZSBmcm9tIElvVFxuICAgIGlmICgnZGV2aWNlSWQnIGluIGV2ZW50ICYmICdzdGF0dXMnIGluIGV2ZW50KSB7XG4gICAgICBhd2FpdCBoYW5kbGVEZXZpY2VTdGF0dXNVcGRhdGUoZXZlbnQgYXMgRGV2aWNlU3RhdHVzUGF5bG9hZCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gT3RoZXJ3aXNlLCB0aGlzIGlzIGEgc2NoZWR1bGVkIGNoZWNrXG4gICAgYXdhaXQgY2hlY2tBbGxEZXZpY2VDb25uZWN0aXZpdHkoKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBtb25pdG9yaW5nIGRldmljZSBjb25uZWN0aXZpdHk6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGhhbmRsZURldmljZVN0YXR1c1VwZGF0ZShwYXlsb2FkOiBEZXZpY2VTdGF0dXNQYXlsb2FkKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnNvbGUubG9nKGBEZXZpY2Ugc3RhdHVzIHVwZGF0ZTogJHtwYXlsb2FkLmRldmljZUlkfSAtICR7cGF5bG9hZC5zdGF0dXN9YCk7XG5cbiAgLy8gVXBkYXRlIGRldmljZSBzdGF0dXMgaW4gZGF0YWJhc2VcbiAgYXdhaXQgdXBkYXRlRGV2aWNlU3RhdHVzKHBheWxvYWQuZGV2aWNlSWQsIHBheWxvYWQuc3RhdHVzLCBuZXcgRGF0ZShwYXlsb2FkLnRpbWVzdGFtcCkpO1xuXG4gIC8vIElmIGRldmljZSBkaXNjb25uZWN0ZWQsIHNlbmQgbm90aWZpY2F0aW9uXG4gIGlmIChwYXlsb2FkLnN0YXR1cyA9PT0gJ2Rpc2Nvbm5lY3RlZCcpIHtcbiAgICBhd2FpdCBwdWJsaXNoRXZlbnQoJ2RldmljZS5kaXNjb25uZWN0ZWQnLCB7XG4gICAgICBkZXZpY2VJZDogcGF5bG9hZC5kZXZpY2VJZCxcbiAgICAgIHRpbWVzdGFtcDogcGF5bG9hZC50aW1lc3RhbXAsXG4gICAgfSk7XG4gIH0gZWxzZSBpZiAocGF5bG9hZC5zdGF0dXMgPT09ICdjb25uZWN0ZWQnKSB7XG4gICAgYXdhaXQgcHVibGlzaEV2ZW50KCdkZXZpY2UuY29ubmVjdGVkJywge1xuICAgICAgZGV2aWNlSWQ6IHBheWxvYWQuZGV2aWNlSWQsXG4gICAgICB0aW1lc3RhbXA6IHBheWxvYWQudGltZXN0YW1wLFxuICAgIH0pO1xuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIGNoZWNrQWxsRGV2aWNlQ29ubmVjdGl2aXR5KCk6IFByb21pc2U8dm9pZD4ge1xuICBjb25zb2xlLmxvZygnQ2hlY2tpbmcgY29ubmVjdGl2aXR5IGZvciBhbGwgZGV2aWNlcycpO1xuXG4gIC8vIFNjYW4gYWxsIGRldmljZXNcbiAgY29uc3Qgc2NhbkNvbW1hbmQgPSBuZXcgU2NhbkNvbW1hbmQoe1xuICAgIFRhYmxlTmFtZTogREVWSUNFU19UQUJMRSxcbiAgfSk7XG5cbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZHluYW1vQ2xpZW50LnNlbmQoc2NhbkNvbW1hbmQpO1xuXG4gIGlmICghcmVzdWx0Lkl0ZW1zIHx8IHJlc3VsdC5JdGVtcy5sZW5ndGggPT09IDApIHtcbiAgICBjb25zb2xlLmxvZygnTm8gZGV2aWNlcyBmb3VuZCcpO1xuICAgIHJldHVybjtcbiAgfVxuXG4gIGNvbnN0IGRldmljZXMgPSByZXN1bHQuSXRlbXMubWFwKChpdGVtKSA9PiB1bm1hcnNoYWxsKGl0ZW0pIGFzIEhlYWx0aERldmljZSk7XG4gIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gIGxldCBkaXNjb25uZWN0ZWRDb3VudCA9IDA7XG4gIGxldCByZWNvbm5lY3RlZENvdW50ID0gMDtcblxuICBmb3IgKGNvbnN0IGRldmljZSBvZiBkZXZpY2VzKSB7XG4gICAgLy8gU2tpcCBkZXZpY2VzIHRoYXQgYXJlIGFscmVhZHkgaW4gZXJyb3Igc3RhdGVcbiAgICBpZiAoZGV2aWNlLnN0YXR1cyA9PT0gJ2Vycm9yJykge1xuICAgICAgY29udGludWU7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgbGFzdCBzeW5jIHRpbWVcbiAgICBjb25zdCBsYXN0U3luYyA9IGRldmljZS5sYXN0U3luYyA/IG5ldyBEYXRlKGRldmljZS5sYXN0U3luYykuZ2V0VGltZSgpIDogMDtcbiAgICBjb25zdCB0aW1lU2luY2VTeW5jID0gbm93IC0gbGFzdFN5bmM7XG5cbiAgICAvLyBEZXZpY2Ugc2hvdWxkIHN5bmMgZXZlcnkgMTUgbWludXRlc1xuICAgIGlmICh0aW1lU2luY2VTeW5jID4gRElTQ09OTkVDVF9USFJFU0hPTERfTVMpIHtcbiAgICAgIC8vIERldmljZSBoYXNuJ3Qgc3luY2VkIGluIG92ZXIgMjAgbWludXRlcyAtIG1hcmsgYXMgZGlzY29ubmVjdGVkXG4gICAgICBpZiAoZGV2aWNlLnN0YXR1cyAhPT0gJ2Rpc2Nvbm5lY3RlZCcpIHtcbiAgICAgICAgY29uc29sZS5sb2coYERldmljZSAke2RldmljZS5pZH0gaXMgZGlzY29ubmVjdGVkIChsYXN0IHN5bmM6ICR7bmV3IERhdGUobGFzdFN5bmMpLnRvSVNPU3RyaW5nKCl9KWApO1xuICAgICAgICBhd2FpdCB1cGRhdGVEZXZpY2VTdGF0dXMoZGV2aWNlLmlkLCAnZGlzY29ubmVjdGVkJyk7XG4gICAgICAgIGRpc2Nvbm5lY3RlZENvdW50Kys7XG5cbiAgICAgICAgLy8gU2VuZCBub3RpZmljYXRpb25cbiAgICAgICAgYXdhaXQgcHVibGlzaEV2ZW50KCdkZXZpY2UuY29ubmVjdGl2aXR5Lmxvc3QnLCB7XG4gICAgICAgICAgZGV2aWNlSWQ6IGRldmljZS5pZCxcbiAgICAgICAgICB1c2VySWQ6IGRldmljZS51c2VySWQsXG4gICAgICAgICAgbGFzdFN5bmM6IGRldmljZS5sYXN0U3luYyxcbiAgICAgICAgICB0aW1lU2luY2VTeW5jOiBNYXRoLmZsb29yKHRpbWVTaW5jZVN5bmMgLyAxMDAwIC8gNjApLCAvLyBtaW51dGVzXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gZWxzZSB7XG4gICAgICAvLyBEZXZpY2UgaXMgc3luY2luZyByZWd1bGFybHlcbiAgICAgIGlmIChkZXZpY2Uuc3RhdHVzID09PSAnZGlzY29ubmVjdGVkJykge1xuICAgICAgICBjb25zb2xlLmxvZyhgRGV2aWNlICR7ZGV2aWNlLmlkfSBoYXMgcmVjb25uZWN0ZWRgKTtcbiAgICAgICAgYXdhaXQgdXBkYXRlRGV2aWNlU3RhdHVzKGRldmljZS5pZCwgJ2Nvbm5lY3RlZCcpO1xuICAgICAgICByZWNvbm5lY3RlZENvdW50Kys7XG5cbiAgICAgICAgLy8gU2VuZCBub3RpZmljYXRpb25cbiAgICAgICAgYXdhaXQgcHVibGlzaEV2ZW50KCdkZXZpY2UuY29ubmVjdGl2aXR5LnJlc3RvcmVkJywge1xuICAgICAgICAgIGRldmljZUlkOiBkZXZpY2UuaWQsXG4gICAgICAgICAgdXNlcklkOiBkZXZpY2UudXNlcklkLFxuICAgICAgICAgIGxhc3RTeW5jOiBkZXZpY2UubGFzdFN5bmMsXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIGNvbnNvbGUubG9nKGBDb25uZWN0aXZpdHkgY2hlY2sgY29tcGxldGU6ICR7ZGlzY29ubmVjdGVkQ291bnR9IGRpc2Nvbm5lY3RlZCwgJHtyZWNvbm5lY3RlZENvdW50fSByZWNvbm5lY3RlZGApO1xufVxuXG5hc3luYyBmdW5jdGlvbiBwdWJsaXNoRXZlbnQoZXZlbnRUeXBlOiBzdHJpbmcsIGRldGFpbDogUmVjb3JkPHN0cmluZywgdW5rbm93bj4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgY29tbWFuZCA9IG5ldyBQdXRFdmVudHNDb21tYW5kKHtcbiAgICBFbnRyaWVzOiBbXG4gICAgICB7XG4gICAgICAgIFNvdXJjZTogJ2hlYWx0aGNhcmUuZGV2aWNlLmNvbm5lY3Rpdml0eScsXG4gICAgICAgIERldGFpbFR5cGU6IGV2ZW50VHlwZSxcbiAgICAgICAgRGV0YWlsOiBKU09OLnN0cmluZ2lmeShkZXRhaWwpLFxuICAgICAgICBFdmVudEJ1c05hbWU6IEVWRU5UX0JVU19OQU1FLFxuICAgICAgfSxcbiAgICBdLFxuICB9KTtcblxuICBhd2FpdCBldmVudEJyaWRnZUNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBjb25zb2xlLmxvZyhgUHVibGlzaGVkIGV2ZW50OiAke2V2ZW50VHlwZX1gKTtcbn1cbiJdfQ==