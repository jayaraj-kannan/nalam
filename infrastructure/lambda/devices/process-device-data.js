"use strict";
// Device Data Processing Lambda Function
// Requirements: 1.2, 7.3, 7.4
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_timestream_write_1 = require("@aws-sdk/client-timestream-write");
const client_eventbridge_1 = require("@aws-sdk/client-eventbridge");
const devices_1 = require("../shared/data-access/devices");
const timestreamClient = new client_timestream_write_1.TimestreamWriteClient({});
const eventBridgeClient = new client_eventbridge_1.EventBridgeClient({});
const DEVICES_TABLE = process.env.DEVICES_TABLE;
const TIMESTREAM_DATABASE = process.env.TIMESTREAM_DATABASE;
const TIMESTREAM_TABLE = process.env.TIMESTREAM_TABLE;
const EVENT_BUS_NAME = process.env.EVENT_BUS_NAME;
// Validation ranges for health metrics
const VALIDATION_RANGES = {
    heart_rate: { min: 30, max: 220 },
    blood_pressure_systolic: { min: 60, max: 250 },
    blood_pressure_diastolic: { min: 30, max: 150 },
    temperature: { min: 32, max: 43 }, // Celsius
    oxygen_saturation: { min: 70, max: 100 },
    glucose: { min: 20, max: 600 }, // mg/dL
    weight: { min: 20, max: 300 }, // kg
};
async function handler(event) {
    console.log('Processing device data:', JSON.stringify(event, null, 2));
    try {
        const payload = event;
        // Validate payload
        if (!payload.deviceId || !payload.readings || payload.readings.length === 0) {
            console.error('Invalid device data payload:', payload);
            return;
        }
        // Get device information
        const device = await (0, devices_1.getDevice)(payload.deviceId);
        if (!device) {
            console.error(`Device not found: ${payload.deviceId}`);
            return;
        }
        // Validate device readings
        const validatedReadings = validateReadings(payload.readings);
        if (validatedReadings.length === 0) {
            console.warn('No valid readings after validation');
            return;
        }
        // Store readings in Timestream
        await storeDeviceReadings(device.userId, payload.deviceId, validatedReadings, payload.timestamp);
        // Update device sync time
        await (0, devices_1.updateDeviceSync)(payload.deviceId);
        // Update battery level if provided
        if (payload.batteryLevel !== undefined) {
            await (0, devices_1.updateDeviceBattery)(payload.deviceId, payload.batteryLevel);
            // Alert if battery is low
            if (payload.batteryLevel < 20) {
                await publishEvent('device.battery.low', {
                    deviceId: payload.deviceId,
                    userId: device.userId,
                    batteryLevel: payload.batteryLevel,
                });
            }
        }
        // Convert device readings to vital signs format
        const vitalSigns = convertToVitalSigns(validatedReadings, payload.timestamp);
        // Publish event for anomaly detection
        if (vitalSigns) {
            await publishEvent('device.data.received', {
                deviceId: payload.deviceId,
                userId: device.userId,
                vitalSigns,
                source: 'device',
            });
        }
        console.log(`Successfully processed data from device: ${payload.deviceId}`);
    }
    catch (error) {
        console.error('Error processing device data:', error);
        throw error;
    }
}
function validateReadings(readings) {
    return readings.filter((reading) => {
        // Check if reading type is supported
        if (!reading.type || !reading.value) {
            console.warn('Invalid reading format:', reading);
            return false;
        }
        // Validate based on sensor type
        let range;
        switch (reading.type) {
            case 'heart_rate':
                range = VALIDATION_RANGES.heart_rate;
                break;
            case 'blood_pressure':
                // Blood pressure readings should have systolic/diastolic in the value
                return true; // Validated separately
            case 'temperature':
                range = VALIDATION_RANGES.temperature;
                break;
            case 'oxygen_saturation':
                range = VALIDATION_RANGES.oxygen_saturation;
                break;
            case 'glucose':
                range = VALIDATION_RANGES.glucose;
                break;
            case 'weight':
                range = VALIDATION_RANGES.weight;
                break;
            default:
                // Allow other sensor types (accelerometer, gyroscope, etc.)
                return true;
        }
        // Validate range if applicable
        if (range) {
            if (reading.value < range.min || reading.value > range.max) {
                console.warn(`Reading out of range: ${reading.type} = ${reading.value} (expected ${range.min}-${range.max})`);
                return false;
            }
        }
        return true;
    });
}
async function storeDeviceReadings(userId, deviceId, readings, timestamp) {
    const records = readings.map((reading) => ({
        Dimensions: [
            { Name: 'userId', Value: userId },
            { Name: 'deviceId', Value: deviceId },
            { Name: 'sensorType', Value: reading.type },
        ],
        MeasureName: 'sensor_reading',
        MeasureValue: reading.value.toString(),
        MeasureValueType: client_timestream_write_1.MeasureValueType.DOUBLE,
        Time: new Date(timestamp).getTime().toString(),
        TimeUnit: client_timestream_write_1.TimeUnit.MILLISECONDS,
    }));
    const command = new client_timestream_write_1.WriteRecordsCommand({
        DatabaseName: TIMESTREAM_DATABASE,
        TableName: TIMESTREAM_TABLE,
        Records: records,
    });
    await timestreamClient.send(command);
    console.log(`Stored ${records.length} readings in Timestream`);
}
function convertToVitalSigns(readings, timestamp) {
    const vitals = {
        timestamp: new Date(timestamp),
        source: 'device',
    };
    let hasVitals = false;
    for (const reading of readings) {
        switch (reading.type) {
            case 'heart_rate':
                vitals.heartRate = reading.value;
                hasVitals = true;
                break;
            case 'temperature':
                vitals.temperature = reading.value;
                hasVitals = true;
                break;
            case 'oxygen_saturation':
                vitals.oxygenSaturation = reading.value;
                hasVitals = true;
                break;
            case 'weight':
                vitals.weight = reading.value;
                hasVitals = true;
                break;
        }
    }
    return hasVitals ? vitals : null;
}
async function publishEvent(eventType, detail) {
    const command = new client_eventbridge_1.PutEventsCommand({
        Entries: [
            {
                Source: 'healthcare.device',
                DetailType: eventType,
                Detail: JSON.stringify(detail),
                EventBusName: EVENT_BUS_NAME,
            },
        ],
    });
    await eventBridgeClient.send(command);
    console.log(`Published event: ${eventType}`);
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicHJvY2Vzcy1kZXZpY2UtZGF0YS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbInByb2Nlc3MtZGV2aWNlLWRhdGEudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLHlDQUF5QztBQUN6Qyw4QkFBOEI7O0FBd0M5QiwwQkFnRUM7QUFyR0QsOEVBQTBIO0FBQzFILG9FQUFrRjtBQUVsRiwyREFBaUc7QUFFakcsTUFBTSxnQkFBZ0IsR0FBRyxJQUFJLCtDQUFxQixDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQ3ZELE1BQU0saUJBQWlCLEdBQUcsSUFBSSxzQ0FBaUIsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVwRCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQUNqRCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW9CLENBQUM7QUFDN0QsTUFBTSxnQkFBZ0IsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFpQixDQUFDO0FBQ3ZELE1BQU0sY0FBYyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsY0FBZSxDQUFDO0FBZW5ELHVDQUF1QztBQUN2QyxNQUFNLGlCQUFpQixHQUFHO0lBQ3hCLFVBQVUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtJQUNqQyx1QkFBdUIsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtJQUM5Qyx3QkFBd0IsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEdBQUcsRUFBRTtJQUMvQyxXQUFXLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxFQUFFLEVBQUUsRUFBRSxVQUFVO0lBQzdDLGlCQUFpQixFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsR0FBRyxFQUFFO0lBQ3hDLE9BQU8sRUFBRSxFQUFF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SUFBSSxDQUFDO0FBQ25DLENBQUM7QUFFRCxLQUFLLFVBQVUsWUFBWSxDQUFDLFNBQWlCLEVBQUUsTUFBK0I7SUFDNUUsTUFBTSxPQUFPLEdBQUcsSUFBSSxxQ0FBZ0IsQ0FBQztRQUNuQyxPQUFPLEVBQUU7WUFDUDtnQkFDRSxNQUFNLEVBQUUsbUJBQW1CO2dCQUMzQixVQUFVLEVBQUUsU0FBUztnQkFDckIsTUFBTSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsTUFBTSxDQUFDO2dCQUM5QixZQUFZLEVBQUUsY0FBYzthQUM3QjtTQUNGO0tBQ0YsQ0FBQyxDQUFDO0lBRUgsTUFBTSxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsT0FBTyxDQUFDLENBQUM7SUFDdEMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsU0FBUyxFQUFFLENBQUMsQ0FBQztBQUMvQyxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gRGV2aWNlIERhdGEgUHJvY2Vzc2luZyBMYW1iZGEgRnVuY3Rpb25cbi8vIFJlcXVpcmVtZW50czogMS4yLCA3LjMsIDcuNFxuXG5pbXBvcnQgeyBJb1RFdmVudCB9IGZyb20gJ2F3cy1sYW1iZGEnO1xuaW1wb3J0IHsgVGltZXN0cmVhbVdyaXRlQ2xpZW50LCBXcml0ZVJlY29yZHNDb21tYW5kLCBNZWFzdXJlVmFsdWVUeXBlLCBUaW1lVW5pdCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC10aW1lc3RyZWFtLXdyaXRlJztcbmltcG9ydCB7IEV2ZW50QnJpZGdlQ2xpZW50LCBQdXRFdmVudHNDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWV2ZW50YnJpZGdlJztcbmltcG9ydCB7IERldmljZVJlYWRpbmcsIFNlbnNvclJlYWRpbmcsIFZpdGFsU2lnbnMgfSBmcm9tICcuLi9zaGFyZWQvdHlwZXMnO1xuaW1wb3J0IHsgZ2V0RGV2aWNlLCB1cGRhdGVEZXZpY2VTeW5jLCB1cGRhdGVEZXZpY2VCYXR0ZXJ5IH0gZnJvbSAnLi4vc2hhcmVkL2RhdGEtYWNjZXNzL2RldmljZXMnO1xuXG5jb25zdCB0aW1lc3RyZWFtQ2xpZW50ID0gbmV3IFRpbWVzdHJlYW1Xcml0ZUNsaWVudCh7fSk7XG5jb25zdCBldmVudEJyaWRnZUNsaWVudCA9IG5ldyBFdmVudEJyaWRnZUNsaWVudCh7fSk7XG5cbmNvbnN0IERFVklDRVNfVEFCTEUgPSBwcm9jZXNzLmVudi5ERVZJQ0VTX1RBQkxFITtcbmNvbnN0IFRJTUVTVFJFQU1fREFUQUJBU0UgPSBwcm9jZXNzLmVudi5USU1FU1RSRUFNX0RBVEFCQVNFITtcbmNvbnN0IFRJTUVTVFJFQU1fVEFCTEUgPSBwcm9jZXNzLmVudi5USU1FU1RSRUFNX1RBQkxFITtcbmNvbnN0IEVWRU5UX0JVU19OQU1FID0gcHJvY2Vzcy5lbnYuRVZFTlRfQlVTX05BTUUhO1xuXG5pbnRlcmZhY2UgRGV2aWNlRGF0YVBheWxvYWQge1xuICBkZXZpY2VJZDogc3RyaW5nO1xuICB0aW1lc3RhbXA6IHN0cmluZztcbiAgcmVhZGluZ3M6IFNlbnNvclJlYWRpbmdbXTtcbiAgYmF0dGVyeUxldmVsPzogbnVtYmVyO1xuICBzaWduYWxTdHJlbmd0aD86IG51bWJlcjtcbiAgbG9jYXRpb24/OiB7XG4gICAgbGF0aXR1ZGU6IG51bWJlcjtcbiAgICBsb25naXR1ZGU6IG51bWJlcjtcbiAgICBhY2N1cmFjeT86IG51bWJlcjtcbiAgfTtcbn1cblxuLy8gVmFsaWRhdGlvbiByYW5nZXMgZm9yIGhlYWx0aCBtZXRyaWNzXG5jb25zdCBWQUxJREFUSU9OX1JBTkdFUyA9IHtcbiAgaGVhcnRfcmF0ZTogeyBtaW46IDMwLCBtYXg6IDIyMCB9LFxuICBibG9vZF9wcmVzc3VyZV9zeXN0b2xpYzogeyBtaW46IDYwLCBtYXg6IDI1MCB9LFxuICBibG9vZF9wcmVzc3VyZV9kaWFzdG9saWM6IHsgbWluOiAzMCwgbWF4OiAxNTAgfSxcbiAgdGVtcGVyYXR1cmU6IHsgbWluOiAzMiwgbWF4OiA0MyB9LCAvLyBDZWxzaXVzXG4gIG94eWdlbl9zYXR1cmF0aW9uOiB7IG1pbjogNzAsIG1heDogMTAwIH0sXG4gIGdsdWNvc2U6IHsgbWluOiAyMCwgbWF4OiA2MDAgfSwgLy8gbWcvZExcbiAgd2VpZ2h0OiB7IG1pbjogMjAsIG1heDogMzAwIH0sIC8vIGtnXG59O1xuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaGFuZGxlcihldmVudDogSW9URXZlbnQpOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc29sZS5sb2coJ1Byb2Nlc3NpbmcgZGV2aWNlIGRhdGE6JywgSlNPTi5zdHJpbmdpZnkoZXZlbnQsIG51bGwsIDIpKTtcblxuICB0cnkge1xuICAgIGNvbnN0IHBheWxvYWQ6IERldmljZURhdGFQYXlsb2FkID0gZXZlbnQgYXMgdW5rbm93biBhcyBEZXZpY2VEYXRhUGF5bG9hZDtcblxuICAgIC8vIFZhbGlkYXRlIHBheWxvYWRcbiAgICBpZiAoIXBheWxvYWQuZGV2aWNlSWQgfHwgIXBheWxvYWQucmVhZGluZ3MgfHwgcGF5bG9hZC5yZWFkaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ0ludmFsaWQgZGV2aWNlIGRhdGEgcGF5bG9hZDonLCBwYXlsb2FkKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICAvLyBHZXQgZGV2aWNlIGluZm9ybWF0aW9uXG4gICAgY29uc3QgZGV2aWNlID0gYXdhaXQgZ2V0RGV2aWNlKHBheWxvYWQuZGV2aWNlSWQpO1xuICAgIGlmICghZGV2aWNlKSB7XG4gICAgICBjb25zb2xlLmVycm9yKGBEZXZpY2Ugbm90IGZvdW5kOiAke3BheWxvYWQuZGV2aWNlSWR9YCk7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgZGV2aWNlIHJlYWRpbmdzXG4gICAgY29uc3QgdmFsaWRhdGVkUmVhZGluZ3MgPSB2YWxpZGF0ZVJlYWRpbmdzKHBheWxvYWQucmVhZGluZ3MpO1xuICAgIGlmICh2YWxpZGF0ZWRSZWFkaW5ncy5sZW5ndGggPT09IDApIHtcbiAgICAgIGNvbnNvbGUud2FybignTm8gdmFsaWQgcmVhZGluZ3MgYWZ0ZXIgdmFsaWRhdGlvbicpO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIC8vIFN0b3JlIHJlYWRpbmdzIGluIFRpbWVzdHJlYW1cbiAgICBhd2FpdCBzdG9yZURldmljZVJlYWRpbmdzKGRldmljZS51c2VySWQsIHBheWxvYWQuZGV2aWNlSWQsIHZhbGlkYXRlZFJlYWRpbmdzLCBwYXlsb2FkLnRpbWVzdGFtcCk7XG5cbiAgICAvLyBVcGRhdGUgZGV2aWNlIHN5bmMgdGltZVxuICAgIGF3YWl0IHVwZGF0ZURldmljZVN5bmMocGF5bG9hZC5kZXZpY2VJZCk7XG5cbiAgICAvLyBVcGRhdGUgYmF0dGVyeSBsZXZlbCBpZiBwcm92aWRlZFxuICAgIGlmIChwYXlsb2FkLmJhdHRlcnlMZXZlbCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICBhd2FpdCB1cGRhdGVEZXZpY2VCYXR0ZXJ5KHBheWxvYWQuZGV2aWNlSWQsIHBheWxvYWQuYmF0dGVyeUxldmVsKTtcblxuICAgICAgLy8gQWxlcnQgaWYgYmF0dGVyeSBpcyBsb3dcbiAgICAgIGlmIChwYXlsb2FkLmJhdHRlcnlMZXZlbCA8IDIwKSB7XG4gICAgICAgIGF3YWl0IHB1Ymxpc2hFdmVudCgnZGV2aWNlLmJhdHRlcnkubG93Jywge1xuICAgICAgICAgIGRldmljZUlkOiBwYXlsb2FkLmRldmljZUlkLFxuICAgICAgICAgIHVzZXJJZDogZGV2aWNlLnVzZXJJZCxcbiAgICAgICAgICBiYXR0ZXJ5TGV2ZWw6IHBheWxvYWQuYmF0dGVyeUxldmVsLFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBDb252ZXJ0IGRldmljZSByZWFkaW5ncyB0byB2aXRhbCBzaWducyBmb3JtYXRcbiAgICBjb25zdCB2aXRhbFNpZ25zID0gY29udmVydFRvVml0YWxTaWducyh2YWxpZGF0ZWRSZWFkaW5ncywgcGF5bG9hZC50aW1lc3RhbXApO1xuXG4gICAgLy8gUHVibGlzaCBldmVudCBmb3IgYW5vbWFseSBkZXRlY3Rpb25cbiAgICBpZiAodml0YWxTaWducykge1xuICAgICAgYXdhaXQgcHVibGlzaEV2ZW50KCdkZXZpY2UuZGF0YS5yZWNlaXZlZCcsIHtcbiAgICAgICAgZGV2aWNlSWQ6IHBheWxvYWQuZGV2aWNlSWQsXG4gICAgICAgIHVzZXJJZDogZGV2aWNlLnVzZXJJZCxcbiAgICAgICAgdml0YWxTaWducyxcbiAgICAgICAgc291cmNlOiAnZGV2aWNlJyxcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBTdWNjZXNzZnVsbHkgcHJvY2Vzc2VkIGRhdGEgZnJvbSBkZXZpY2U6ICR7cGF5bG9hZC5kZXZpY2VJZH1gKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwcm9jZXNzaW5nIGRldmljZSBkYXRhOicsIGVycm9yKTtcbiAgICB0aHJvdyBlcnJvcjtcbiAgfVxufVxuXG5mdW5jdGlvbiB2YWxpZGF0ZVJlYWRpbmdzKHJlYWRpbmdzOiBTZW5zb3JSZWFkaW5nW10pOiBTZW5zb3JSZWFkaW5nW10ge1xuICByZXR1cm4gcmVhZGluZ3MuZmlsdGVyKChyZWFkaW5nKSA9PiB7XG4gICAgLy8gQ2hlY2sgaWYgcmVhZGluZyB0eXBlIGlzIHN1cHBvcnRlZFxuICAgIGlmICghcmVhZGluZy50eXBlIHx8ICFyZWFkaW5nLnZhbHVlKSB7XG4gICAgICBjb25zb2xlLndhcm4oJ0ludmFsaWQgcmVhZGluZyBmb3JtYXQ6JywgcmVhZGluZyk7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgLy8gVmFsaWRhdGUgYmFzZWQgb24gc2Vuc29yIHR5cGVcbiAgICBsZXQgcmFuZ2U6IHsgbWluOiBudW1iZXI7IG1heDogbnVtYmVyIH0gfCB1bmRlZmluZWQ7XG5cbiAgICBzd2l0Y2ggKHJlYWRpbmcudHlwZSkge1xuICAgICAgY2FzZSAnaGVhcnRfcmF0ZSc6XG4gICAgICAgIHJhbmdlID0gVkFMSURBVElPTl9SQU5HRVMuaGVhcnRfcmF0ZTtcbiAgICAgICAgYnJlYWs7XG4gICAgICBjYXNlICdibG9vZF9wcmVzc3VyZSc6XG4gICAgICAgIC8vIEJsb29kIHByZXNzdXJlIHJlYWRpbmdzIHNob3VsZCBoYXZlIHN5c3RvbGljL2RpYXN0b2xpYyBpbiB0aGUgdmFsdWVcbiAgICAgICAgcmV0dXJuIHRydWU7IC8vIFZhbGlkYXRlZCBzZXBhcmF0ZWx5XG4gICAgICBjYXNlICd0ZW1wZXJhdHVyZSc6XG4gICAgICAgIHJhbmdlID0gVkFMSURBVElPTl9SQU5HRVMudGVtcGVyYXR1cmU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnb3h5Z2VuX3NhdHVyYXRpb24nOlxuICAgICAgICByYW5nZSA9IFZBTElEQVRJT05fUkFOR0VTLm94eWdlbl9zYXR1cmF0aW9uO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ2dsdWNvc2UnOlxuICAgICAgICByYW5nZSA9IFZBTElEQVRJT05fUkFOR0VTLmdsdWNvc2U7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAnd2VpZ2h0JzpcbiAgICAgICAgcmFuZ2UgPSBWQUxJREFUSU9OX1JBTkdFUy53ZWlnaHQ7XG4gICAgICAgIGJyZWFrO1xuICAgICAgZGVmYXVsdDpcbiAgICAgICAgLy8gQWxsb3cgb3RoZXIgc2Vuc29yIHR5cGVzIChhY2NlbGVyb21ldGVyLCBneXJvc2NvcGUsIGV0Yy4pXG4gICAgICAgIHJldHVybiB0cnVlO1xuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIHJhbmdlIGlmIGFwcGxpY2FibGVcbiAgICBpZiAocmFuZ2UpIHtcbiAgICAgIGlmIChyZWFkaW5nLnZhbHVlIDwgcmFuZ2UubWluIHx8IHJlYWRpbmcudmFsdWUgPiByYW5nZS5tYXgpIHtcbiAgICAgICAgY29uc29sZS53YXJuKGBSZWFkaW5nIG91dCBvZiByYW5nZTogJHtyZWFkaW5nLnR5cGV9ID0gJHtyZWFkaW5nLnZhbHVlfSAoZXhwZWN0ZWQgJHtyYW5nZS5taW59LSR7cmFuZ2UubWF4fSlgKTtcbiAgICAgICAgcmV0dXJuIGZhbHNlO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB0cnVlO1xuICB9KTtcbn1cblxuYXN5bmMgZnVuY3Rpb24gc3RvcmVEZXZpY2VSZWFkaW5ncyhcbiAgdXNlcklkOiBzdHJpbmcsXG4gIGRldmljZUlkOiBzdHJpbmcsXG4gIHJlYWRpbmdzOiBTZW5zb3JSZWFkaW5nW10sXG4gIHRpbWVzdGFtcDogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgcmVjb3JkcyA9IHJlYWRpbmdzLm1hcCgocmVhZGluZykgPT4gKHtcbiAgICBEaW1lbnNpb25zOiBbXG4gICAgICB7IE5hbWU6ICd1c2VySWQnLCBWYWx1ZTogdXNlcklkIH0sXG4gICAgICB7IE5hbWU6ICdkZXZpY2VJZCcsIFZhbHVlOiBkZXZpY2VJZCB9LFxuICAgICAgeyBOYW1lOiAnc2Vuc29yVHlwZScsIFZhbHVlOiByZWFkaW5nLnR5cGUgfSxcbiAgICBdLFxuICAgIE1lYXN1cmVOYW1lOiAnc2Vuc29yX3JlYWRpbmcnLFxuICAgIE1lYXN1cmVWYWx1ZTogcmVhZGluZy52YWx1ZS50b1N0cmluZygpLFxuICAgIE1lYXN1cmVWYWx1ZVR5cGU6IE1lYXN1cmVWYWx1ZVR5cGUuRE9VQkxFLFxuICAgIFRpbWU6IG5ldyBEYXRlKHRpbWVzdGFtcCkuZ2V0VGltZSgpLnRvU3RyaW5nKCksXG4gICAgVGltZVVuaXQ6IFRpbWVVbml0Lk1JTExJU0VDT05EUyxcbiAgfSkpO1xuXG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgV3JpdGVSZWNvcmRzQ29tbWFuZCh7XG4gICAgRGF0YWJhc2VOYW1lOiBUSU1FU1RSRUFNX0RBVEFCQVNFLFxuICAgIFRhYmxlTmFtZTogVElNRVNUUkVBTV9UQUJMRSxcbiAgICBSZWNvcmRzOiByZWNvcmRzLFxuICB9KTtcblxuICBhd2FpdCB0aW1lc3RyZWFtQ2xpZW50LnNlbmQoY29tbWFuZCk7XG4gIGNvbnNvbGUubG9nKGBTdG9yZWQgJHtyZWNvcmRzLmxlbmd0aH0gcmVhZGluZ3MgaW4gVGltZXN0cmVhbWApO1xufVxuXG5mdW5jdGlvbiBjb252ZXJ0VG9WaXRhbFNpZ25zKHJlYWRpbmdzOiBTZW5zb3JSZWFkaW5nW10sIHRpbWVzdGFtcDogc3RyaW5nKTogVml0YWxTaWducyB8IG51bGwge1xuICBjb25zdCB2aXRhbHM6IFZpdGFsU2lnbnMgPSB7XG4gICAgdGltZXN0YW1wOiBuZXcgRGF0ZSh0aW1lc3RhbXApLFxuICAgIHNvdXJjZTogJ2RldmljZScsXG4gIH07XG5cbiAgbGV0IGhhc1ZpdGFscyA9IGZhbHNlO1xuXG4gIGZvciAoY29uc3QgcmVhZGluZyBvZiByZWFkaW5ncykge1xuICAgIHN3aXRjaCAocmVhZGluZy50eXBlKSB7XG4gICAgICBjYXNlICdoZWFydF9yYXRlJzpcbiAgICAgICAgdml0YWxzLmhlYXJ0UmF0ZSA9IHJlYWRpbmcudmFsdWU7XG4gICAgICAgIGhhc1ZpdGFscyA9IHRydWU7XG4gICAgICAgIGJyZWFrO1xuICAgICAgY2FzZSAndGVtcGVyYXR1cmUnOlxuICAgICAgICB2aXRhbHMudGVtcGVyYXR1cmUgPSByZWFkaW5nLnZhbHVlO1xuICAgICAgICBoYXNWaXRhbHMgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ294eWdlbl9zYXR1cmF0aW9uJzpcbiAgICAgICAgdml0YWxzLm94eWdlblNhdHVyYXRpb24gPSByZWFkaW5nLnZhbHVlO1xuICAgICAgICBoYXNWaXRhbHMgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICAgIGNhc2UgJ3dlaWdodCc6XG4gICAgICAgIHZpdGFscy53ZWlnaHQgPSByZWFkaW5nLnZhbHVlO1xuICAgICAgICBoYXNWaXRhbHMgPSB0cnVlO1xuICAgICAgICBicmVhaztcbiAgICB9XG4gIH1cblxuICByZXR1cm4gaGFzVml0YWxzID8gdml0YWxzIDogbnVsbDtcbn1cblxuYXN5bmMgZnVuY3Rpb24gcHVibGlzaEV2ZW50KGV2ZW50VHlwZTogc3RyaW5nLCBkZXRhaWw6IFJlY29yZDxzdHJpbmcsIHVua25vd24+KTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGNvbW1hbmQgPSBuZXcgUHV0RXZlbnRzQ29tbWFuZCh7XG4gICAgRW50cmllczogW1xuICAgICAge1xuICAgICAgICBTb3VyY2U6ICdoZWFsdGhjYXJlLmRldmljZScsXG4gICAgICAgIERldGFpbFR5cGU6IGV2ZW50VHlwZSxcbiAgICAgICAgRGV0YWlsOiBKU09OLnN0cmluZ2lmeShkZXRhaWwpLFxuICAgICAgICBFdmVudEJ1c05hbWU6IEVWRU5UX0JVU19OQU1FLFxuICAgICAgfSxcbiAgICBdLFxuICB9KTtcblxuICBhd2FpdCBldmVudEJyaWRnZUNsaWVudC5zZW5kKGNvbW1hbmQpO1xuICBjb25zb2xlLmxvZyhgUHVibGlzaGVkIGV2ZW50OiAke2V2ZW50VHlwZX1gKTtcbn1cbiJdfQ==