"use strict";
// Device Registration Lambda Function
// Requirements: 7.2
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_iot_1 = require("@aws-sdk/client-iot");
const types_1 = require("../shared/types");
const devices_1 = require("../shared/data-access/devices");
const iotClient = new client_iot_1.IoTClient({});
const DEVICES_TABLE = process.env.DEVICES_TABLE;
const IOT_POLICY_NAME = process.env.IOT_POLICY_NAME;
const ENVIRONMENT = process.env.ENVIRONMENT;
async function handler(event) {
    console.log('Device registration request:', JSON.stringify(event, null, 2));
    try {
        // Parse request body
        if (!event.body) {
            return (0, types_1.createErrorResponse)(400, 'Request body is required');
        }
        const request = JSON.parse(event.body);
        // Validate required fields
        if (!request.userId || !request.type || !request.manufacturer || !request.model) {
            return (0, types_1.createErrorResponse)(400, 'Missing required fields: userId, type, manufacturer, model');
        }
        if (!request.capabilities || request.capabilities.length === 0) {
            return (0, types_1.createErrorResponse)(400, 'Device must have at least one capability');
        }
        if (!request.connectionType) {
            return (0, types_1.createErrorResponse)(400, 'Connection type is required');
        }
        // Generate unique device ID
        const deviceId = `${request.type}-${request.userId}-${Date.now()}`;
        const thingName = `healthcare-device-${deviceId}`;
        // Create IoT Thing
        const createThingCommand = new client_iot_1.CreateThingCommand({
            thingName,
            thingTypeName: `healthcare-${request.type}-${ENVIRONMENT}`,
            attributePayload: {
                attributes: {
                    userId: request.userId,
                    manufacturer: request.manufacturer,
                    model: request.model,
                    deviceType: request.type,
                    connectionType: request.connectionType,
                },
            },
        });
        await iotClient.send(createThingCommand);
        console.log(`Created IoT Thing: ${thingName}`);
        // Create device certificate and keys
        const createKeysCommand = new client_iot_1.CreateKeysAndCertificateCommand({
            setAsActive: true,
        });
        const keysResponse = await iotClient.send(createKeysCommand);
        console.log(`Created certificate for device: ${deviceId}`);
        if (!keysResponse.certificateArn || !keysResponse.certificatePem || !keysResponse.keyPair?.PrivateKey || !keysResponse.keyPair?.PublicKey) {
            throw new Error('Failed to create device certificate and keys');
        }
        // Attach certificate to thing
        const attachThingCommand = new client_iot_1.AttachThingPrincipalCommand({
            thingName,
            principal: keysResponse.certificateArn,
        });
        await iotClient.send(attachThingCommand);
        console.log(`Attached certificate to thing: ${thingName}`);
        // Attach policy to certificate
        const attachPolicyCommand = new client_iot_1.AttachPolicyCommand({
            policyName: IOT_POLICY_NAME,
            target: keysResponse.certificateArn,
        });
        await iotClient.send(attachPolicyCommand);
        console.log(`Attached policy to certificate: ${IOT_POLICY_NAME}`);
        // Save device to DynamoDB
        const device = {
            id: deviceId,
            userId: request.userId,
            type: request.type,
            manufacturer: request.manufacturer,
            model: request.model,
            capabilities: request.capabilities,
            connectionType: request.connectionType,
            status: 'disconnected',
            firmwareVersion: request.firmwareVersion,
        };
        await (0, devices_1.registerDevice)(device);
        console.log(`Saved device to database: ${deviceId}`);
        // Prepare response
        const response = {
            deviceId,
            certificateArn: keysResponse.certificateArn,
            certificatePem: keysResponse.certificatePem,
            privateKey: keysResponse.keyPair.PrivateKey,
            publicKey: keysResponse.keyPair.PublicKey,
            iotEndpoint: `${process.env.AWS_IOT_ENDPOINT || 'data.iot.' + process.env.AWS_REGION + '.amazonaws.com'}`,
        };
        return (0, types_1.createSuccessResponse)(response);
    }
    catch (error) {
        console.error('Error registering device:', error);
        return (0, types_1.createErrorResponse)(500, `Failed to register device: ${error instanceof Error ? error.message : 'Unknown error'}`);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVnaXN0ZXItZGV2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVnaXN0ZXItZGV2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxzQ0FBc0M7QUFDdEMsb0JBQW9COztBQWdDcEIsMEJBMkdDO0FBeElELG9EQUF1SjtBQUN2SiwyQ0FBeUk7QUFDekksMkRBQTZFO0FBRTdFLE1BQU0sU0FBUyxHQUFHLElBQUksc0JBQVMsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUVwQyxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQUNqRCxNQUFNLGVBQWUsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGVBQWdCLENBQUM7QUFDckQsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxXQUFZLENBQUM7QUFxQnRDLEtBQUssVUFBVSxPQUFPLENBQUMsS0FBMkI7SUFDdkQsT0FBTyxDQUFDLEdBQUcsQ0FBQyw4QkFBOEIsRUFBRSxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssRUFBRSxJQUFJLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUU1RSxJQUFJLENBQUM7UUFDSCxxQkFBcUI7UUFDckIsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNoQixPQUFPLElBQUEsMkJBQW1CLEVBQUMsR0FBRyxFQUFFLDBCQUEwQixDQUFDLENBQUM7UUFDOUQsQ0FBQztRQUVELE1BQU0sT0FBTyxHQUEwQixJQUFJLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsQ0FBQztRQUU5RCwyQkFBMkI7UUFDM0IsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLElBQUksQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLENBQUMsT0FBTyxDQUFDLFlBQVksSUFBSSxDQUFDLE9BQU8sQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNoRixPQUFPLElBQUEsMkJBQW1CLEVBQUMsR0FBRyxFQUFFLDRE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Z2lzdHJhdGlvbiBMYW1iZGEgRnVuY3Rpb25cbi8vIFJlcXVpcmVtZW50czogNy4yXG5cbmltcG9ydCB7IEFQSUdhdGV3YXlQcm94eUV2ZW50LCBBUElHYXRld2F5UHJveHlSZXN1bHQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IElvVENsaWVudCwgQ3JlYXRlVGhpbmdDb21tYW5kLCBDcmVhdGVLZXlzQW5kQ2VydGlmaWNhdGVDb21tYW5kLCBBdHRhY2hUaGluZ1ByaW5jaXBhbENvbW1hbmQsIEF0dGFjaFBvbGljeUNvbW1hbmQgfSBmcm9tICdAYXdzLXNkay9jbGllbnQtaW90JztcbmltcG9ydCB7IGNyZWF0ZVN1Y2Nlc3NSZXNwb25zZSwgY3JlYXRlRXJyb3JSZXNwb25zZSwgSGVhbHRoRGV2aWNlLCBEZXZpY2VUeXBlLCBEZXZpY2VDYXBhYmlsaXR5LCBDb25uZWN0aW9uVHlwZSB9IGZyb20gJy4uL3NoYXJlZC90eXBlcyc7XG5pbXBvcnQgeyByZWdpc3RlckRldmljZSBhcyBzYXZlRGV2aWNlIH0gZnJvbSAnLi4vc2hhcmVkL2RhdGEtYWNjZXNzL2RldmljZXMnO1xuXG5jb25zdCBpb3RDbGllbnQgPSBuZXcgSW9UQ2xpZW50KHt9KTtcblxuY29uc3QgREVWSUNFU19UQUJMRSA9IHByb2Nlc3MuZW52LkRFVklDRVNfVEFCTEUhO1xuY29uc3QgSU9UX1BPTElDWV9OQU1FID0gcHJvY2Vzcy5lbnYuSU9UX1BPTElDWV9OQU1FITtcbmNvbnN0IEVOVklST05NRU5UID0gcHJvY2Vzcy5lbnYuRU5WSVJPTk1FTlQhO1xuXG5pbnRlcmZhY2UgUmVnaXN0ZXJEZXZpY2VSZXF1ZXN0IHtcbiAgdXNlcklkOiBzdHJpbmc7XG4gIHR5cGU6IERldmljZVR5cGU7XG4gIG1hbnVmYWN0dXJlcjogc3RyaW5nO1xuICBtb2RlbDogc3RyaW5nO1xuICBjYXBhYmlsaXRpZXM6IERldmljZUNhcGFiaWxpdHlbXTtcbiAgY29ubmVjdGlvblR5cGU6IENvbm5lY3Rpb25UeXBlO1xuICBmaXJtd2FyZVZlcnNpb24/OiBzdHJpbmc7XG59XG5cbmludGVyZmFjZSBSZWdpc3RlckRldmljZVJlc3BvbnNlIHtcbiAgZGV2aWNlSWQ6IHN0cmluZztcbiAgY2VydGlmaWNhdGVBcm46IHN0cmluZztcbiAgY2VydGlmaWNhdGVQZW06IHN0cmluZztcbiAgcHJpdmF0ZUtleTogc3RyaW5nO1xuICBwdWJsaWNLZXk6IHN0cmluZztcbiAgaW90RW5kcG9pbnQ6IHN0cmluZztcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoZXZlbnQ6IEFQSUdhdGV3YXlQcm94eUV2ZW50KTogUHJvbWlzZTxBUElHYXRld2F5UHJveHlSZXN1bHQ+IHtcbiAgY29uc29sZS5sb2coJ0RldmljZSByZWdpc3RyYXRpb24gcmVxdWVzdDonLCBKU09OLnN0cmluZ2lmeShldmVudCwgbnVsbCwgMikpO1xuXG4gIHRyeSB7XG4gICAgLy8gUGFyc2UgcmVxdWVzdCBib2R5XG4gICAgaWYgKCFldmVudC5ib2R5KSB7XG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsICdSZXF1ZXN0IGJvZHkgaXMgcmVxdWlyZWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCByZXF1ZXN0OiBSZWdpc3RlckRldmljZVJlcXVlc3QgPSBKU09OLnBhcnNlKGV2ZW50LmJvZHkpO1xuXG4gICAgLy8gVmFsaWRhdGUgcmVxdWlyZWQgZmllbGRzXG4gICAgaWYgKCFyZXF1ZXN0LnVzZXJJZCB8fCAhcmVxdWVzdC50eXBlIHx8ICFyZXF1ZXN0Lm1hbnVmYWN0dXJlciB8fCAhcmVxdWVzdC5tb2RlbCkge1xuICAgICAgcmV0dXJuIGNyZWF0ZUVycm9yUmVzcG9uc2UoNDAwLCAnTWlzc2luZyByZXF1aXJlZCBmaWVsZHM6IHVzZXJJZCwgdHlwZSwgbWFudWZhY3R1cmVyLCBtb2RlbCcpO1xuICAgIH1cblxuICAgIGlmICghcmVxdWVzdC5jYXBhYmlsaXRpZXMgfHwgcmVxdWVzdC5jYXBhYmlsaXRpZXMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsICdEZXZpY2UgbXVzdCBoYXZlIGF0IGxlYXN0IG9uZSBjYXBhYmlsaXR5Jyk7XG4gICAgfVxuXG4gICAgaWYgKCFyZXF1ZXN0LmNvbm5lY3Rpb25UeXBlKSB7XG4gICAgICByZXR1cm4gY3JlYXRlRXJyb3JSZXNwb25zZSg0MDAsICdDb25uZWN0aW9uIHR5cGUgaXMgcmVxdWlyZWQnKTtcbiAgICB9XG5cbiAgICAvLyBHZW5lcmF0ZSB1bmlxdWUgZGV2aWNlIElEXG4gICAgY29uc3QgZGV2aWNlSWQgPSBgJHtyZXF1ZXN0LnR5cGV9LSR7cmVxdWVzdC51c2VySWR9LSR7RGF0ZS5ub3coKX1gO1xuICAgIGNvbnN0IHRoaW5nTmFtZSA9IGBoZWFsdGhjYXJlLWRldmljZS0ke2RldmljZUlkfWA7XG5cbiAgICAvLyBDcmVhdGUgSW9UIFRoaW5nXG4gICAgY29uc3QgY3JlYXRlVGhpbmdDb21tYW5kID0gbmV3IENyZWF0ZVRoaW5nQ29tbWFuZCh7XG4gICAgICB0aGluZ05hbWUsXG4gICAgICB0aGluZ1R5cGVOYW1lOiBgaGVhbHRoY2FyZS0ke3JlcXVlc3QudHlwZX0tJHtFTlZJUk9OTUVOVH1gLFxuICAgICAgYXR0cmlidXRlUGF5bG9hZDoge1xuICAgICAgICBhdHRyaWJ1dGVzOiB7XG4gICAgICAgICAgdXNlcklkOiByZXF1ZXN0LnVzZXJJZCxcbiAgICAgICAgICBtYW51ZmFjdHVyZXI6IHJlcXVlc3QubWFudWZhY3R1cmVyLFxuICAgICAgICAgIG1vZGVsOiByZXF1ZXN0Lm1vZGVsLFxuICAgICAgICAgIGRldmljZVR5cGU6IHJlcXVlc3QudHlwZSxcbiAgICAgICAgICBjb25uZWN0aW9uVHlwZTogcmVxdWVzdC5jb25uZWN0aW9uVHlwZSxcbiAgICAgICAgfSxcbiAgICAgIH0sXG4gICAgfSk7XG5cbiAgICBhd2FpdCBpb3RDbGllbnQuc2VuZChjcmVhdGVUaGluZ0NvbW1hbmQpO1xuICAgIGNvbnNvbGUubG9nKGBDcmVhdGVkIElvVCBUaGluZzogJHt0aGluZ05hbWV9YCk7XG5cbiAgICAvLyBDcmVhdGUgZGV2aWNlIGNlcnRpZmljYXRlIGFuZCBrZXlzXG4gICAgY29uc3QgY3JlYXRlS2V5c0NvbW1hbmQgPSBuZXcgQ3JlYXRlS2V5c0FuZENlcnRpZmljYXRlQ29tbWFuZCh7XG4gICAgICBzZXRBc0FjdGl2ZTogdHJ1ZSxcbiAgICB9KTtcblxuICAgIGNvbnN0IGtleXNSZXNwb25zZSA9IGF3YWl0IGlvdENsaWVudC5zZW5kKGNyZWF0ZUtleXNDb21tYW5kKTtcbiAgICBjb25zb2xlLmxvZyhgQ3JlYXRlZCBjZXJ0aWZpY2F0ZSBmb3IgZGV2aWNlOiAke2RldmljZUlkfWApO1xuXG4gICAgaWYgKCFrZXlzUmVzcG9uc2UuY2VydGlmaWNhdGVBcm4gfHwgIWtleXNSZXNwb25zZS5jZXJ0aWZpY2F0ZVBlbSB8fCAha2V5c1Jlc3BvbnNlLmtleVBhaXI/LlByaXZhdGVLZXkgfHwgIWtleXNSZXNwb25zZS5rZXlQYWlyPy5QdWJsaWNLZXkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRmFpbGVkIHRvIGNyZWF0ZSBkZXZpY2UgY2VydGlmaWNhdGUgYW5kIGtleXMnKTtcbiAgICB9XG5cbiAgICAvLyBBdHRhY2ggY2VydGlmaWNhdGUgdG8gdGhpbmdcbiAgICBjb25zdCBhdHRhY2hUaGluZ0NvbW1hbmQgPSBuZXcgQXR0YWNoVGhpbmdQcmluY2lwYWxDb21tYW5kKHtcbiAgICAgIHRoaW5nTmFtZSxcbiAgICAgIHByaW5jaXBhbDoga2V5c1Jlc3BvbnNlLmNlcnRpZmljYXRlQXJuLFxuICAgIH0pO1xuXG4gICAgYXdhaXQgaW90Q2xpZW50LnNlbmQoYXR0YWNoVGhpbmdDb21tYW5kKTtcbiAgICBjb25zb2xlLmxvZyhgQXR0YWNoZWQgY2VydGlmaWNhdGUgdG8gdGhpbmc6ICR7dGhpbmdOYW1lfWApO1xuXG4gICAgLy8gQXR0YWNoIHBvbGljeSB0byBjZXJ0aWZpY2F0ZVxuICAgIGNvbnN0IGF0dGFjaFBvbGljeUNvbW1hbmQgPSBuZXcgQXR0YWNoUG9saWN5Q29tbWFuZCh7XG4gICAgICBwb2xpY3lOYW1lOiBJT1RfUE9MSUNZX05BTUUsXG4gICAgICB0YXJnZXQ6IGtleXNSZXNwb25zZS5jZXJ0aWZpY2F0ZUFybixcbiAgICB9KTtcblxuICAgIGF3YWl0IGlvdENsaWVudC5zZW5kKGF0dGFjaFBvbGljeUNvbW1hbmQpO1xuICAgIGNvbnNvbGUubG9nKGBBdHRhY2hlZCBwb2xpY3kgdG8gY2VydGlmaWNhdGU6ICR7SU9UX1BPTElDWV9OQU1FfWApO1xuXG4gICAgLy8gU2F2ZSBkZXZpY2UgdG8gRHluYW1vREJcbiAgICBjb25zdCBkZXZpY2U6IEhlYWx0aERldmljZSA9IHtcbiAgICAgIGlkOiBkZXZpY2VJZCxcbiAgICAgIHVzZXJJZDogcmVxdWVzdC51c2VySWQsXG4gICAgICB0eXBlOiByZXF1ZXN0LnR5cGUsXG4gICAgICBtYW51ZmFjdHVyZXI6IHJlcXVlc3QubWFudWZhY3R1cmVyLFxuICAgICAgbW9kZWw6IHJlcXVlc3QubW9kZWwsXG4gICAgICBjYXBhYmlsaXRpZXM6IHJlcXVlc3QuY2FwYWJpbGl0aWVzLFxuICAgICAgY29ubmVjdGlvblR5cGU6IHJlcXVlc3QuY29ubmVjdGlvblR5cGUsXG4gICAgICBzdGF0dXM6ICdkaXNjb25uZWN0ZWQnLFxuICAgICAgZmlybXdhcmVWZXJzaW9uOiByZXF1ZXN0LmZpcm13YXJlVmVyc2lvbixcbiAgICB9O1xuXG4gICAgYXdhaXQgc2F2ZURldmljZShkZXZpY2UpO1xuICAgIGNvbnNvbGUubG9nKGBTYXZlZCBkZXZpY2UgdG8gZGF0YWJhc2U6ICR7ZGV2aWNlSWR9YCk7XG5cbiAgICAvLyBQcmVwYXJlIHJlc3BvbnNlXG4gICAgY29uc3QgcmVzcG9uc2U6IFJlZ2lzdGVyRGV2aWNlUmVzcG9uc2UgPSB7XG4gICAgICBkZXZpY2VJZCxcbiAgICAgIGNlcnRpZmljYXRlQXJuOiBrZXlzUmVzcG9uc2UuY2VydGlmaWNhdGVBcm4sXG4gICAgICBjZXJ0aWZpY2F0ZVBlbToga2V5c1Jlc3BvbnNlLmNlcnRpZmljYXRlUGVtLFxuICAgICAgcHJpdmF0ZUtleToga2V5c1Jlc3BvbnNlLmtleVBhaXIuUHJpdmF0ZUtleSxcbiAgICAgIHB1YmxpY0tleToga2V5c1Jlc3BvbnNlLmtleVBhaXIuUHVibGljS2V5LFxuICAgICAgaW90RW5kcG9pbnQ6IGAke3Byb2Nlc3MuZW52LkFXU19JT1RfRU5EUE9JTlQgfHwgJ2RhdGEuaW90LicgKyBwcm9jZXNzLmVudi5BV1NfUkVHSU9OICsgJy5hbWF6b25hd3MuY29tJ31gLFxuICAgIH07XG5cbiAgICByZXR1cm4gY3JlYXRlU3VjY2Vzc1Jlc3BvbnNlKHJlc3BvbnNlKTtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciByZWdpc3RlcmluZyBkZXZpY2U6JywgZXJyb3IpO1xuICAgIHJldHVybiBjcmVhdGVFcnJvclJlc3BvbnNlKDUwMCwgYEZhaWxlZCB0byByZWdpc3RlciBkZXZpY2U6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCk7XG4gIH1cbn1cbiJdfQ==