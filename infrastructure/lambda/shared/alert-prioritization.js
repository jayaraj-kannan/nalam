"use strict";
// Alert Prioritization and Consolidation Service
// Requirements: 9.3, 9.5
Object.defineProperty(exports, "__esModule", { value: true });
exports.calculateAlertPriority = calculateAlertPriority;
exports.prioritizeAlerts = prioritizeAlerts;
exports.areAlertsRelated = areAlertsRelated;
exports.consolidateAlerts = consolidateAlerts;
exports.createConsolidatedMessage = createConsolidatedMessage;
exports.getAlertsNeedingEscalation = getAlertsNeedingEscalation;
exports.filterAlertsByPreferences = filterAlertsByPreferences;
/**
 * Priority score for each severity level
 */
const SEVERITY_PRIORITY = {
    critical: 4,
    high: 3,
    medium: 2,
    low: 1,
};
/**
 * Priority score for each alert type
 */
const TYPE_PRIORITY = {
    emergency: 7,
    fall_detection: 6,
    vital_signs: 5,
    check_in: 4,
    medication: 3,
    device: 2,
    appointment: 1,
};
/**
 * Calculate priority score for an alert
 * Higher score = higher priority
 */
function calculateAlertPriority(alert) {
    const severityScore = SEVERITY_PRIORITY[alert.severity] * 10;
    const typeScore = TYPE_PRIORITY[alert.type];
    const escalationBonus = alert.escalated ? 20 : 0;
    const unacknowledgedBonus = !alert.acknowledged ? 10 : 0;
    // More recent alerts get slightly higher priority
    const ageInMinutes = (Date.now() - alert.timestamp.getTime()) / (1000 * 60);
    const recencyScore = Math.max(0, 5 - (ageInMinutes / 60)); // Decreases over hours
    return severityScore + typeScore + escalationBonus + unacknowledgedBonus + recencyScore;
}
/**
 * Sort alerts by priority (highest first)
 */
function prioritizeAlerts(alerts) {
    return [...alerts].sort((a, b) => {
        const priorityA = calculateAlertPriority(a);
        const priorityB = calculateAlertPriority(b);
        if (priorityA !== priorityB) {
            return priorityB - priorityA; // Higher priority first
        }
        // If same priority, newer alerts first
        return b.timestamp.getTime() - a.timestamp.getTime();
    });
}
/**
 * Check if two alerts are related and can be consolidated
 */
function areAlertsRelated(alert1, alert2) {
    // Same user and same type
    if (alert1.userId !== alert2.userId || alert1.type !== alert2.type) {
        return false;
    }
    // Within 15 minutes of each other
    const timeDiff = Math.abs(alert1.timestamp.getTime() - alert2.timestamp.getTime());
    const fifteenMinutes = 15 * 60 * 1000;
    if (timeDiff > fifteenMinutes) {
        return false;
    }
    // Check if related data indicates same issue
    if (alert1.relatedData && alert2.relatedData) {
        // For vital signs alerts, check if same metric
        if (alert1.type === 'vital_signs') {
            const metric1 = alert1.relatedData.metric;
            const metric2 = alert2.relatedData.metric;
            return metric1 === metric2;
        }
        // For medication alerts, check if same medication
        if (alert1.type === 'medication') {
            const med1 = alert1.relatedData.medicationId;
            const med2 = alert2.relatedData.medicationId;
            return med1 === med2;
        }
        // For device alerts, check if same device
        if (alert1.type === 'device') {
            const device1 = alert1.relatedData.deviceId;
            const device2 = alert2.relatedData.deviceId;
            return device1 === device2;
        }
    }
    return true;
}
/**
 * Consolidate related alerts into groups
 */
function consolidateAlerts(alerts) {
    const consolidated = [];
    const processed = new Set();
    for (const alert of alerts) {
        if (processed.has(alert.id)) {
            continue;
        }
        const group = [alert];
        processed.add(alert.id);
        // Find related alerts
        for (const otherAlert of alerts) {
            if (processed.has(otherAlert.id)) {
                continue;
            }
            if (areAlertsRelated(alert, otherAlert)) {
                group.push(otherAlert);
                processed.add(otherAlert.id);
            }
        }
        consolidated.push(group);
    }
    return consolidated;
}
/**
 * Create a consolidated alert message from a group of related alerts
 */
function createConsolidatedMessage(alerts) {
    if (alerts.length === 1) {
        return alerts[0].message;
    }
    const firstAlert = alerts[0];
    const count = alerts.length;
    // Get the highest severity in the group
    const highestSeverity = alerts.reduce((max, alert) => {
        const severityOrder = ['low', 'medium', 'high', 'critical'];
        return severityOrder.indexOf(alert.severity) > severityOrder.indexOf(max) ? alert.severity : max;
    }, 'low');
    const typeLabel = firstAlert.type.replace(/_/g, ' ');
    return `${count} ${typeLabel} alerts (${highestSeverity} severity): ${firstAlert.message}${count > 1 ? ` and ${count - 1} more` : ''}`;
}
/**
 * Get alerts that need escalation based on time and acknowledgment status
 */
function getAlertsNeedingEscalation(alerts, escalationTimeMinutes = 30) {
    const now = Date.now();
    const escalationThreshold = escalationTimeMinutes * 60 * 1000;
    return alerts.filter(alert => {
        // Already escalated
        if (alert.escalated) {
            return false;
        }
        // Already acknowledged
        if (alert.acknowledged) {
            return false;
        }
        // Only escalate medium severity and above
        if (alert.severity === 'low') {
            return false;
        }
        // Check if enough time has passed
        const timeSinceAlert = now - alert.timestamp.getTime();
        return timeSinceAlert >= escalationThreshold;
    });
}
/**
 * Filter alerts based on user preferences
 */
function filterAlertsByPreferences(alerts, preferences) {
    if (!preferences.alertTypes) {
        return alerts;
    }
    return alerts.filter(alert => {
        const typePrefs = preferences.alertTypes?.[alert.type];
        // If no preferences for this type, include it
        if (!typePrefs) {
            return true;
        }
        // Check if type is enabled
        if (!typePrefs.enabled) {
            return false;
        }
        // Check if severity level is included
        if (typePrefs.urgencyLevels && !typePrefs.urgencyLevels.includes(alert.severity)) {
            return false;
        }
        return true;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnQtcHJpb3JpdGl6YXRpb24uanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJhbGVydC1wcmlvcml0aXphdGlvbi50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsaURBQWlEO0FBQ2pELHlCQUF5Qjs7QUErQnpCLHdEQVdDO0FBS0QsNENBWUM7QUFLRCw0Q0F1Q0M7QUFLRCw4Q0E0QkM7QUFLRCw4REFpQkM7QUFLRCxnRUF3QkM7QUFLRCw4REFtQ0M7QUEvTkQ7O0dBRUc7QUFDSCxNQUFNLGlCQUFpQixHQUFrQztJQUN2RCxRQUFRLEVBQUUsQ0FBQztJQUNYLElBQUksRUFBRSxDQUFDO0lBQ1AsTUFBTSxFQUFFLENBQUM7SUFDVCxHQUFHLEVBQUUsQ0FBQztDQUNQLENBQUM7QUFFRjs7R0FFRztBQUNILE1BQU0sYUFBYSxHQUE4QjtJQUMvQyxTQUFTLEVBQUUsQ0FBQztJQUNaLGNBQWMsRUFBRSxDQUFDO0lBQ2pCLFdBQVcsRUFBRSxDQUFDO0lBQ2QsUUFBUSxFQUFFLENBQUM7SUFDWCxVQUFVLEVBQUUsQ0FBQztJQUNiLE1BQU0sRUFBRSxDQUFDO0lBQ1QsV0FBVyxFQUFFLENBQUM7Q0FDZixDQUFDO0FBRUY7OztHQUdHO0FBQ0gsU0FBZ0Isc0JBQXNCLENBQUMsS0FBa0I7SUFDdkQsTUFBTSxhQUFhLEdBQUcsaUJBQWlCLENBQUMsS0FBSyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsQ0FBQztJQUM3RCxNQUFNLFNBQVMsR0FBRyxhQUFhLENBQUMsS0FBSyxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQzVDLE1BQU0sZUFBZSxHQUFHLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsQ0FBQyxDQUFDO0lBQ2pELE1BQU0sbUJBQW1CLEdBQUcsQ0FBQyxLQUFLLENBQUMsWUFBWSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztJQUV6RCxrREFBa0Q7SUFDbEQsTUFB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QUM7UUFDZixDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBBbGVydCBQcmlvcml0aXphdGlvbiBhbmQgQ29uc29saWRhdGlvbiBTZXJ2aWNlXG4vLyBSZXF1aXJlbWVudHM6IDkuMywgOS41XG5cbmltcG9ydCB7IEhlYWx0aEFsZXJ0LCBBbGVydFNldmVyaXR5LCBBbGVydFR5cGUgfSBmcm9tICcuL3R5cGVzJztcblxuLyoqXG4gKiBQcmlvcml0eSBzY29yZSBmb3IgZWFjaCBzZXZlcml0eSBsZXZlbFxuICovXG5jb25zdCBTRVZFUklUWV9QUklPUklUWTogUmVjb3JkPEFsZXJ0U2V2ZXJpdHksIG51bWJlcj4gPSB7XG4gIGNyaXRpY2FsOiA0LFxuICBoaWdoOiAzLFxuICBtZWRpdW06IDIsXG4gIGxvdzogMSxcbn07XG5cbi8qKlxuICogUHJpb3JpdHkgc2NvcmUgZm9yIGVhY2ggYWxlcnQgdHlwZVxuICovXG5jb25zdCBUWVBFX1BSSU9SSVRZOiBSZWNvcmQ8QWxlcnRUeXBlLCBudW1iZXI+ID0ge1xuICBlbWVyZ2VuY3k6IDcsXG4gIGZhbGxfZGV0ZWN0aW9uOiA2LFxuICB2aXRhbF9zaWduczogNSxcbiAgY2hlY2tfaW46IDQsXG4gIG1lZGljYXRpb246IDMsXG4gIGRldmljZTogMixcbiAgYXBwb2ludG1lbnQ6IDEsXG59O1xuXG4vKipcbiAqIENhbGN1bGF0ZSBwcmlvcml0eSBzY29yZSBmb3IgYW4gYWxlcnRcbiAqIEhpZ2hlciBzY29yZSA9IGhpZ2hlciBwcmlvcml0eVxuICovXG5leHBvcnQgZnVuY3Rpb24gY2FsY3VsYXRlQWxlcnRQcmlvcml0eShhbGVydDogSGVhbHRoQWxlcnQpOiBudW1iZXIge1xuICBjb25zdCBzZXZlcml0eVNjb3JlID0gU0VWRVJJVFlfUFJJT1JJVFlbYWxlcnQuc2V2ZXJpdHldICogMTA7XG4gIGNvbnN0IHR5cGVTY29yZSA9IFRZUEVfUFJJT1JJVFlbYWxlcnQudHlwZV07XG4gIGNvbnN0IGVzY2FsYXRpb25Cb251cyA9IGFsZXJ0LmVzY2FsYXRlZCA/IDIwIDogMDtcbiAgY29uc3QgdW5hY2tub3dsZWRnZWRCb251cyA9ICFhbGVydC5hY2tub3dsZWRnZWQgPyAxMCA6IDA7XG4gIFxuICAvLyBNb3JlIHJlY2VudCBhbGVydHMgZ2V0IHNsaWdodGx5IGhpZ2hlciBwcmlvcml0eVxuICBjb25zdCBhZ2VJbk1pbnV0ZXMgPSAoRGF0ZS5ub3coKSAtIGFsZXJ0LnRpbWVzdGFtcC5nZXRUaW1lKCkpIC8gKDEwMDAgKiA2MCk7XG4gIGNvbnN0IHJlY2VuY3lTY29yZSA9IE1hdGgubWF4KDAsIDUgLSAoYWdlSW5NaW51dGVzIC8gNjApKTsgLy8gRGVjcmVhc2VzIG92ZXIgaG91cnNcbiAgXG4gIHJldHVybiBzZXZlcml0eVNjb3JlICsgdHlwZVNjb3JlICsgZXNjYWxhdGlvbkJvbnVzICsgdW5hY2tub3dsZWRnZWRCb251cyArIHJlY2VuY3lTY29yZTtcbn1cblxuLyoqXG4gKiBTb3J0IGFsZXJ0cyBieSBwcmlvcml0eSAoaGlnaGVzdCBmaXJzdClcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIHByaW9yaXRpemVBbGVydHMoYWxlcnRzOiBIZWFsdGhBbGVydFtdKTogSGVhbHRoQWxlcnRbXSB7XG4gIHJldHVybiBbLi4uYWxlcnRzXS5zb3J0KChhLCBiKSA9PiB7XG4gICAgY29uc3QgcHJpb3JpdHlBID0gY2FsY3VsYXRlQWxlcnRQcmlvcml0eShhKTtcbiAgICBjb25zdCBwcmlvcml0eUIgPSBjYWxjdWxhdGVBbGVydFByaW9yaXR5KGIpO1xuICAgIFxuICAgIGlmIChwcmlvcml0eUEgIT09IHByaW9yaXR5Qikge1xuICAgICAgcmV0dXJuIHByaW9yaXR5QiAtIHByaW9yaXR5QTsgLy8gSGlnaGVyIHByaW9yaXR5IGZpcnN0XG4gICAgfVxuICAgIFxuICAgIC8vIElmIHNhbWUgcHJpb3JpdHksIG5ld2VyIGFsZXJ0cyBmaXJzdFxuICAgIHJldHVybiBiLnRpbWVzdGFtcC5nZXRUaW1lKCkgLSBhLnRpbWVzdGFtcC5nZXRUaW1lKCk7XG4gIH0pO1xufVxuXG4vKipcbiAqIENoZWNrIGlmIHR3byBhbGVydHMgYXJlIHJlbGF0ZWQgYW5kIGNhbiBiZSBjb25zb2xpZGF0ZWRcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGFyZUFsZXJ0c1JlbGF0ZWQoYWxlcnQxOiBIZWFsdGhBbGVydCwgYWxlcnQyOiBIZWFsdGhBbGVydCk6IGJvb2xlYW4ge1xuICAvLyBTYW1lIHVzZXIgYW5kIHNhbWUgdHlwZVxuICBpZiAoYWxlcnQxLnVzZXJJZCAhPT0gYWxlcnQyLnVzZXJJZCB8fCBhbGVydDEudHlwZSAhPT0gYWxlcnQyLnR5cGUpIHtcbiAgICByZXR1cm4gZmFsc2U7XG4gIH1cbiAgXG4gIC8vIFdpdGhpbiAxNSBtaW51dGVzIG9mIGVhY2ggb3RoZXJcbiAgY29uc3QgdGltZURpZmYgPSBNYXRoLmFicyhhbGVydDEudGltZXN0YW1wLmdldFRpbWUoKSAtIGFsZXJ0Mi50aW1lc3RhbXAuZ2V0VGltZSgpKTtcbiAgY29uc3QgZmlmdGVlbk1pbnV0ZXMgPSAxNSAqIDYwICogMTAwMDtcbiAgXG4gIGlmICh0aW1lRGlmZiA+IGZpZnRlZW5NaW51dGVzKSB7XG4gICAgcmV0dXJuIGZhbHNlO1xuICB9XG4gIFxuICAvLyBDaGVjayBpZiByZWxhdGVkIGRhdGEgaW5kaWNhdGVzIHNhbWUgaXNzdWVcbiAgaWYgKGFsZXJ0MS5yZWxhdGVkRGF0YSAmJiBhbGVydDIucmVsYXRlZERhdGEpIHtcbiAgICAvLyBGb3Igdml0YWwgc2lnbnMgYWxlcnRzLCBjaGVjayBpZiBzYW1lIG1ldHJpY1xuICAgIGlmIChhbGVydDEudHlwZSA9PT0gJ3ZpdGFsX3NpZ25zJykge1xuICAgICAgY29uc3QgbWV0cmljMSA9IGFsZXJ0MS5yZWxhdGVkRGF0YS5tZXRyaWM7XG4gICAgICBjb25zdCBtZXRyaWMyID0gYWxlcnQyLnJlbGF0ZWREYXRhLm1ldHJpYztcbiAgICAgIHJldHVybiBtZXRyaWMxID09PSBtZXRyaWMyO1xuICAgIH1cbiAgICBcbiAgICAvLyBGb3IgbWVkaWNhdGlvbiBhbGVydHMsIGNoZWNrIGlmIHNhbWUgbWVkaWNhdGlvblxuICAgIGlmIChhbGVydDEudHlwZSA9PT0gJ21lZGljYXRpb24nKSB7XG4gICAgICBjb25zdCBtZWQxID0gYWxlcnQxLnJlbGF0ZWREYXRhLm1lZGljYXRpb25JZDtcbiAgICAgIGNvbnN0IG1lZDIgPSBhbGVydDIucmVsYXRlZERhdGEubWVkaWNhdGlvbklkO1xuICAgICAgcmV0dXJuIG1lZDEgPT09IG1lZDI7XG4gICAgfVxuICAgIFxuICAgIC8vIEZvciBkZXZpY2UgYWxlcnRzLCBjaGVjayBpZiBzYW1lIGRldmljZVxuICAgIGlmIChhbGVydDEudHlwZSA9PT0gJ2RldmljZScpIHtcbiAgICAgIGNvbnN0IGRldmljZTEgPSBhbGVydDEucmVsYXRlZERhdGEuZGV2aWNlSWQ7XG4gICAgICBjb25zdCBkZXZpY2UyID0gYWxlcnQyLnJlbGF0ZWREYXRhLmRldmljZUlkO1xuICAgICAgcmV0dXJuIGRldmljZTEgPT09IGRldmljZTI7XG4gICAgfVxuICB9XG4gIFxuICByZXR1cm4gdHJ1ZTtcbn1cblxuLyoqXG4gKiBDb25zb2xpZGF0ZSByZWxhdGVkIGFsZXJ0cyBpbnRvIGdyb3Vwc1xuICovXG5leHBvcnQgZnVuY3Rpb24gY29uc29saWRhdGVBbGVydHMoYWxlcnRzOiBIZWFsdGhBbGVydFtdKTogSGVhbHRoQWxlcnRbXVtdIHtcbiAgY29uc3QgY29uc29saWRhdGVkOiBIZWFsdGhBbGVydFtdW10gPSBbXTtcbiAgY29uc3QgcHJvY2Vzc2VkID0gbmV3IFNldDxzdHJpbmc+KCk7XG4gIFxuICBmb3IgKGNvbnN0IGFsZXJ0IG9mIGFsZXJ0cykge1xuICAgIGlmIChwcm9jZXNzZWQuaGFzKGFsZXJ0LmlkKSkge1xuICAgICAgY29udGludWU7XG4gICAgfVxuICAgIFxuICAgIGNvbnN0IGdyb3VwOiBIZWFsdGhBbGVydFtdID0gW2FsZXJ0XTtcbiAgICBwcm9jZXNzZWQuYWRkKGFsZXJ0LmlkKTtcbiAgICBcbiAgICAvLyBGaW5kIHJlbGF0ZWQgYWxlcnRzXG4gICAgZm9yIChjb25zdCBvdGhlckFsZXJ0IG9mIGFsZXJ0cykge1xuICAgICAgaWYgKHByb2Nlc3NlZC5oYXMob3RoZXJBbGVydC5pZCkpIHtcbiAgICAgICAgY29udGludWU7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGlmIChhcmVBbGVydHNSZWxhdGVkKGFsZXJ0LCBvdGhlckFsZXJ0KSkge1xuICAgICAgICBncm91cC5wdXNoKG90aGVyQWxlcnQpO1xuICAgICAgICBwcm9jZXNzZWQuYWRkKG90aGVyQWxlcnQuaWQpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICBjb25zb2xpZGF0ZWQucHVzaChncm91cCk7XG4gIH1cbiAgXG4gIHJldHVybiBjb25zb2xpZGF0ZWQ7XG59XG5cbi8qKlxuICogQ3JlYXRlIGEgY29uc29saWRhdGVkIGFsZXJ0IG1lc3NhZ2UgZnJvbSBhIGdyb3VwIG9mIHJlbGF0ZWQgYWxlcnRzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBjcmVhdGVDb25zb2xpZGF0ZWRNZXNzYWdlKGFsZXJ0czogSGVhbHRoQWxlcnRbXSk6IHN0cmluZyB7XG4gIGlmIChhbGVydHMubGVuZ3RoID09PSAxKSB7XG4gICAgcmV0dXJuIGFsZXJ0c1swXS5tZXNzYWdlO1xuICB9XG4gIFxuICBjb25zdCBmaXJzdEFsZXJ0ID0gYWxlcnRzWzBdO1xuICBjb25zdCBjb3VudCA9IGFsZXJ0cy5sZW5ndGg7XG4gIFxuICAvLyBHZXQgdGhlIGhpZ2hlc3Qgc2V2ZXJpdHkgaW4gdGhlIGdyb3VwXG4gIGNvbnN0IGhpZ2hlc3RTZXZlcml0eSA9IGFsZXJ0cy5yZWR1Y2UoKG1heCwgYWxlcnQpID0+IHtcbiAgICBjb25zdCBzZXZlcml0eU9yZGVyOiBBbGVydFNldmVyaXR5W10gPSBbJ2xvdycsICdtZWRpdW0nLCAnaGlnaCcsICdjcml0aWNhbCddO1xuICAgIHJldHVybiBzZXZlcml0eU9yZGVyLmluZGV4T2YoYWxlcnQuc2V2ZXJpdHkpID4gc2V2ZXJpdHlPcmRlci5pbmRleE9mKG1heCkgPyBhbGVydC5zZXZlcml0eSA6IG1heDtcbiAgfSwgJ2xvdycgYXMgQWxlcnRTZXZlcml0eSk7XG4gIFxuICBjb25zdCB0eXBlTGFiZWwgPSBmaXJzdEFsZXJ0LnR5cGUucmVwbGFjZSgvXy9nLCAnICcpO1xuICBcbiAgcmV0dXJuIGAke2NvdW50fSAke3R5cGVMYWJlbH0gYWxlcnRzICgke2hpZ2hlc3RTZXZlcml0eX0gc2V2ZXJpdHkpOiAke2ZpcnN0QWxlcnQubWVzc2FnZX0ke2NvdW50ID4gMSA/IGAgYW5kICR7Y291bnQgLSAxfSBtb3JlYCA6ICcnfWA7XG59XG5cbi8qKlxuICogR2V0IGFsZXJ0cyB0aGF0IG5lZWQgZXNjYWxhdGlvbiBiYXNlZCBvbiB0aW1lIGFuZCBhY2tub3dsZWRnbWVudCBzdGF0dXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldEFsZXJ0c05lZWRpbmdFc2NhbGF0aW9uKGFsZXJ0czogSGVhbHRoQWxlcnRbXSwgZXNjYWxhdGlvblRpbWVNaW51dGVzOiBudW1iZXIgPSAzMCk6IEhlYWx0aEFsZXJ0W10ge1xuICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICBjb25zdCBlc2NhbGF0aW9uVGhyZXNob2xkID0gZXNjYWxhdGlvblRpbWVNaW51dGVzICogNjAgKiAxMDAwO1xuICBcbiAgcmV0dXJuIGFsZXJ0cy5maWx0ZXIoYWxlcnQgPT4ge1xuICAgIC8vIEFscmVhZHkgZXNjYWxhdGVkXG4gICAgaWYgKGFsZXJ0LmVzY2FsYXRlZCkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBcbiAgICAvLyBBbHJlYWR5IGFja25vd2xlZGdlZFxuICAgIGlmIChhbGVydC5hY2tub3dsZWRnZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgXG4gICAgLy8gT25seSBlc2NhbGF0ZSBtZWRpdW0gc2V2ZXJpdHkgYW5kIGFib3ZlXG4gICAgaWYgKGFsZXJ0LnNldmVyaXR5ID09PSAnbG93Jykge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBcbiAgICAvLyBDaGVjayBpZiBlbm91Z2ggdGltZSBoYXMgcGFzc2VkXG4gICAgY29uc3QgdGltZVNpbmNlQWxlcnQgPSBub3cgLSBhbGVydC50aW1lc3RhbXAuZ2V0VGltZSgpO1xuICAgIHJldHVybiB0aW1lU2luY2VBbGVydCA+PSBlc2NhbGF0aW9uVGhyZXNob2xkO1xuICB9KTtcbn1cblxuLyoqXG4gKiBGaWx0ZXIgYWxlcnRzIGJhc2VkIG9uIHVzZXIgcHJlZmVyZW5jZXNcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGZpbHRlckFsZXJ0c0J5UHJlZmVyZW5jZXMoXG4gIGFsZXJ0czogSGVhbHRoQWxlcnRbXSxcbiAgcHJlZmVyZW5jZXM6IHtcbiAgICBhbGVydFR5cGVzPzoge1xuICAgICAgW2tleSBpbiBBbGVydFR5cGVdPzoge1xuICAgICAgICBlbmFibGVkOiBib29sZWFuO1xuICAgICAgICB1cmdlbmN5TGV2ZWxzOiBBbGVydFNldmVyaXR5W107XG4gICAgICB9O1xuICAgIH07XG4gIH1cbik6IEhlYWx0aEFsZXJ0W10ge1xuICBpZiAoIXByZWZlcmVuY2VzLmFsZXJ0VHlwZXMpIHtcbiAgICByZXR1cm4gYWxlcnRzO1xuICB9XG4gIFxuICByZXR1cm4gYWxlcnRzLmZpbHRlcihhbGVydCA9PiB7XG4gICAgY29uc3QgdHlwZVByZWZzID0gcHJlZmVyZW5jZXMuYWxlcnRUeXBlcz8uW2FsZXJ0LnR5cGVdO1xuICAgIFxuICAgIC8vIElmIG5vIHByZWZlcmVuY2VzIGZvciB0aGlzIHR5cGUsIGluY2x1ZGUgaXRcbiAgICBpZiAoIXR5cGVQcmVmcykge1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfVxuICAgIFxuICAgIC8vIENoZWNrIGlmIHR5cGUgaXMgZW5hYmxlZFxuICAgIGlmICghdHlwZVByZWZzLmVuYWJsZWQpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gICAgXG4gICAgLy8gQ2hlY2sgaWYgc2V2ZXJpdHkgbGV2ZWwgaXMgaW5jbHVkZWRcbiAgICBpZiAodHlwZVByZWZzLnVyZ2VuY3lMZXZlbHMgJiYgIXR5cGVQcmVmcy51cmdlbmN5TGV2ZWxzLmluY2x1ZGVzKGFsZXJ0LnNldmVyaXR5KSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gdHJ1ZTtcbiAgfSk7XG59XG4iXX0=