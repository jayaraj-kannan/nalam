"use strict";
// Alerts Table Data Access Layer
// Requirements: 3.1, 8.1, 8.4
Object.defineProperty(exports, "__esModule", { value: true });
exports.createAlert = createAlert;
exports.getAlert = getAlert;
exports.getAlertsByUser = getAlertsByUser;
exports.getAlertsByStatus = getAlertsByStatus;
exports.acknowledgeAlert = acknowledgeAlert;
exports.escalateAlert = escalateAlert;
exports.deleteAlert = deleteAlert;
const dynamodb_client_1 = require("../dynamodb-client");
// ============================================================================
// Alert Operations
// ============================================================================
async function createAlert(alert) {
    const alertId = `alert-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const healthAlert = {
        ...alert,
        id: alertId,
        timestamp: alert.timestamp || new Date(),
    };
    await (0, dynamodb_client_1.putItem)(dynamodb_client_1.TABLES.ALERTS, {
        alertId,
        userId: healthAlert.userId,
        type: healthAlert.type,
        severity: healthAlert.severity,
        message: healthAlert.message,
        timestamp: healthAlert.timestamp.toISOString(),
        acknowledged: healthAlert.acknowledged,
        acknowledgedBy: healthAlert.acknowledgedBy,
        acknowledgedAt: healthAlert.acknowledgedAt?.toISOString(),
        escalated: healthAlert.escalated,
        escalationLevel: healthAlert.escalationLevel,
        relatedData: healthAlert.relatedData,
        status: healthAlert.acknowledged ? 'acknowledged' : 'pending',
    });
    return alertId;
}
async function getAlert(alertId, timestamp) {
    const result = await (0, dynamodb_client_1.getItem)(dynamodb_client_1.TABLES.ALERTS, { alertId, timestamp });
    if (!result)
        return null;
    return {
        ...result,
        timestamp: new Date(result.timestamp),
        acknowledgedAt: result.acknowledgedAt ? new Date(result.acknowledgedAt) : undefined,
    };
}
async function getAlertsByUser(userId, startTime, endTime, limit) {
    let keyConditionExpression = 'userId = :userId';
    const expressionAttributeValues = { ':userId': userId };
    if (startTime && endTime) {
        keyConditionExpression += ' AND #timestamp BETWEEN :startTime AND :endTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
        expressionAttributeValues[':endTime'] = endTime.toISOString();
    }
    else if (startTime) {
        keyConditionExpression += ' AND #timestamp >= :startTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
    }
    const results = await (0, dynamodb_client_1.queryItems)(dynamodb_client_1.TABLES.ALERTS, keyConditionExpression, expressionAttributeValues, 'userId-timestamp-index', undefined, limit);
    return results.map((alert) => ({
        ...alert,
        timestamp: new Date(alert.timestamp),
        acknowledgedAt: alert.acknowledgedAt ? new Date(alert.acknowledgedAt) : undefined,
    }));
}
async function getAlertsByStatus(status, startTime, endTime, limit) {
    let keyConditionExpression = '#status = :status';
    const expressionAttributeValues = { ':status': status };
    if (startTime && endTime) {
        keyConditionExpression += ' AND #timestamp BETWEEN :startTime AND :endTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
        expressionAttributeValues[':endTime'] = endTime.toISOString();
    }
    else if (startTime) {
        keyConditionExpression += ' AND #timestamp >= :startTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
    }
    const results = await (0, dynamodb_client_1.queryItems)(dynamodb_client_1.TABLES.ALERTS, keyConditionExpression, expressionAttributeValues, 'status-index', undefined, limit);
    return results.map((alert) => ({
        ...alert,
        timestamp: new Date(alert.timestamp),
        acknowledgedAt: alert.acknowledgedAt ? new Date(alert.acknowledgedAt) : undefined,
    }));
}
async function acknowledgeAlert(alertId, timestamp, acknowledgedBy) {
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.ALERTS, { alertId, timestamp }, 'SET acknowledged = :acknowledged, acknowledgedBy = :acknowledgedBy, acknowledgedAt = :acknowledgedAt, #status = :status', {
        ':acknowledged': true,
        ':acknowledgedBy': acknowledgedBy,
        ':acknowledgedAt': new Date().toISOString(),
        ':status': 'acknowledged',
    }, { '#status': 'status' });
}
async function escalateAlert(alertId, timestamp, escalationLevel) {
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.ALERTS, { alertId, timestamp }, 'SET escalated = :escalated, escalationLevel = :escalationLevel', {
        ':escalated': true,
        ':escalationLevel': escalationLevel,
    });
}
async function deleteAlert(alertId, timestamp) {
    await (0, dynamodb_client_1.deleteItem)(dynamodb_client_1.TABLES.ALERTS, { alertId, timestamp });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYWxlcnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYWxlcnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxpQ0FBaUM7QUFDakMsOEJBQThCOztBQVM5QixrQ0F5QkM7QUFFRCw0QkFVQztBQUVELDBDQWdDQztBQUVELDhDQWdDQztBQUVELDRDQWlCQztBQUVELHNDQWNDO0FBRUQsa0NBRUM7QUF0SkQsd0RBQWtHO0FBRWxHLCtFQUErRTtBQUMvRSxtQkFBbUI7QUFDbkIsK0VBQStFO0FBRXhFLEtBQUssVUFBVSxXQUFXLENBQUMsS0FBOEI7SUFDOUQsTUFBTSxPQUFPLEdBQUcsU0FBUyxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDakYsTUFBTSxXQUFXLEdBQWdCO1FBQy9CLEdBQUcsS0FBSztRQUNSLEVBQUUsRUFBRSxPQUFPO1FBQ1gsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTLElBQUksSUFBSSxJQUFJLEVBQUU7S0FDekMsQ0FBQztJQUVGLE1BQU0sSUFBQSx5QkFBTyxFQUFDLHdCQUFNLENBQUMsTUFBTSxFQUFFO1FBQzNCLE9BQU87UUFDUCxNQUFNLEVBQUUsV0FBVyxDQUFDLE1BQU07UUFDMUIsSUFBSSxFQUFFLFdBQVcsQ0FBQyxJQUFJO1FBQ3RCLFFBQVEsRUFBRSxXQUFXLENBQUMsUUFBUTtRQUM5QixPQUFPLEVBQUUsV0FBVyxDQUFDLE9BQU87UUFDNUIsU0FBUyxFQUFFLFdBQVcsQ0FBQyxTQUFTLENBQUMsV0FBVyxFQUFFO1FBQzlDLFlBQVksRUFBRSxXQUFXLENBQUMsWUFBWTtRQUN0QyxjQUFjLEVBQUUsV0FBVyxDQUFDLGNBQWM7UUFDMUMsY0FBYyxFQUFFLFdBQVcsQ0FBQyxjQUFjLEVBQUUsV0FBVyxFQUFFO1FBQ3pELFNBQVMsRUFBRSxX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LE9BQU8sRUFBRSxTQUFTLEVBQUUsRUFDdEIsZ0VBQWdFLEVBQ2hFO1FBQ0UsWUFBWSxFQUFFLElBQUk7UUFDbEIsa0JBQWtCLEVBQUUsZUFBZTtLQUNwQyxDQUNGLENBQUM7QUFDSixDQUFDO0FBRU0sS0FBSyxVQUFVLFdBQVcsQ0FBQyxPQUFlLEVBQUUsU0FBaUI7SUFDbEUsTUFBTSxJQUFBLDRCQUFVLEVBQUMsd0JBQU0sQ0FBQyxNQUFNLEVBQUUsRUFBRSxPQUFPLEVBQUUsU0FBUyxFQUFFLENBQUMsQ0FBQztBQUMxRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQWxlcnRzIFRhYmxlIERhdGEgQWNjZXNzIExheWVyXG4vLyBSZXF1aXJlbWVudHM6IDMuMSwgOC4xLCA4LjRcblxuaW1wb3J0IHsgSGVhbHRoQWxlcnQsIEFsZXJ0U2V2ZXJpdHkgfSBmcm9tICcuLi90eXBlcyc7XG5pbXBvcnQgeyBUQUJMRVMsIHB1dEl0ZW0sIGdldEl0ZW0sIHF1ZXJ5SXRlbXMsIHVwZGF0ZUl0ZW0sIGRlbGV0ZUl0ZW0gfSBmcm9tICcuLi9keW5hbW9kYi1jbGllbnQnO1xuXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG4vLyBBbGVydCBPcGVyYXRpb25zXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVBbGVydChhbGVydDogT21pdDxIZWFsdGhBbGVydCwgJ2lkJz4pOiBQcm9taXNlPHN0cmluZz4ge1xuICBjb25zdCBhbGVydElkID0gYGFsZXJ0LSR7RGF0ZS5ub3coKX0tJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YDtcbiAgY29uc3QgaGVhbHRoQWxlcnQ6IEhlYWx0aEFsZXJ0ID0ge1xuICAgIC4uLmFsZXJ0LFxuICAgIGlkOiBhbGVydElkLFxuICAgIHRpbWVzdGFtcDogYWxlcnQudGltZXN0YW1wIHx8IG5ldyBEYXRlKCksXG4gIH07XG5cbiAgYXdhaXQgcHV0SXRlbShUQUJMRVMuQUxFUlRTLCB7XG4gICAgYWxlcnRJZCxcbiAgICB1c2VySWQ6IGhlYWx0aEFsZXJ0LnVzZXJJZCxcbiAgICB0eXBlOiBoZWFsdGhBbGVydC50eXBlLFxuICAgIHNldmVyaXR5OiBoZWFsdGhBbGVydC5zZXZlcml0eSxcbiAgICBtZXNzYWdlOiBoZWFsdGhBbGVydC5tZXNzYWdlLFxuICAgIHRpbWVzdGFtcDogaGVhbHRoQWxlcnQudGltZXN0YW1wLnRvSVNPU3RyaW5nKCksXG4gICAgYWNrbm93bGVkZ2VkOiBoZWFsdGhBbGVydC5hY2tub3dsZWRnZWQsXG4gICAgYWNrbm93bGVkZ2VkQnk6IGhlYWx0aEFsZXJ0LmFja25vd2xlZGdlZEJ5LFxuICAgIGFja25vd2xlZGdlZEF0OiBoZWFsdGhBbGVydC5hY2tub3dsZWRnZWRBdD8udG9JU09TdHJpbmcoKSxcbiAgICBlc2NhbGF0ZWQ6IGhlYWx0aEFsZXJ0LmVzY2FsYXRlZCxcbiAgICBlc2NhbGF0aW9uTGV2ZWw6IGhlYWx0aEFsZXJ0LmVzY2FsYXRpb25MZXZlbCxcbiAgICByZWxhdGVkRGF0YTogaGVhbHRoQWxlcnQucmVsYXRlZERhdGEsXG4gICAgc3RhdHVzOiBoZWFsdGhBbGVydC5hY2tub3dsZWRnZWQgPyAnYWNrbm93bGVkZ2VkJyA6ICdwZW5kaW5nJyxcbiAgfSk7XG5cbiAgcmV0dXJuIGFsZXJ0SWQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBbGVydChhbGVydElkOiBzdHJpbmcsIHRpbWVzdGFtcDogc3RyaW5nKTogUHJvbWlzZTxIZWFsdGhBbGVydCB8IG51bGw+IHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0SXRlbTxIZWFsdGhBbGVydD4oVEFCTEVTLkFMRVJUUywgeyBhbGVydElkLCB0aW1lc3RhbXAgfSk7XG5cbiAgaWYgKCFyZXN1bHQpIHJldHVybiBudWxsO1xuXG4gIHJldHVybiB7XG4gICAgLi4ucmVzdWx0LFxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUocmVzdWx0LnRpbWVzdGFtcCksXG4gICAgYWNrbm93bGVkZ2VkQXQ6IHJlc3VsdC5hY2tub3dsZWRnZWRBdCA/IG5ldyBEYXRlKHJlc3VsdC5hY2tub3dsZWRnZWRBdCkgOiB1bmRlZmluZWQsXG4gIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBbGVydHNCeVVzZXIoXG4gIHVzZXJJZDogc3RyaW5nLFxuICBzdGFydFRpbWU/OiBEYXRlLFxuICBlbmRUaW1lPzogRGF0ZSxcbiAgbGltaXQ/OiBudW1iZXJcbik6IFByb21pc2U8SGVhbHRoQWxlcnRbXT4ge1xuICBsZXQga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiA9ICd1c2VySWQgPSA6dXNlcklkJztcbiAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7ICc6dXNlcklkJzogdXNlcklkIH07XG5cbiAgaWYgKHN0YXJ0VGltZSAmJiBlbmRUaW1lKSB7XG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUnO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpzdGFydFRpbWUnXSA9IHN0YXJ0VGltZS50b0lTT1N0cmluZygpO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzplbmRUaW1lJ10gPSBlbmRUaW1lLnRvSVNPU3RyaW5nKCk7XG4gIH0gZWxzZSBpZiAoc3RhcnRUaW1lKSB7XG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wID49IDpzdGFydFRpbWUnO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpzdGFydFRpbWUnXSA9IHN0YXJ0VGltZS50b0lTT1N0cmluZygpO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0cyA9IGF3YWl0IHF1ZXJ5SXRlbXM8SGVhbHRoQWxlcnQ+KFxuICAgIFRBQkxFUy5BTEVSVFMsXG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbixcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICd1c2VySWQtdGltZXN0YW1wLWluZGV4JyxcbiAgICB1bmRlZmluZWQsXG4gICAgbGltaXRcbiAgKTtcblxuICByZXR1cm4gcmVzdWx0cy5tYXAoKGFsZXJ0KSA9PiAoe1xuICAgIC4uLmFsZXJ0LFxuICAgIHRpbWVzdGFtcDogbmV3IERhdGUoYWxlcnQudGltZXN0YW1wKSxcbiAgICBhY2tub3dsZWRnZWRBdDogYWxlcnQuYWNrbm93bGVkZ2VkQXQgPyBuZXcgRGF0ZShhbGVydC5hY2tub3dsZWRnZWRBdCkgOiB1bmRlZmluZWQsXG4gIH0pKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEFsZXJ0c0J5U3RhdHVzKFxuICBzdGF0dXM6IHN0cmluZyxcbiAgc3RhcnRUaW1lPzogRGF0ZSxcbiAgZW5kVGltZT86IERhdGUsXG4gIGxpbWl0PzogbnVtYmVyXG4pOiBQcm9taXNlPEhlYWx0aEFsZXJ0W10+IHtcbiAgbGV0IGtleUNvbmRpdGlvbkV4cHJlc3Npb24gPSAnI3N0YXR1cyA9IDpzdGF0dXMnO1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9IHsgJzpzdGF0dXMnOiBzdGF0dXMgfTtcblxuICBpZiAoc3RhcnRUaW1lICYmIGVuZFRpbWUpIHtcbiAgICBrZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EICN0aW1lc3RhbXAgQkVUV0VFTiA6c3RhcnRUaW1lIEFORCA6ZW5kVGltZSc7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0VGltZSddID0gc3RhcnRUaW1lLnRvSVNPU3RyaW5nKCk7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmVuZFRpbWUnXSA9IGVuZFRpbWUudG9JU09TdHJpbmcoKTtcbiAgfSBlbHNlIGlmIChzdGFydFRpbWUpIHtcbiAgICBrZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EICN0aW1lc3RhbXAgPj0gOnN0YXJ0VGltZSc7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0VGltZSddID0gc3RhcnRUaW1lLnRvSVNPU3RyaW5nKCk7XG4gIH1cblxuICBjb25zdCByZXN1bHRzID0gYXdhaXQgcXVlcnlJdGVtczxIZWFsdGhBbGVydD4oXG4gICAgVEFCTEVTLkFMRVJUUyxcbiAgICBrZXlDb25kaXRpb25FeHByZXNzaW9uLFxuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgJ3N0YXR1cy1pbmRleCcsXG4gICAgdW5kZWZpbmVkLFxuICAgIGxpbWl0XG4gICk7XG5cbiAgcmV0dXJuIHJlc3VsdHMubWFwKChhbGVydCkgPT4gKHtcbiAgICAuLi5hbGVydCxcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKGFsZXJ0LnRpbWVzdGFtcCksXG4gICAgYWNrbm93bGVkZ2VkQXQ6IGFsZXJ0LmFja25vd2xlZGdlZEF0ID8gbmV3IERhdGUoYWxlcnQuYWNrbm93bGVkZ2VkQXQpIDogdW5kZWZpbmVkLFxuICB9KSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBhY2tub3dsZWRnZUFsZXJ0KFxuICBhbGVydElkOiBzdHJpbmcsXG4gIHRpbWVzdGFtcDogc3RyaW5nLFxuICBhY2tub3dsZWRnZWRCeTogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgYXdhaXQgdXBkYXRlSXRlbShcbiAgICBUQUJMRVMuQUxFUlRTLFxuICAgIHsgYWxlcnRJZCwgdGltZXN0YW1wIH0sXG4gICAgJ1NFVCBhY2tub3dsZWRnZWQgPSA6YWNrbm93bGVkZ2VkLCBhY2tub3dsZWRnZWRCeSA9IDphY2tub3dsZWRnZWRCeSwgYWNrbm93bGVkZ2VkQXQgPSA6YWNrbm93bGVkZ2VkQXQsICNzdGF0dXMgPSA6c3RhdHVzJyxcbiAgICB7XG4gICAgICAnOmFja25vd2xlZGdlZCc6IHRydWUsXG4gICAgICAnOmFja25vd2xlZGdlZEJ5JzogYWNrbm93bGVkZ2VkQnksXG4gICAgICAnOmFja25vd2xlZGdlZEF0JzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpLFxuICAgICAgJzpzdGF0dXMnOiAnYWNrbm93bGVkZ2VkJyxcbiAgICB9LFxuICAgIHsgJyNzdGF0dXMnOiAnc3RhdHVzJyB9XG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBlc2NhbGF0ZUFsZXJ0KFxuICBhbGVydElkOiBzdHJpbmcsXG4gIHRpbWVzdGFtcDogc3RyaW5nLFxuICBlc2NhbGF0aW9uTGV2ZWw6IHN0cmluZ1xuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGF3YWl0IHVwZGF0ZUl0ZW0oXG4gICAgVEFCTEVTLkFMRVJUUyxcbiAgICB7IGFsZXJ0SWQsIHRpbWVzdGFtcCB9LFxuICAgICdTRVQgZXNjYWxhdGVkID0gOmVzY2FsYXRlZCwgZXNjYWxhdGlvbkxldmVsID0gOmVzY2FsYXRpb25MZXZlbCcsXG4gICAge1xuICAgICAgJzplc2NhbGF0ZWQnOiB0cnVlLFxuICAgICAgJzplc2NhbGF0aW9uTGV2ZWwnOiBlc2NhbGF0aW9uTGV2ZWwsXG4gICAgfVxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlQWxlcnQoYWxlcnRJZDogc3RyaW5nLCB0aW1lc3RhbXA6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBkZWxldGVJdGVtKFRBQkxFUy5BTEVSVFMsIHsgYWxlcnRJZCwgdGltZXN0YW1wIH0pO1xufVxuIl19