"use strict";
// Appointments Table Data Access Layer
// Requirements: 6.5, 8.1, 8.4
Object.defineProperty(exports, "__esModule", { value: true });
exports.createAppointment = createAppointment;
exports.getAppointment = getAppointment;
exports.getAppointmentsByUser = getAppointmentsByUser;
exports.getUpcomingAppointments = getUpcomingAppointments;
exports.updateAppointmentStatus = updateAppointmentStatus;
exports.updateAppointment = updateAppointment;
exports.deleteAppointment = deleteAppointment;
const dynamodb_client_1 = require("../dynamodb-client");
// ============================================================================
// Appointment Operations
// ============================================================================
async function createAppointment(appointment) {
    const appointmentId = `appt-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const appointmentRecord = {
        ...appointment,
        id: appointmentId,
    };
    await (0, dynamodb_client_1.putItem)(dynamodb_client_1.TABLES.APPOINTMENTS, {
        userId: appointmentRecord.userId,
        appointmentId,
        provider: appointmentRecord.provider,
        type: appointmentRecord.type,
        scheduledTime: appointmentRecord.scheduledTime.toISOString(),
        duration: appointmentRecord.duration,
        status: appointmentRecord.status,
        reminders: appointmentRecord.reminders,
        location: appointmentRecord.location,
        notes: appointmentRecord.notes,
        preparationInstructions: appointmentRecord.preparationInstructions,
    });
    return appointmentId;
}
async function getAppointment(userId, appointmentId) {
    const result = await (0, dynamodb_client_1.getItem)(dynamodb_client_1.TABLES.APPOINTMENTS, {
        userId,
        appointmentId,
    });
    if (!result)
        return null;
    return {
        ...result,
        scheduledTime: new Date(result.scheduledTime),
    };
}
async function getAppointmentsByUser(userId, limit) {
    const results = await (0, dynamodb_client_1.queryItems)(dynamodb_client_1.TABLES.APPOINTMENTS, 'userId = :userId', { ':userId': userId }, undefined, undefined, limit);
    return results.map((record) => ({
        ...record,
        scheduledTime: new Date(record.scheduledTime),
    }));
}
async function getUpcomingAppointments(userId, startTime, endTime, limit) {
    let keyConditionExpression = 'userId = :userId';
    const expressionAttributeValues = { ':userId': userId };
    if (startTime && endTime) {
        keyConditionExpression += ' AND scheduledTime BETWEEN :startTime AND :endTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
        expressionAttributeValues[':endTime'] = endTime.toISOString();
    }
    else if (startTime) {
        keyConditionExpression += ' AND scheduledTime >= :startTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
    }
    const results = await (0, dynamodb_client_1.queryItems)(dynamodb_client_1.TABLES.APPOINTMENTS, keyConditionExpression, expressionAttributeValues, 'scheduledTime-index', undefined, limit);
    return results.map((record) => ({
        ...record,
        scheduledTime: new Date(record.scheduledTime),
    }));
}
async function updateAppointmentStatus(userId, appointmentId, status, notes) {
    const updateExpressions = ['#status = :status'];
    const expressionAttributeValues = { ':status': status };
    const expressionAttributeNames = { '#status': 'status' };
    if (notes) {
        updateExpressions.push('notes = :notes');
        expressionAttributeValues[':notes'] = notes;
    }
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.APPOINTMENTS, { userId, appointmentId }, `SET ${updateExpressions.join(', ')}`, expressionAttributeValues, expressionAttributeNames);
}
async function updateAppointment(userId, appointmentId, updates) {
    const updateExpressions = [];
    const expressionAttributeValues = {};
    const expressionAttributeNames = {};
    Object.entries(updates).forEach(([key, value], index) => {
        if (key === 'userId' || key === 'id' || key === 'appointmentId')
            return;
        const attrName = `#attr${index}`;
        const attrValue = `:val${index}`;
        updateExpressions.push(`${attrName} = ${attrValue}`);
        expressionAttributeNames[attrName] = key;
        if (key === 'scheduledTime' && value instanceof Date) {
            expressionAttributeValues[attrValue] = value.toISOString();
        }
        else {
            expressionAttributeValues[attrValue] = value;
        }
    });
    if (updateExpressions.length === 0)
        return;
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.APPOINTMENTS, { userId, appointmentId }, `SET ${updateExpressions.join(', ')}`, expressionAttributeValues, expressionAttributeNames);
}
async function deleteAppointment(userId, appointmentId) {
    await (0, dynamodb_client_1.deleteItem)(dynamodb_client_1.TABLES.APPOINTMENTS, { userId, appointmentId });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiYXBwb2ludG1lbnRzLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiYXBwb2ludG1lbnRzLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSx1Q0FBdUM7QUFDdkMsOEJBQThCOztBQVM5Qiw4Q0F3QkM7QUFFRCx3Q0FlQztBQUVELHNEQWlCQztBQUVELDBEQStCQztBQUVELDBEQXNCQztBQUVELDhDQWlDQztBQUVELDhDQUVDO0FBbEtELHdEQUFrRztBQUVsRywrRUFBK0U7QUFDL0UseUJBQXlCO0FBQ3pCLCtFQUErRTtBQUV4RSxLQUFLLFVBQVUsaUJBQWlCLENBQ3JDLFdBQTBDO0lBRTFDLE1BQU0sYUFBYSxHQUFHLFFBQVEsSUFBSSxDQUFDLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDO0lBQ3RGLE1BQU0saUJBQWlCLEdBQXNCO1FBQzNDLEdBQUcsV0FBVztRQUNkLEVBQUUsRUFBRSxhQUFhO0tBQ2xCLENBQUM7SUFFRixNQUFNLElBQUEseUJBQU8sRUFBQyx3QkFBTSxDQUFDLFlBQVksRUFBRTtRQUNqQyxNQUFNLEVBQUUsaUJBQWlCLENBQUMsTUFBTTtRQUNoQyxhQUFhO1FBQ2IsUUFBUSxFQUFFLGlCQUFpQixDQUFDLFFBQVE7UUFDcEMsSUFBSSxFQUFFLGlCQUFpQixDQUFDLElBQUk7UUFDNUIsYUFBYSxFQUFFLGlCQUFpQixDQUFDLGFBQWEsQ0FBQyxXQUFXLEVBQUU7UUFDNUQsUUFBUSxFQUFFLGlCQUFpQixDQUFDLFFBQVE7UUFDcEMsTUFBTSxFQUFFLGlCQUFpQixDQUFDLE1BQU07UUFDaEMsU0FBUyxFQUFFLGlCQUFpQixDQUFDLFNBQVM7UUFDdEMsUUFBUSxFQUFFLGlCQUFpQixDQUFDLFFBQVE7UUFDcEMsS0FBSyxFQUFFLGlCQUFpQixDQUFDLEtBQUs7UUFDOUIsdUJBQXVCLEVB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QWlCLENBQUMsTUFBTSxLQUFLLENBQUM7UUFBRSxPQUFPO0lBRTNDLE1BQU0sSUFBQSw0QkFBVSxFQUNkLHdCQUFNLENBQUMsWUFBWSxFQUNuQixFQUFFLE1BQU0sRUFBRSxhQUFhLEVBQUUsRUFDekIsT0FBTyxpQkFBaUIsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsRUFDckMseUJBQXlCLEVBQ3pCLHdCQUF3QixDQUN6QixDQUFDO0FBQ0osQ0FBQztBQUVNLEtBQUssVUFBVSxpQkFBaUIsQ0FBQyxNQUFjLEVBQUUsYUFBcUI7SUFDM0UsTUFBTSxJQUFBLDRCQUFVLEVBQUMsd0JBQU0sQ0FBQyxZQUFZLEVBQUUsRUFBRSxNQUFNLEVBQUUsYUFBYSxFQUFFLENBQUMsQ0FBQztBQUNuRSxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gQXBwb2ludG1lbnRzIFRhYmxlIERhdGEgQWNjZXNzIExheWVyXG4vLyBSZXF1aXJlbWVudHM6IDYuNSwgOC4xLCA4LjRcblxuaW1wb3J0IHsgQXBwb2ludG1lbnRSZWNvcmQsIEFwcG9pbnRtZW50U3RhdHVzIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgVEFCTEVTLCBwdXRJdGVtLCBnZXRJdGVtLCBxdWVyeUl0ZW1zLCB1cGRhdGVJdGVtLCBkZWxldGVJdGVtIH0gZnJvbSAnLi4vZHluYW1vZGItY2xpZW50JztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gQXBwb2ludG1lbnQgT3BlcmF0aW9uc1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlQXBwb2ludG1lbnQoXG4gIGFwcG9pbnRtZW50OiBPbWl0PEFwcG9pbnRtZW50UmVjb3JkLCAnaWQnPlxuKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgYXBwb2ludG1lbnRJZCA9IGBhcHB0LSR7RGF0ZS5ub3coKX0tJHtNYXRoLnJhbmRvbSgpLnRvU3RyaW5nKDM2KS5zdWJzdHIoMiwgOSl9YDtcbiAgY29uc3QgYXBwb2ludG1lbnRSZWNvcmQ6IEFwcG9pbnRtZW50UmVjb3JkID0ge1xuICAgIC4uLmFwcG9pbnRtZW50LFxuICAgIGlkOiBhcHBvaW50bWVudElkLFxuICB9O1xuXG4gIGF3YWl0IHB1dEl0ZW0oVEFCTEVTLkFQUE9JTlRNRU5UUywge1xuICAgIHVzZXJJZDogYXBwb2ludG1lbnRSZWNvcmQudXNlcklkLFxuICAgIGFwcG9pbnRtZW50SWQsXG4gICAgcHJvdmlkZXI6IGFwcG9pbnRtZW50UmVjb3JkLnByb3ZpZGVyLFxuICAgIHR5cGU6IGFwcG9pbnRtZW50UmVjb3JkLnR5cGUsXG4gICAgc2NoZWR1bGVkVGltZTogYXBwb2ludG1lbnRSZWNvcmQuc2NoZWR1bGVkVGltZS50b0lTT1N0cmluZygpLFxuICAgIGR1cmF0aW9uOiBhcHBvaW50bWVudFJlY29yZC5kdXJhdGlvbixcbiAgICBzdGF0dXM6IGFwcG9pbnRtZW50UmVjb3JkLnN0YXR1cyxcbiAgICByZW1pbmRlcnM6IGFwcG9pbnRtZW50UmVjb3JkLnJlbWluZGVycyxcbiAgICBsb2NhdGlvbjogYXBwb2ludG1lbnRSZWNvcmQubG9jYXRpb24sXG4gICAgbm90ZXM6IGFwcG9pbnRtZW50UmVjb3JkLm5vdGVzLFxuICAgIHByZXBhcmF0aW9uSW5zdHJ1Y3Rpb25zOiBhcHBvaW50bWVudFJlY29yZC5wcmVwYXJhdGlvbkluc3RydWN0aW9ucyxcbiAgfSk7XG5cbiAgcmV0dXJuIGFwcG9pbnRtZW50SWQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRBcHBvaW50bWVudChcbiAgdXNlcklkOiBzdHJpbmcsXG4gIGFwcG9pbnRtZW50SWQ6IHN0cmluZ1xuKTogUHJvbWlzZTxBcHBvaW50bWVudFJlY29yZCB8IG51bGw+IHtcbiAgY29uc3QgcmVzdWx0ID0gYXdhaXQgZ2V0SXRlbTxBcHBvaW50bWVudFJlY29yZD4oVEFCTEVTLkFQUE9JTlRNRU5UUywge1xuICAgIHVzZXJJZCxcbiAgICBhcHBvaW50bWVudElkLFxuICB9KTtcblxuICBpZiAoIXJlc3VsdCkgcmV0dXJuIG51bGw7XG5cbiAgcmV0dXJuIHtcbiAgICAuLi5yZXN1bHQsXG4gICAgc2NoZWR1bGVkVGltZTogbmV3IERhdGUocmVzdWx0LnNjaGVkdWxlZFRpbWUpLFxuICB9O1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0QXBwb2ludG1lbnRzQnlVc2VyKFxuICB1c2VySWQ6IHN0cmluZyxcbiAgbGltaXQ/OiBudW1iZXJcbik6IFByb21pc2U8QXBwb2ludG1lbnRSZWNvcmRbXT4ge1xuICBjb25zdCByZXN1bHRzID0gYXdhaXQgcXVlcnlJdGVtczxBcHBvaW50bWVudFJlY29yZD4oXG4gICAgVEFCTEVTLkFQUE9JTlRNRU5UUyxcbiAgICAndXNlcklkID0gOnVzZXJJZCcsXG4gICAgeyAnOnVzZXJJZCc6IHVzZXJJZCB9LFxuICAgIHVuZGVmaW5lZCxcbiAgICB1bmRlZmluZWQsXG4gICAgbGltaXRcbiAgKTtcblxuICByZXR1cm4gcmVzdWx0cy5tYXAoKHJlY29yZCkgPT4gKHtcbiAgICAuLi5yZWNvcmQsXG4gICAgc2NoZWR1bGVkVGltZTogbmV3IERhdGUocmVjb3JkLnNjaGVkdWxlZFRpbWUpLFxuICB9KSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRVcGNvbWluZ0FwcG9pbnRtZW50cyhcbiAgdXNlcklkOiBzdHJpbmcsXG4gIHN0YXJ0VGltZT86IERhdGUsXG4gIGVuZFRpbWU/OiBEYXRlLFxuICBsaW1pdD86IG51bWJlclxuKTogUHJvbWlzZTxBcHBvaW50bWVudFJlY29yZFtdPiB7XG4gIGxldCBrZXlDb25kaXRpb25FeHByZXNzaW9uID0gJ3VzZXJJZCA9IDp1c2VySWQnO1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9IHsgJzp1c2VySWQnOiB1c2VySWQgfTtcblxuICBpZiAoc3RhcnRUaW1lICYmIGVuZFRpbWUpIHtcbiAgICBrZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EIHNjaGVkdWxlZFRpbWUgQkVUV0VFTiA6c3RhcnRUaW1lIEFORCA6ZW5kVGltZSc7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0VGltZSddID0gc3RhcnRUaW1lLnRvSVNPU3RyaW5nKCk7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOmVuZFRpbWUnXSA9IGVuZFRpbWUudG9JU09TdHJpbmcoKTtcbiAgfSBlbHNlIGlmIChzdGFydFRpbWUpIHtcbiAgICBrZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EIHNjaGVkdWxlZFRpbWUgPj0gOnN0YXJ0VGltZSc7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1snOnN0YXJ0VGltZSddID0gc3RhcnRUaW1lLnRvSVNPU3RyaW5nKCk7XG4gIH1cblxuICBjb25zdCByZXN1bHRzID0gYXdhaXQgcXVlcnlJdGVtczxBcHBvaW50bWVudFJlY29yZD4oXG4gICAgVEFCTEVTLkFQUE9JTlRNRU5UUyxcbiAgICBrZXlDb25kaXRpb25FeHByZXNzaW9uLFxuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgJ3NjaGVkdWxlZFRpbWUtaW5kZXgnLFxuICAgIHVuZGVmaW5lZCxcbiAgICBsaW1pdFxuICApO1xuXG4gIHJldHVybiByZXN1bHRzLm1hcCgocmVjb3JkKSA9PiAoe1xuICAgIC4uLnJlY29yZCxcbiAgICBzY2hlZHVsZWRUaW1lOiBuZXcgRGF0ZShyZWNvcmQuc2NoZWR1bGVkVGltZSksXG4gIH0pKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUFwcG9pbnRtZW50U3RhdHVzKFxuICB1c2VySWQ6IHN0cmluZyxcbiAgYXBwb2ludG1lbnRJZDogc3RyaW5nLFxuICBzdGF0dXM6IEFwcG9pbnRtZW50U3RhdHVzLFxuICBub3Rlcz86IHN0cmluZ1xuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHVwZGF0ZUV4cHJlc3Npb25zID0gWycjc3RhdHVzID0gOnN0YXR1cyddO1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9IHsgJzpzdGF0dXMnOiBzdGF0dXMgfTtcbiAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0geyAnI3N0YXR1cyc6ICdzdGF0dXMnIH07XG5cbiAgaWYgKG5vdGVzKSB7XG4gICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaCgnbm90ZXMgPSA6bm90ZXMnKTtcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6bm90ZXMnXSA9IG5vdGVzO1xuICB9XG5cbiAgYXdhaXQgdXBkYXRlSXRlbShcbiAgICBUQUJMRVMuQVBQT0lOVE1FTlRTLFxuICAgIHsgdXNlcklkLCBhcHBvaW50bWVudElkIH0sXG4gICAgYFNFVCAke3VwZGF0ZUV4cHJlc3Npb25zLmpvaW4oJywgJyl9YCxcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1xuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlQXBwb2ludG1lbnQoXG4gIHVzZXJJZDogc3RyaW5nLFxuICBhcHBvaW50bWVudElkOiBzdHJpbmcsXG4gIHVwZGF0ZXM6IFBhcnRpYWw8QXBwb2ludG1lbnRSZWNvcmQ+XG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgdXBkYXRlRXhwcmVzc2lvbnM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0ge307XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gIE9iamVjdC5lbnRyaWVzKHVwZGF0ZXMpLmZvckVhY2goKFtrZXksIHZhbHVlXSwgaW5kZXgpID0+IHtcbiAgICBpZiAoa2V5ID09PSAndXNlcklkJyB8fCBrZXkgPT09ICdpZCcgfHwga2V5ID09PSAnYXBwb2ludG1lbnRJZCcpIHJldHVybjtcbiAgICBcbiAgICBjb25zdCBhdHRyTmFtZSA9IGAjYXR0ciR7aW5kZXh9YDtcbiAgICBjb25zdCBhdHRyVmFsdWUgPSBgOnZhbCR7aW5kZXh9YDtcbiAgICB1cGRhdGVFeHByZXNzaW9ucy5wdXNoKGAke2F0dHJOYW1lfSA9ICR7YXR0clZhbHVlfWApO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1thdHRyTmFtZV0gPSBrZXk7XG4gICAgXG4gICAgaWYgKGtleSA9PT0gJ3NjaGVkdWxlZFRpbWUnICYmIHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1thdHRyVmFsdWVdID0gdmFsdWUudG9JU09TdHJpbmcoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1thdHRyVmFsdWVdID0gdmFsdWU7XG4gICAgfVxuICB9KTtcblxuICBpZiAodXBkYXRlRXhwcmVzc2lvbnMubGVuZ3RoID09PSAwKSByZXR1cm47XG5cbiAgYXdhaXQgdXBkYXRlSXRlbShcbiAgICBUQUJMRVMuQVBQT0lOVE1FTlRTLFxuICAgIHsgdXNlcklkLCBhcHBvaW50bWVudElkIH0sXG4gICAgYFNFVCAke3VwZGF0ZUV4cHJlc3Npb25zLmpvaW4oJywgJyl9YCxcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1xuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlQXBwb2ludG1lbnQodXNlcklkOiBzdHJpbmcsIGFwcG9pbnRtZW50SWQ6IHN0cmluZyk6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBkZWxldGVJdGVtKFRBQkxFUy5BUFBPSU5UTUVOVFMsIHsgdXNlcklkLCBhcHBvaW50bWVudElkIH0pO1xufVxuIl19