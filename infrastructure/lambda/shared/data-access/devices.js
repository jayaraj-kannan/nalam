"use strict";
// Devices Table Data Access Layer
// Requirements: 7.2, 8.1, 8.4
Object.defineProperty(exports, "__esModule", { value: true });
exports.registerDevice = registerDevice;
exports.getDevice = getDevice;
exports.getDevicesByUser = getDevicesByUser;
exports.updateDeviceStatus = updateDeviceStatus;
exports.updateDeviceBattery = updateDeviceBattery;
exports.updateDeviceSync = updateDeviceSync;
exports.updateDevice = updateDevice;
exports.deleteDevice = deleteDevice;
const dynamodb_client_1 = require("../dynamodb-client");
// ============================================================================
// Device Operations
// ============================================================================
async function registerDevice(device) {
    await (0, dynamodb_client_1.putItem)(dynamodb_client_1.TABLES.DEVICES, {
        deviceId: device.id,
        userId: device.userId,
        type: device.type,
        manufacturer: device.manufacturer,
        model: device.model,
        capabilities: device.capabilities,
        connectionType: device.connectionType,
        status: device.status,
        lastSync: device.lastSync?.toISOString(),
        batteryLevel: device.batteryLevel,
        firmwareVersion: device.firmwareVersion,
    });
}
async function getDevice(deviceId) {
    const result = await (0, dynamodb_client_1.getItem)(dynamodb_client_1.TABLES.DEVICES, { deviceId });
    if (!result)
        return null;
    return {
        ...result,
        lastSync: result.lastSync ? new Date(result.lastSync) : undefined,
    };
}
async function getDevicesByUser(userId) {
    const results = await (0, dynamodb_client_1.queryItems)(dynamodb_client_1.TABLES.DEVICES, 'userId = :userId', { ':userId': userId }, 'userId-index');
    return results.map((device) => ({
        ...device,
        lastSync: device.lastSync ? new Date(device.lastSync) : undefined,
    }));
}
async function updateDeviceStatus(deviceId, status, lastSync) {
    const updateExpressions = ['#status = :status'];
    const expressionAttributeValues = { ':status': status };
    const expressionAttributeNames = { '#status': 'status' };
    if (lastSync) {
        updateExpressions.push('lastSync = :lastSync');
        expressionAttributeValues[':lastSync'] = lastSync.toISOString();
    }
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.DEVICES, { deviceId }, `SET ${updateExpressions.join(', ')}`, expressionAttributeValues, expressionAttributeNames);
}
async function updateDeviceBattery(deviceId, batteryLevel) {
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.DEVICES, { deviceId }, 'SET batteryLevel = :batteryLevel', { ':batteryLevel': batteryLevel });
}
async function updateDeviceSync(deviceId) {
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.DEVICES, { deviceId }, 'SET lastSync = :lastSync', { ':lastSync': new Date().toISOString() });
}
async function updateDevice(deviceId, updates) {
    const updateExpressions = [];
    const expressionAttributeValues = {};
    const expressionAttributeNames = {};
    Object.entries(updates).forEach(([key, value], index) => {
        if (key === 'id' || key === 'deviceId')
            return;
        const attrName = `#attr${index}`;
        const attrValue = `:val${index}`;
        updateExpressions.push(`${attrName} = ${attrValue}`);
        expressionAttributeNames[attrName] = key;
        if (key === 'lastSync' && value instanceof Date) {
            expressionAttributeValues[attrValue] = value.toISOString();
        }
        else {
            expressionAttributeValues[attrValue] = value;
        }
    });
    if (updateExpressions.length === 0)
        return;
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.DEVICES, { deviceId }, `SET ${updateExpressions.join(', ')}`, expressionAttributeValues, expressionAttributeNames);
}
async function deleteDevice(deviceId) {
    await (0, dynamodb_client_1.deleteItem)(dynamodb_client_1.TABLES.DEVICES, { deviceId });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGV2aWNlcy5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRldmljZXMudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLGtDQUFrQztBQUNsQyw4QkFBOEI7O0FBUzlCLHdDQWNDO0FBRUQsOEJBU0M7QUFFRCw0Q0FZQztBQUVELGdEQXFCQztBQUVELGtEQVVDO0FBRUQsNENBT0M7QUFFRCxvQ0FnQ0M7QUFFRCxvQ0FFQztBQS9IRCx3REFBa0c7QUFFbEcsK0VBQStFO0FBQy9FLG9CQUFvQjtBQUNwQiwrRUFBK0U7QUFFeEUsS0FBSyxVQUFVLGNBQWMsQ0FBQyxNQUFvQjtJQUN2RCxNQUFNLElBQUEseUJBQU8sRUFBQyx3QkFBTSxDQUFDLE9BQU8sRUFBRTtRQUM1QixRQUFRLEVBQUUsTUFBTSxDQUFDLEVBQUU7UUFDbkIsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNO1FBQ3JCLElBQUksRUFBRSxNQUFNLENBQUMsSUFBSTtRQUNqQixZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVk7UUFDakMsS0FBSyxFQUFFLE1BQU0sQ0FBQyxLQUFLO1FBQ25CLFlBQVksRUFBRSxNQUFNLENBQUMsWUFBWTtRQUNqQyxjQUFjLEVBQUUsTUFBTSxDQUFDLGNBQWM7UUFDckMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxNQUFNO1FBQ3JCLFFBQVEsRUFBRSxNQUFNLENBQUMsUUFBUSxFQUFFLFdBQVcsRUFBRTtRQUN4QyxZQUFZLEVBQUUsTUFBTSxDQUFDLFlBQVk7UUFDakMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxlQUFlO0tBQ3hDLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFTSxLQUFLLFVBQVUsU0FBUyxDQUFDLFFBQWdCO0lBQzlDLE1BQU0sTUFBTSxHQUFHLE1BQU0sSUFBQSx5QkFBTyxFQUFlLHdCQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztJQUV6RSxJQUFJLENBQUMsTUFBTTtRQUFFLE9BQU8sSUFBSSxDQUFDO0lBRXpCLE9BQU87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QyxDQUFDO1FBQ3JELHdCQUF3QixDQUFDLFFBQVEsQ0FBQyxHQUFHLEdBQUcsQ0FBQztRQUV6QyxJQUFJLEdBQUcsS0FBSyxVQUFVLElBQUksS0FBSyxZQUFZLElBQUksRUFBRSxDQUFDO1lBQ2hELHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUM3RCxDQUFDO2FBQU0sQ0FBQztZQUNOLHlCQUF5QixDQUFDLFNBQVMsQ0FBQyxHQUFHLEtBQUssQ0FBQztRQUMvQyxDQUFDO0lBQ0gsQ0FBQyxDQUFDLENBQUM7SUFFSCxJQUFJLGlCQUFpQixDQUFDLE1BQU0sS0FBSyxDQUFDO1FBQUUsT0FBTztJQUUzQyxNQUFNLElBQUEsNEJBQVUsRUFDZCx3QkFBTSxDQUFDLE9BQU8sRUFDZCxFQUFFLFFBQVEsRUFBRSxFQUNaLE9BQU8saUJBQWlCLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFLEVBQ3JDLHlCQUF5QixFQUN6Qix3QkFBd0IsQ0FDekIsQ0FBQztBQUNKLENBQUM7QUFFTSxLQUFLLFVBQVUsWUFBWSxDQUFDLFFBQWdCO0lBQ2pELE1BQU0sSUFBQSw0QkFBVSxFQUFDLHdCQUFNLENBQUMsT0FBTyxFQUFFLEVBQUUsUUFBUSxFQUFFLENBQUMsQ0FBQztBQUNqRCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiLy8gRGV2aWNlcyBUYWJsZSBEYXRhIEFjY2VzcyBMYXllclxuLy8gUmVxdWlyZW1lbnRzOiA3LjIsIDguMSwgOC40XG5cbmltcG9ydCB7IEhlYWx0aERldmljZSwgRGV2aWNlU3RhdHVzIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgVEFCTEVTLCBwdXRJdGVtLCBnZXRJdGVtLCBxdWVyeUl0ZW1zLCB1cGRhdGVJdGVtLCBkZWxldGVJdGVtIH0gZnJvbSAnLi4vZHluYW1vZGItY2xpZW50JztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gRGV2aWNlIE9wZXJhdGlvbnNcbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHJlZ2lzdGVyRGV2aWNlKGRldmljZTogSGVhbHRoRGV2aWNlKTogUHJvbWlzZTx2b2lkPiB7XG4gIGF3YWl0IHB1dEl0ZW0oVEFCTEVTLkRFVklDRVMsIHtcbiAgICBkZXZpY2VJZDogZGV2aWNlLmlkLFxuICAgIHVzZXJJZDogZGV2aWNlLnVzZXJJZCxcbiAgICB0eXBlOiBkZXZpY2UudHlwZSxcbiAgICBtYW51ZmFjdHVyZXI6IGRldmljZS5tYW51ZmFjdHVyZXIsXG4gICAgbW9kZWw6IGRldmljZS5tb2RlbCxcbiAgICBjYXBhYmlsaXRpZXM6IGRldmljZS5jYXBhYmlsaXRpZXMsXG4gICAgY29ubmVjdGlvblR5cGU6IGRldmljZS5jb25uZWN0aW9uVHlwZSxcbiAgICBzdGF0dXM6IGRldmljZS5zdGF0dXMsXG4gICAgbGFzdFN5bmM6IGRldmljZS5sYXN0U3luYz8udG9JU09TdHJpbmcoKSxcbiAgICBiYXR0ZXJ5TGV2ZWw6IGRldmljZS5iYXR0ZXJ5TGV2ZWwsXG4gICAgZmlybXdhcmVWZXJzaW9uOiBkZXZpY2UuZmlybXdhcmVWZXJzaW9uLFxuICB9KTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldERldmljZShkZXZpY2VJZDogc3RyaW5nKTogUHJvbWlzZTxIZWFsdGhEZXZpY2UgfCBudWxsPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGdldEl0ZW08SGVhbHRoRGV2aWNlPihUQUJMRVMuREVWSUNFUywgeyBkZXZpY2VJZCB9KTtcblxuICBpZiAoIXJlc3VsdCkgcmV0dXJuIG51bGw7XG5cbiAgcmV0dXJuIHtcbiAgICAuLi5yZXN1bHQsXG4gICAgbGFzdFN5bmM6IHJlc3VsdC5sYXN0U3luYyA/IG5ldyBEYXRlKHJlc3VsdC5sYXN0U3luYykgOiB1bmRlZmluZWQsXG4gIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXREZXZpY2VzQnlVc2VyKHVzZXJJZDogc3RyaW5nKTogUHJvbWlzZTxIZWFsdGhEZXZpY2VbXT4ge1xuICBjb25zdCByZXN1bHRzID0gYXdhaXQgcXVlcnlJdGVtczxIZWFsdGhEZXZpY2U+KFxuICAgIFRBQkxFUy5ERVZJQ0VTLFxuICAgICd1c2VySWQgPSA6dXNlcklkJyxcbiAgICB7ICc6dXNlcklkJzogdXNlcklkIH0sXG4gICAgJ3VzZXJJZC1pbmRleCdcbiAgKTtcblxuICByZXR1cm4gcmVzdWx0cy5tYXAoKGRldmljZSkgPT4gKHtcbiAgICAuLi5kZXZpY2UsXG4gICAgbGFzdFN5bmM6IGRldmljZS5sYXN0U3luYyA/IG5ldyBEYXRlKGRldmljZS5sYXN0U3luYykgOiB1bmRlZmluZWQsXG4gIH0pKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURldmljZVN0YXR1cyhcbiAgZGV2aWNlSWQ6IHN0cmluZyxcbiAgc3RhdHVzOiBEZXZpY2VTdGF0dXMsXG4gIGxhc3RTeW5jPzogRGF0ZVxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IHVwZGF0ZUV4cHJlc3Npb25zID0gWycjc3RhdHVzID0gOnN0YXR1cyddO1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPiA9IHsgJzpzdGF0dXMnOiBzdGF0dXMgfTtcbiAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+ID0geyAnI3N0YXR1cyc6ICdzdGF0dXMnIH07XG5cbiAgaWYgKGxhc3RTeW5jKSB7XG4gICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaCgnbGFzdFN5bmMgPSA6bGFzdFN5bmMnKTtcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6bGFzdFN5bmMnXSA9IGxhc3RTeW5jLnRvSVNPU3RyaW5nKCk7XG4gIH1cblxuICBhd2FpdCB1cGRhdGVJdGVtKFxuICAgIFRBQkxFUy5ERVZJQ0VTLFxuICAgIHsgZGV2aWNlSWQgfSxcbiAgICBgU0VUICR7dXBkYXRlRXhwcmVzc2lvbnMuam9pbignLCAnKX1gLFxuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzXG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVEZXZpY2VCYXR0ZXJ5KFxuICBkZXZpY2VJZDogc3RyaW5nLFxuICBiYXR0ZXJ5TGV2ZWw6IG51bWJlclxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGF3YWl0IHVwZGF0ZUl0ZW0oXG4gICAgVEFCTEVTLkRFVklDRVMsXG4gICAgeyBkZXZpY2VJZCB9LFxuICAgICdTRVQgYmF0dGVyeUxldmVsID0gOmJhdHRlcnlMZXZlbCcsXG4gICAgeyAnOmJhdHRlcnlMZXZlbCc6IGJhdHRlcnlMZXZlbCB9XG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB1cGRhdGVEZXZpY2VTeW5jKGRldmljZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgYXdhaXQgdXBkYXRlSXRlbShcbiAgICBUQUJMRVMuREVWSUNFUyxcbiAgICB7IGRldmljZUlkIH0sXG4gICAgJ1NFVCBsYXN0U3luYyA9IDpsYXN0U3luYycsXG4gICAgeyAnOmxhc3RTeW5jJzogbmV3IERhdGUoKS50b0lTT1N0cmluZygpIH1cbiAgKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZURldmljZShcbiAgZGV2aWNlSWQ6IHN0cmluZyxcbiAgdXBkYXRlczogUGFydGlhbDxIZWFsdGhEZXZpY2U+XG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgdXBkYXRlRXhwcmVzc2lvbnM6IHN0cmluZ1tdID0gW107XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0ge307XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lczogUmVjb3JkPHN0cmluZywgc3RyaW5nPiA9IHt9O1xuXG4gIE9iamVjdC5lbnRyaWVzKHVwZGF0ZXMpLmZvckVhY2goKFtrZXksIHZhbHVlXSwgaW5kZXgpID0+IHtcbiAgICBpZiAoa2V5ID09PSAnaWQnIHx8IGtleSA9PT0gJ2RldmljZUlkJykgcmV0dXJuO1xuICAgIFxuICAgIGNvbnN0IGF0dHJOYW1lID0gYCNhdHRyJHtpbmRleH1gO1xuICAgIGNvbnN0IGF0dHJWYWx1ZSA9IGA6dmFsJHtpbmRleH1gO1xuICAgIHVwZGF0ZUV4cHJlc3Npb25zLnB1c2goYCR7YXR0ck5hbWV9ID0gJHthdHRyVmFsdWV9YCk7XG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZU5hbWVzW2F0dHJOYW1lXSA9IGtleTtcbiAgICBcbiAgICBpZiAoa2V5ID09PSAnbGFzdFN5bmMnICYmIHZhbHVlIGluc3RhbmNlb2YgRGF0ZSkge1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1thdHRyVmFsdWVdID0gdmFsdWUudG9JU09TdHJpbmcoKTtcbiAgICB9IGVsc2Uge1xuICAgICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlc1thdHRyVmFsdWVdID0gdmFsdWU7XG4gICAgfVxuICB9KTtcblxuICBpZiAodXBkYXRlRXhwcmVzc2lvbnMubGVuZ3RoID09PSAwKSByZXR1cm47XG5cbiAgYXdhaXQgdXBkYXRlSXRlbShcbiAgICBUQUJMRVMuREVWSUNFUyxcbiAgICB7IGRldmljZUlkIH0sXG4gICAgYFNFVCAke3VwZGF0ZUV4cHJlc3Npb25zLmpvaW4oJywgJyl9YCxcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lc1xuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlRGV2aWNlKGRldmljZUlkOiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgYXdhaXQgZGVsZXRlSXRlbShUQUJMRVMuREVWSUNFUywgeyBkZXZpY2VJZCB9KTtcbn1cbiJdfQ==