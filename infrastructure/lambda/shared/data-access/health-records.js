"use strict";
// Health Records Table Data Access Layer
// Requirements: 1.1, 8.1, 8.4
Object.defineProperty(exports, "__esModule", { value: true });
exports.createHealthRecord = createHealthRecord;
exports.getHealthRecord = getHealthRecord;
exports.getHealthRecordsByUser = getHealthRecordsByUser;
exports.getHealthRecordsByType = getHealthRecordsByType;
exports.deleteHealthRecord = deleteHealthRecord;
const dynamodb_client_1 = require("../dynamodb-client");
// ============================================================================
// Health Records Operations
// ============================================================================
async function createHealthRecord(record) {
    const id = `${record.userId}-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const healthRecord = {
        ...record,
        id,
        timestamp: record.timestamp || new Date(),
    };
    await (0, dynamodb_client_1.putItem)(dynamodb_client_1.TABLES.HEALTH_RECORDS, {
        userId: healthRecord.userId,
        timestamp: healthRecord.timestamp.toISOString(),
        id: healthRecord.id,
        type: healthRecord.type,
        data: healthRecord.data,
        source: healthRecord.source,
        verified: healthRecord.verified,
    });
    return id;
}
async function getHealthRecord(userId, timestamp) {
    return await (0, dynamodb_client_1.getItem)(dynamodb_client_1.TABLES.HEALTH_RECORDS, { userId, timestamp });
}
async function getHealthRecordsByUser(userId, startTime, endTime, limit) {
    let keyConditionExpression = 'userId = :userId';
    const expressionAttributeValues = { ':userId': userId };
    if (startTime && endTime) {
        keyConditionExpression += ' AND #timestamp BETWEEN :startTime AND :endTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
        expressionAttributeValues[':endTime'] = endTime.toISOString();
    }
    else if (startTime) {
        keyConditionExpression += ' AND #timestamp >= :startTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
    }
    else if (endTime) {
        keyConditionExpression += ' AND #timestamp <= :endTime';
        expressionAttributeValues[':endTime'] = endTime.toISOString();
    }
    const results = await (0, dynamodb_client_1.queryItems)(dynamodb_client_1.TABLES.HEALTH_RECORDS, keyConditionExpression, expressionAttributeValues, undefined, undefined, limit);
    return results.map((record) => ({
        ...record,
        timestamp: new Date(record.timestamp),
    }));
}
async function getHealthRecordsByType(type, startTime, endTime, limit) {
    let keyConditionExpression = '#type = :type';
    const expressionAttributeValues = { ':type': type };
    if (startTime && endTime) {
        keyConditionExpression += ' AND #timestamp BETWEEN :startTime AND :endTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
        expressionAttributeValues[':endTime'] = endTime.toISOString();
    }
    else if (startTime) {
        keyConditionExpression += ' AND #timestamp >= :startTime';
        expressionAttributeValues[':startTime'] = startTime.toISOString();
    }
    return await (0, dynamodb_client_1.queryItems)(dynamodb_client_1.TABLES.HEALTH_RECORDS, keyConditionExpression, expressionAttributeValues, 'type-timestamp-index', undefined, limit);
}
async function deleteHealthRecord(userId, timestamp) {
    await (0, dynamodb_client_1.deleteItem)(dynamodb_client_1.TABLES.HEALTH_RECORDS, { userId, timestamp });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaGVhbHRoLXJlY29yZHMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJoZWFsdGgtcmVjb3Jkcy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEseUNBQXlDO0FBQ3pDLDhCQUE4Qjs7QUFTOUIsZ0RBbUJDO0FBRUQsMENBS0M7QUFFRCx3REFrQ0M7QUFFRCx3REEwQkM7QUFFRCxnREFFQztBQXBHRCx3REFBc0Y7QUFFdEYsK0VBQStFO0FBQy9FLDRCQUE0QjtBQUM1QiwrRUFBK0U7QUFFeEUsS0FBSyxVQUFVLGtCQUFrQixDQUFDLE1BQWdDO0lBQ3ZFLE1BQU0sRUFBRSxHQUFHLEdBQUcsTUFBTSxDQUFDLE1BQU0sSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLElBQUksSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLFFBQVEsQ0FBQyxFQUFFLENBQUMsQ0FBQyxNQUFNLENBQUMsQ0FBQyxFQUFFLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDdkYsTUFBTSxZQUFZLEdBQWlCO1FBQ2pDLEdBQUcsTUFBTTtRQUNULEVBQUU7UUFDRixTQUFTLEVBQUUsTUFBTSxDQUFDLFNBQVMsSUFBSSxJQUFJLElBQUksRUFBRTtLQUMxQyxDQUFDO0lBRUYsTUFBTSxJQUFBLHlCQUFPLEVBQUMsd0JBQU0sQ0FBQyxjQUFjLEVBQUU7UUFDbkMsTUFBTSxFQUFFLFlBQVksQ0FBQyxNQUFNO1FBQzNCLFNBQVMsRUFBRSxZQUFZLENBQUMsU0FBUyxDQUFDLFdBQVcsRUFBRTtRQUMvQyxFQUFFLEVBQUUsWUFBWSxDQUFDLEVBQUU7UUFDbkIsSUFBSSxFQUFFLFlBQVksQ0FBQyxJQUFJO1FBQ3ZCLElBQUksRUFBRSxZQUFZLENBQUMsSUFBSTtRQUN2QixNQUFNLEVBQUUsWUFBWSxDQUFDLE1BQU07UUFDM0IsUUFBUSxFQUFFLFlBQVksQ0FBQyxRQUFRO0tBQ2hDLENBQUMsQ0FBQztJQUVILE9BQU8sRUFBRSxDQUFDO0FBQ1osQ0FBQztBQUVNLEtBQUssVUFBVSxlQUFlLENBQ25DLE1BQWMsRUFDZCxTQUFpQjtJQUVqQixPQUFPLE1BQU0sSUFBQSx5QkFBTyxFQUFlLHdCQUFNLENBQUMsY0FBYyxFQUFFLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7QUFDbkYsQ0FBQztBQUVNLEtBQUssVUFBVSxzQkFBc0IsQ0FDMUMsTUFBYyxFQUNkLFNBQWdCLEVBQ2hCLE9BQWMsRUFDZCxLQUFjO0lBRWQsSUFBSSxzQkFBc0IsR0FBRyxrQkFBa0IsQ0FBQztJQUNoRCxNQUFNLHlCQUF5QixHQUE0QixFQUFFLFNBQVMsRUFBRSxNQUFNLEVBQUUsQ0FBQztJQUVqRixJQUFJLFNBQVMsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUN6QixzQkFBc0IsSUFBSSxpREFBaUQsQ0FBQztRQUM1RSx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsR0FBRyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbEUseUJBQXlCLENBQUMsVUFBVSxDQUFDLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2hFLENBQUM7U0FBTSxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQ3JCLHNCQUFzQixJQUFJLCtCQUErQixDQUFDO1FBQzFELHlCQUF5QixDQUFDLFlBQVksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNwRSxDQUFDO1NBQU0sSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUNuQixzQkFBc0IsSUFBSSw2QkFBNkIsQ0FBQztRQUN4RCx5QkFBeUIsQ0FBQyxVQUFVLENBQUMsR0FBRyxPQUFPLENBQUMsV0FBVyxFQUFFLENBQUM7SUFDaEUsQ0FBQztJQUVELE1BQU0sT0FBTyxHQUFHLE1BQU0sSUFBQSw0QkFBVSxFQUM5Qix3QkFBTSxDQUFDLGNBQWMsRUFDckIsc0JBQXNCLEVBQ3RCLHlCQUF5QixFQUN6QixTQUFTLEVBQ1QsU0FBUyxFQUNULEtBQUssQ0FDTixDQUFDO0lBRUYsT0FBTyxPQUFPLENBQUMsR0FBRyxDQUFDLENBQUMsTUFBTSxFQUFFLEVBQUUsQ0FBQyxDQUFDO1FBQzlCLEdBQUcsTUFBTTtRQUNULFNBQVMsRUFBRSxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDO0tBQ3RDLENBQUMsQ0FBQyxDQUFDO0FBQ04sQ0FBQztBQUVNLEtBQUssVUFBVSxzQkFBc0IsQ0FDMUMsSUFBc0IsRUFDdEIsU0FBZ0IsRUFDaEIsT0FBYyxFQUNkLEtBQWM7SUFFZCxJQUFJLHNCQUFzQixHQUFHLGVBQWUsQ0FBQztJQUM3QyxNQUFNLHlCQUF5QixHQUE0QixFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsQ0FBQztJQUU3RSxJQUFJLFNBQVMsSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUN6QixzQkFBc0IsSUFBSSxpREFBaUQsQ0FBQztRQUM1RSx5QkFBeUIsQ0FBQyxZQUFZLENBQUMsR0FBRyxTQUFTLENBQUMsV0FBVyxFQUFFLENBQUM7UUFDbEUseUJBQXlCLENBQUMsVUFBVSxDQUFDLEdBQUcsT0FBTyxDQUFDLFdBQVcsRUFBRSxDQUFDO0lBQ2hFLENBQUM7U0FBTSxJQUFJLFNBQVMsRUFBRSxDQUFDO1FBQ3JCLHNCQUFzQixJQUFJLCtCQUErQixDQUFDO1FBQzFELHlCQUF5QixDQUFDLFlBQVksQ0FBQyxHQUFHLFNBQVMsQ0FBQyxXQUFXLEVBQUUsQ0FBQztJQUNwRSxDQUFDO0lBRUQsT0FBTyxNQUFNLElBQUEsNEJBQVUsRUFDckIsd0JBQU0sQ0FBQyxjQUFjLEVBQ3JCLHNCQUFzQixFQUN0Qix5QkFBeUIsRUFDekIsc0JBQXNCLEVBQ3RCLFNBQVMsRUFDVCxLQUFLLENBQ04sQ0FBQztBQUNKLENBQUM7QUFFTSxLQUFLLFVBQVUsa0JBQWtCLENBQUMsTUFBYyxFQUFFLFNBQWlCO0lBQ3hFLE1BQU0sSUFBQSw0QkFBVSxFQUFDLHdCQUFNLENBQUMsY0FBYyxFQUFFLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDLENBQUM7QUFDakUsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIEhlYWx0aCBSZWNvcmRzIFRhYmxlIERhdGEgQWNjZXNzIExheWVyXG4vLyBSZXF1aXJlbWVudHM6IDEuMSwgOC4xLCA4LjRcblxuaW1wb3J0IHsgSGVhbHRoUmVjb3JkLCBIZWFsdGhSZWNvcmRUeXBlIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgVEFCTEVTLCBwdXRJdGVtLCBnZXRJdGVtLCBxdWVyeUl0ZW1zLCBkZWxldGVJdGVtIH0gZnJvbSAnLi4vZHluYW1vZGItY2xpZW50JztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gSGVhbHRoIFJlY29yZHMgT3BlcmF0aW9uc1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gY3JlYXRlSGVhbHRoUmVjb3JkKHJlY29yZDogT21pdDxIZWFsdGhSZWNvcmQsICdpZCc+KTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgY29uc3QgaWQgPSBgJHtyZWNvcmQudXNlcklkfS0ke0RhdGUubm93KCl9LSR7TWF0aC5yYW5kb20oKS50b1N0cmluZygzNikuc3Vic3RyKDIsIDkpfWA7XG4gIGNvbnN0IGhlYWx0aFJlY29yZDogSGVhbHRoUmVjb3JkID0ge1xuICAgIC4uLnJlY29yZCxcbiAgICBpZCxcbiAgICB0aW1lc3RhbXA6IHJlY29yZC50aW1lc3RhbXAgfHwgbmV3IERhdGUoKSxcbiAgfTtcblxuICBhd2FpdCBwdXRJdGVtKFRBQkxFUy5IRUFMVEhfUkVDT1JEUywge1xuICAgIHVzZXJJZDogaGVhbHRoUmVjb3JkLnVzZXJJZCxcbiAgICB0aW1lc3RhbXA6IGhlYWx0aFJlY29yZC50aW1lc3RhbXAudG9JU09TdHJpbmcoKSxcbiAgICBpZDogaGVhbHRoUmVjb3JkLmlkLFxuICAgIHR5cGU6IGhlYWx0aFJlY29yZC50eXBlLFxuICAgIGRhdGE6IGhlYWx0aFJlY29yZC5kYXRhLFxuICAgIHNvdXJjZTogaGVhbHRoUmVjb3JkLnNvdXJjZSxcbiAgICB2ZXJpZmllZDogaGVhbHRoUmVjb3JkLnZlcmlmaWVkLFxuICB9KTtcblxuICByZXR1cm4gaWQ7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRIZWFsdGhSZWNvcmQoXG4gIHVzZXJJZDogc3RyaW5nLFxuICB0aW1lc3RhbXA6IHN0cmluZ1xuKTogUHJvbWlzZTxIZWFsdGhSZWNvcmQgfCBudWxsPiB7XG4gIHJldHVybiBhd2FpdCBnZXRJdGVtPEhlYWx0aFJlY29yZD4oVEFCTEVTLkhFQUxUSF9SRUNPUkRTLCB7IHVzZXJJZCwgdGltZXN0YW1wIH0pO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZ2V0SGVhbHRoUmVjb3Jkc0J5VXNlcihcbiAgdXNlcklkOiBzdHJpbmcsXG4gIHN0YXJ0VGltZT86IERhdGUsXG4gIGVuZFRpbWU/OiBEYXRlLFxuICBsaW1pdD86IG51bWJlclxuKTogUHJvbWlzZTxIZWFsdGhSZWNvcmRbXT4ge1xuICBsZXQga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiA9ICd1c2VySWQgPSA6dXNlcklkJztcbiAgY29uc3QgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4gPSB7ICc6dXNlcklkJzogdXNlcklkIH07XG5cbiAgaWYgKHN0YXJ0VGltZSAmJiBlbmRUaW1lKSB7XG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUnO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpzdGFydFRpbWUnXSA9IHN0YXJ0VGltZS50b0lTT1N0cmluZygpO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzplbmRUaW1lJ10gPSBlbmRUaW1lLnRvSVNPU3RyaW5nKCk7XG4gIH0gZWxzZSBpZiAoc3RhcnRUaW1lKSB7XG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wID49IDpzdGFydFRpbWUnO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpzdGFydFRpbWUnXSA9IHN0YXJ0VGltZS50b0lTT1N0cmluZygpO1xuICB9IGVsc2UgaWYgKGVuZFRpbWUpIHtcbiAgICBrZXlDb25kaXRpb25FeHByZXNzaW9uICs9ICcgQU5EICN0aW1lc3RhbXAgPD0gOmVuZFRpbWUnO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzplbmRUaW1lJ10gPSBlbmRUaW1lLnRvSVNPU3RyaW5nKCk7XG4gIH1cblxuICBjb25zdCByZXN1bHRzID0gYXdhaXQgcXVlcnlJdGVtczxIZWFsdGhSZWNvcmQ+KFxuICAgIFRBQkxFUy5IRUFMVEhfUkVDT1JEUyxcbiAgICBrZXlDb25kaXRpb25FeHByZXNzaW9uLFxuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgdW5kZWZpbmVkLFxuICAgIHVuZGVmaW5lZCxcbiAgICBsaW1pdFxuICApO1xuXG4gIHJldHVybiByZXN1bHRzLm1hcCgocmVjb3JkKSA9PiAoe1xuICAgIC4uLnJlY29yZCxcbiAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKHJlY29yZC50aW1lc3RhbXApLFxuICB9KSk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRIZWFsdGhSZWNvcmRzQnlUeXBlKFxuICB0eXBlOiBIZWFsdGhSZWNvcmRUeXBlLFxuICBzdGFydFRpbWU/OiBEYXRlLFxuICBlbmRUaW1lPzogRGF0ZSxcbiAgbGltaXQ/OiBudW1iZXJcbik6IFByb21pc2U8SGVhbHRoUmVjb3JkW10+IHtcbiAgbGV0IGtleUNvbmRpdGlvbkV4cHJlc3Npb24gPSAnI3R5cGUgPSA6dHlwZSc7XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0geyAnOnR5cGUnOiB0eXBlIH07XG5cbiAgaWYgKHN0YXJ0VGltZSAmJiBlbmRUaW1lKSB7XG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wIEJFVFdFRU4gOnN0YXJ0VGltZSBBTkQgOmVuZFRpbWUnO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpzdGFydFRpbWUnXSA9IHN0YXJ0VGltZS50b0lTT1N0cmluZygpO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzplbmRUaW1lJ10gPSBlbmRUaW1lLnRvSVNPU3RyaW5nKCk7XG4gIH0gZWxzZSBpZiAoc3RhcnRUaW1lKSB7XG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbiArPSAnIEFORCAjdGltZXN0YW1wID49IDpzdGFydFRpbWUnO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzpzdGFydFRpbWUnXSA9IHN0YXJ0VGltZS50b0lTT1N0cmluZygpO1xuICB9XG5cbiAgcmV0dXJuIGF3YWl0IHF1ZXJ5SXRlbXM8SGVhbHRoUmVjb3JkPihcbiAgICBUQUJMRVMuSEVBTFRIX1JFQ09SRFMsXG4gICAga2V5Q29uZGl0aW9uRXhwcmVzc2lvbixcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzLFxuICAgICd0eXBlLXRpbWVzdGFtcC1pbmRleCcsXG4gICAgdW5kZWZpbmVkLFxuICAgIGxpbWl0XG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBkZWxldGVIZWFsdGhSZWNvcmQodXNlcklkOiBzdHJpbmcsIHRpbWVzdGFtcDogc3RyaW5nKTogUHJvbWlzZTx2b2lkPiB7XG4gIGF3YWl0IGRlbGV0ZUl0ZW0oVEFCTEVTLkhFQUxUSF9SRUNPUkRTLCB7IHVzZXJJZCwgdGltZXN0YW1wIH0pO1xufVxuIl19