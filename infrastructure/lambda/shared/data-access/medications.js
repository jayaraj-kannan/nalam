"use strict";
// Medications Table Data Access Layer
// Requirements: 2.4, 8.1, 8.4
Object.defineProperty(exports, "__esModule", { value: true });
exports.createMedicationRecord = createMedicationRecord;
exports.getMedicationRecord = getMedicationRecord;
exports.getMedicationsByUser = getMedicationsByUser;
exports.updateMedicationStatus = updateMedicationStatus;
exports.updateAdherenceScore = updateAdherenceScore;
exports.deleteMedicationRecord = deleteMedicationRecord;
const dynamodb_client_1 = require("../dynamodb-client");
// ============================================================================
// Medication Operations
// ============================================================================
async function createMedicationRecord(record) {
    const medicationId = `med-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
    const medicationRecord = {
        ...record,
        id: medicationId,
    };
    await (0, dynamodb_client_1.putItem)(dynamodb_client_1.TABLES.MEDICATIONS, {
        userId: medicationRecord.userId,
        medicationId,
        medication: medicationRecord.medication,
        scheduledTime: medicationRecord.scheduledTime.toISOString(),
        takenTime: medicationRecord.takenTime?.toISOString(),
        status: medicationRecord.status,
        adherenceScore: medicationRecord.adherenceScore,
        notes: medicationRecord.notes,
    });
    return medicationId;
}
async function getMedicationRecord(userId, medicationId) {
    const result = await (0, dynamodb_client_1.getItem)(dynamodb_client_1.TABLES.MEDICATIONS, {
        userId,
        medicationId,
    });
    if (!result)
        return null;
    return {
        ...result,
        scheduledTime: new Date(result.scheduledTime),
        takenTime: result.takenTime ? new Date(result.takenTime) : undefined,
    };
}
async function getMedicationsByUser(userId, limit) {
    const results = await (0, dynamodb_client_1.queryItems)(dynamodb_client_1.TABLES.MEDICATIONS, 'userId = :userId', { ':userId': userId }, undefined, undefined, limit);
    return results.map((record) => ({
        ...record,
        scheduledTime: new Date(record.scheduledTime),
        takenTime: record.takenTime ? new Date(record.takenTime) : undefined,
    }));
}
async function updateMedicationStatus(userId, medicationId, status, takenTime, notes) {
    const updateExpressions = ['#status = :status'];
    const expressionAttributeValues = { ':status': status };
    const expressionAttributeNames = { '#status': 'status' };
    if (takenTime) {
        updateExpressions.push('takenTime = :takenTime');
        expressionAttributeValues[':takenTime'] = takenTime.toISOString();
    }
    if (notes) {
        updateExpressions.push('notes = :notes');
        expressionAttributeValues[':notes'] = notes;
    }
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.MEDICATIONS, { userId, medicationId }, `SET ${updateExpressions.join(', ')}`, expressionAttributeValues, expressionAttributeNames);
}
async function updateAdherenceScore(userId, medicationId, adherenceScore) {
    await (0, dynamodb_client_1.updateItem)(dynamodb_client_1.TABLES.MEDICATIONS, { userId, medicationId }, 'SET adherenceScore = :adherenceScore', { ':adherenceScore': adherenceScore });
}
async function deleteMedicationRecord(userId, medicationId) {
    await (0, dynamodb_client_1.deleteItem)(dynamodb_client_1.TABLES.MEDICATIONS, { userId, medicationId });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibWVkaWNhdGlvbnMuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJtZWRpY2F0aW9ucy50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiO0FBQUEsc0NBQXNDO0FBQ3RDLDhCQUE4Qjs7QUFTOUIsd0RBcUJDO0FBRUQsa0RBZ0JDO0FBRUQsb0RBa0JDO0FBRUQsd0RBNEJDO0FBRUQsb0RBV0M7QUFFRCx3REFLQztBQW5IRCx3REFBa0c7QUFFbEcsK0VBQStFO0FBQy9FLHdCQUF3QjtBQUN4QiwrRUFBK0U7QUFFeEUsS0FBSyxVQUFVLHNCQUFzQixDQUMxQyxNQUFvQztJQUVwQyxNQUFNLFlBQVksR0FBRyxPQUFPLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsQ0FBQztJQUNwRixNQUFNLGdCQUFnQixHQUFxQjtRQUN6QyxHQUFHLE1BQU07UUFDVCxFQUFFLEVBQUUsWUFBWTtLQUNqQixDQUFDO0lBRUYsTUFBTSxJQUFBLHlCQUFPLEVBQUMsd0JBQU0sQ0FBQyxXQUFXLEVBQUU7UUFDaEMsTUFBTSxFQUFFLGdCQUFnQixDQUFDLE1BQU07UUFDL0IsWUFBWTtRQUNaLFVBQVUsRUFBRSxnQkFBZ0IsQ0FBQyxVQUFVO1FBQ3ZDLGFBQWEsRUFBRSxnQkFBZ0IsQ0FBQyxhQUFhLENBQUMsV0FBVyxFQUFFO1FBQzNELFNBQVMsRUFBRSxnQkFBZ0IsQ0FBQyxTQUFTLEVBQUUsV0FBVyxFQUFFO1FBQ3BELE1BQU0sRUFBRSxnQkFBZ0IsQ0FBQyxNQUFNO1FBQy9CLGNBQWMsRUFBRSxnQkFBZ0IsQ0FBQyxjQUFjO1FBQy9DLEtBQUssRUFBRSxnQkFBZ0IsQ0FBQyxLQUFLO0tBQzlCLENBQUMsQ0FBQztJQUVILE9BQU8sWUFBWSxDQUFDO0FBQ3RCLENBQUM7QUFFTSxLQUFLLFVBQVUsbUJBQW1CLENBQ3ZDLE1BQWMs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bnRlbnQiOlsiLy8gTWVkaWNhdGlvbnMgVGFibGUgRGF0YSBBY2Nlc3MgTGF5ZXJcbi8vIFJlcXVpcmVtZW50czogMi40LCA4LjEsIDguNFxuXG5pbXBvcnQgeyBNZWRpY2F0aW9uUmVjb3JkLCBNZWRpY2F0aW9uU3RhdHVzIH0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgVEFCTEVTLCBwdXRJdGVtLCBnZXRJdGVtLCBxdWVyeUl0ZW1zLCB1cGRhdGVJdGVtLCBkZWxldGVJdGVtIH0gZnJvbSAnLi4vZHluYW1vZGItY2xpZW50JztcblxuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuLy8gTWVkaWNhdGlvbiBPcGVyYXRpb25zXG4vLyA9PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBjcmVhdGVNZWRpY2F0aW9uUmVjb3JkKFxuICByZWNvcmQ6IE9taXQ8TWVkaWNhdGlvblJlY29yZCwgJ2lkJz5cbik6IFByb21pc2U8c3RyaW5nPiB7XG4gIGNvbnN0IG1lZGljYXRpb25JZCA9IGBtZWQtJHtEYXRlLm5vdygpfS0ke01hdGgucmFuZG9tKCkudG9TdHJpbmcoMzYpLnN1YnN0cigyLCA5KX1gO1xuICBjb25zdCBtZWRpY2F0aW9uUmVjb3JkOiBNZWRpY2F0aW9uUmVjb3JkID0ge1xuICAgIC4uLnJlY29yZCxcbiAgICBpZDogbWVkaWNhdGlvbklkLFxuICB9O1xuXG4gIGF3YWl0IHB1dEl0ZW0oVEFCTEVTLk1FRElDQVRJT05TLCB7XG4gICAgdXNlcklkOiBtZWRpY2F0aW9uUmVjb3JkLnVzZXJJZCxcbiAgICBtZWRpY2F0aW9uSWQsXG4gICAgbWVkaWNhdGlvbjogbWVkaWNhdGlvblJlY29yZC5tZWRpY2F0aW9uLFxuICAgIHNjaGVkdWxlZFRpbWU6IG1lZGljYXRpb25SZWNvcmQuc2NoZWR1bGVkVGltZS50b0lTT1N0cmluZygpLFxuICAgIHRha2VuVGltZTogbWVkaWNhdGlvblJlY29yZC50YWtlblRpbWU/LnRvSVNPU3RyaW5nKCksXG4gICAgc3RhdHVzOiBtZWRpY2F0aW9uUmVjb3JkLnN0YXR1cyxcbiAgICBhZGhlcmVuY2VTY29yZTogbWVkaWNhdGlvblJlY29yZC5hZGhlcmVuY2VTY29yZSxcbiAgICBub3RlczogbWVkaWNhdGlvblJlY29yZC5ub3RlcyxcbiAgfSk7XG5cbiAgcmV0dXJuIG1lZGljYXRpb25JZDtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldE1lZGljYXRpb25SZWNvcmQoXG4gIHVzZXJJZDogc3RyaW5nLFxuICBtZWRpY2F0aW9uSWQ6IHN0cmluZ1xuKTogUHJvbWlzZTxNZWRpY2F0aW9uUmVjb3JkIHwgbnVsbD4ge1xuICBjb25zdCByZXN1bHQgPSBhd2FpdCBnZXRJdGVtPE1lZGljYXRpb25SZWNvcmQ+KFRBQkxFUy5NRURJQ0FUSU9OUywge1xuICAgIHVzZXJJZCxcbiAgICBtZWRpY2F0aW9uSWQsXG4gIH0pO1xuXG4gIGlmICghcmVzdWx0KSByZXR1cm4gbnVsbDtcblxuICByZXR1cm4ge1xuICAgIC4uLnJlc3VsdCxcbiAgICBzY2hlZHVsZWRUaW1lOiBuZXcgRGF0ZShyZXN1bHQuc2NoZWR1bGVkVGltZSksXG4gICAgdGFrZW5UaW1lOiByZXN1bHQudGFrZW5UaW1lID8gbmV3IERhdGUocmVzdWx0LnRha2VuVGltZSkgOiB1bmRlZmluZWQsXG4gIH07XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBnZXRNZWRpY2F0aW9uc0J5VXNlcihcbiAgdXNlcklkOiBzdHJpbmcsXG4gIGxpbWl0PzogbnVtYmVyXG4pOiBQcm9taXNlPE1lZGljYXRpb25SZWNvcmRbXT4ge1xuICBjb25zdCByZXN1bHRzID0gYXdhaXQgcXVlcnlJdGVtczxNZWRpY2F0aW9uUmVjb3JkPihcbiAgICBUQUJMRVMuTUVESUNBVElPTlMsXG4gICAgJ3VzZXJJZCA9IDp1c2VySWQnLFxuICAgIHsgJzp1c2VySWQnOiB1c2VySWQgfSxcbiAgICB1bmRlZmluZWQsXG4gICAgdW5kZWZpbmVkLFxuICAgIGxpbWl0XG4gICk7XG5cbiAgcmV0dXJuIHJlc3VsdHMubWFwKChyZWNvcmQpID0+ICh7XG4gICAgLi4ucmVjb3JkLFxuICAgIHNjaGVkdWxlZFRpbWU6IG5ldyBEYXRlKHJlY29yZC5zY2hlZHVsZWRUaW1lKSxcbiAgICB0YWtlblRpbWU6IHJlY29yZC50YWtlblRpbWUgPyBuZXcgRGF0ZShyZWNvcmQudGFrZW5UaW1lKSA6IHVuZGVmaW5lZCxcbiAgfSkpO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlTWVkaWNhdGlvblN0YXR1cyhcbiAgdXNlcklkOiBzdHJpbmcsXG4gIG1lZGljYXRpb25JZDogc3RyaW5nLFxuICBzdGF0dXM6IE1lZGljYXRpb25TdGF0dXMsXG4gIHRha2VuVGltZT86IERhdGUsXG4gIG5vdGVzPzogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgdXBkYXRlRXhwcmVzc2lvbnMgPSBbJyNzdGF0dXMgPSA6c3RhdHVzJ107XG4gIGNvbnN0IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IFJlY29yZDxzdHJpbmcsIHVua25vd24+ID0geyAnOnN0YXR1cyc6IHN0YXR1cyB9O1xuICBjb25zdCBleHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7ICcjc3RhdHVzJzogJ3N0YXR1cycgfTtcblxuICBpZiAodGFrZW5UaW1lKSB7XG4gICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaCgndGFrZW5UaW1lID0gOnRha2VuVGltZScpO1xuICAgIGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXNbJzp0YWtlblRpbWUnXSA9IHRha2VuVGltZS50b0lTT1N0cmluZygpO1xuICB9XG5cbiAgaWYgKG5vdGVzKSB7XG4gICAgdXBkYXRlRXhwcmVzc2lvbnMucHVzaCgnbm90ZXMgPSA6bm90ZXMnKTtcbiAgICBleHByZXNzaW9uQXR0cmlidXRlVmFsdWVzWyc6bm90ZXMnXSA9IG5vdGVzO1xuICB9XG5cbiAgYXdhaXQgdXBkYXRlSXRlbShcbiAgICBUQUJMRVMuTUVESUNBVElPTlMsXG4gICAgeyB1c2VySWQsIG1lZGljYXRpb25JZCB9LFxuICAgIGBTRVQgJHt1cGRhdGVFeHByZXNzaW9ucy5qb2luKCcsICcpfWAsXG4gICAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICBleHByZXNzaW9uQXR0cmlidXRlTmFtZXNcbiAgKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHVwZGF0ZUFkaGVyZW5jZVNjb3JlKFxuICB1c2VySWQ6IHN0cmluZyxcbiAgbWVkaWNhdGlvbklkOiBzdHJpbmcsXG4gIGFkaGVyZW5jZVNjb3JlOiBudW1iZXJcbik6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCB1cGRhdGVJdGVtKFxuICAgIFRBQkxFUy5NRURJQ0FUSU9OUyxcbiAgICB7IHVzZXJJZCwgbWVkaWNhdGlvbklkIH0sXG4gICAgJ1NFVCBhZGhlcmVuY2VTY29yZSA9IDphZGhlcmVuY2VTY29yZScsXG4gICAgeyAnOmFkaGVyZW5jZVNjb3JlJzogYWRoZXJlbmNlU2NvcmUgfVxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlTWVkaWNhdGlvblJlY29yZChcbiAgdXNlcklkOiBzdHJpbmcsXG4gIG1lZGljYXRpb25JZDogc3RyaW5nXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgYXdhaXQgZGVsZXRlSXRlbShUQUJMRVMuTUVESUNBVElPTlMsIHsgdXNlcklkLCBtZWRpY2F0aW9uSWQgfSk7XG59XG4iXX0=