"use strict";
// DynamoDB Data Access Layer with encryption at rest
// Requirements: 8.1, 8.4
Object.defineProperty(exports, "__esModule", { value: true });
exports.TABLES = exports.docClient = void 0;
exports.putItem = putItem;
exports.getItem = getItem;
exports.queryItems = queryItems;
exports.updateItem = updateItem;
exports.deleteItem = deleteItem;
exports.batchWriteItems = batchWriteItems;
exports.batchGetItems = batchGetItems;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
// Initialize DynamoDB client with encryption
const client = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'us-east-1',
});
// Create document client for easier data manipulation
exports.docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client, {
    marshallOptions: {
        removeUndefinedValues: true,
        convertClassInstanceToMap: true,
    },
    unmarshallOptions: {
        wrapNumbers: false,
    },
});
// Table names from environment variables
exports.TABLES = {
    USERS: process.env.USERS_TABLE || '',
    HEALTH_RECORDS: process.env.HEALTH_RECORDS_TABLE || '',
    MEDICATIONS: process.env.MEDICATIONS_TABLE || '',
    APPOINTMENTS: process.env.APPOINTMENTS_TABLE || '',
    ALERTS: process.env.ALERTS_TABLE || '',
    CARE_CIRCLE: process.env.CARE_CIRCLE_TABLE || '',
    CARE_CIRCLE_INVITATIONS: process.env.CARE_CIRCLE_INVITATIONS_TABLE || '',
    CARE_CIRCLE_MESSAGES: process.env.CARE_CIRCLE_MESSAGES_TABLE || '',
    DEVICES: process.env.DEVICES_TABLE || '',
};
// ============================================================================
// Generic DynamoDB Operations
// ============================================================================
async function putItem(tableName, item) {
    await exports.docClient.send(new lib_dynamodb_1.PutCommand({
        TableName: tableName,
        Item: item,
    }));
}
async function getItem(tableName, key) {
    const result = await exports.docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: tableName,
        Key: key,
    }));
    return result.Item || null;
}
async function queryItems(tableName, keyConditionExpression, expressionAttributeValues, indexName, filterExpression, limit) {
    const result = await exports.docClient.send(new lib_dynamodb_1.QueryCommand({
        TableName: tableName,
        KeyConditionExpression: keyConditionExpression,
        ExpressionAttributeValues: expressionAttributeValues,
        IndexName: indexName,
        FilterExpression: filterExpression,
        Limit: limit,
    }));
    return result.Items || [];
}
async function updateItem(tableName, key, updateExpression, expressionAttributeValues, expressionAttributeNames) {
    await exports.docClient.send(new lib_dynamodb_1.UpdateCommand({
        TableName: tableName,
        Key: key,
        UpdateExpression: updateExpression,
        ExpressionAttributeValues: expressionAttributeValues,
        ExpressionAttributeNames: expressionAttributeNames,
    }));
}
async function deleteItem(tableName, key) {
    await exports.docClient.send(new lib_dynamodb_1.DeleteCommand({
        TableName: tableName,
        Key: key,
    }));
}
async function batchWriteItems(tableName, items) {
    const batches = [];
    for (let i = 0; i < items.length; i += 25) {
        batches.push(items.slice(i, i + 25));
    }
    for (const batch of batches) {
        await exports.docClient.send(new lib_dynamodb_1.BatchWriteCommand({
            RequestItems: {
                [tableName]: batch.map((item) => ({
                    PutRequest: { Item: item },
                })),
            },
        }));
    }
}
async function batchGetItems(tableName, keys) {
    const batches = [];
    for (let i = 0; i < keys.length; i += 100) {
        batches.push(keys.slice(i, i + 100));
    }
    const results = [];
    for (const batch of batches) {
        const result = await exports.docClient.send(new lib_dynamodb_1.BatchGetCommand({
            RequestItems: {
                [tableName]: {
                    Keys: batch,
                },
            },
        }));
        if (result.Responses?.[tableName]) {
            results.push(...result.Responses[tableName]);
        }
    }
    return results;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vZGItY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHluYW1vZGItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxxREFBcUQ7QUFDckQseUJBQXlCOzs7QUErQ3pCLDBCQU9DO0FBRUQsMEJBV0M7QUFFRCxnQ0FtQkM7QUFFRCxnQ0FnQkM7QUFFRCxnQ0FVQztBQUVELDBDQW9CQztBQUVELHNDQXlCQztBQXJLRCw4REFBMEQ7QUFDMUQsd0RBUytCO0FBRS9CLDZDQUE2QztBQUM3QyxNQUFNLE1BQU0sR0FBRyxJQUFJLGdDQUFjLENBQUM7SUFDaEMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVc7Q0FDOUMsQ0FBQyxDQUFDO0FBRUgsc0RBQXNEO0FBQ3pDLFFBQUEsU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7SUFDM0QsZUFBZSxFQUFFO1FBQ2YscUJBQXFCLEVBQUUsSUFBSTtRQUMzQix5QkFBeUIsRUFBRSxJQUFJO0tBQ2hDO0lBQ0QsaUJBQWlCLEVBQUU7UUFDakIsV0FBVyxFQUFFLEtBQUs7S0FDbkI7Q0FDRixDQUFDLENBQUM7QUFFSCx5Q0FBeUM7QUFDNUIsUUFBQSxNQUFNLEdBQUc7SUFDcEIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLEVBQUU7SUFDcEMsY0FBYyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLElBQUksRUFBRTtJQUN0RCxXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxFQUFFO0lBQ2hELFlBQVksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLEVBQUU7SUFDbEQsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLEVBQUU7SUFDdEMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLElBQUks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QUUsS0FBSyxDQUFDLEdBQUcsQ0FBQyxDQUFDLElBQUksRUFBRSxFQUFFLENBQUMsQ0FBQztvQkFDaEMsVUFBVSxFQUFFLEVBQUUsSUFBSSxFQUFFLElBQUksRUFBRTtpQkFDM0IsQ0FBQyxDQUFDO2FBQ0o7U0FDRixDQUFDLENBQ0gsQ0FBQztJQUNKLENBQUM7QUFDSCxDQUFDO0FBRU0sS0FBSyxVQUFVLGFBQWEsQ0FDakMsU0FBaUIsRUFDakIsSUFBK0I7SUFFL0IsTUFBTSxPQUFPLEdBQUcsRUFBRSxDQUFDO0lBQ25CLEtBQUssSUFBSSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUMsR0FBRyxJQUFJLENBQUMsTUFBTSxFQUFFLENBQUMsSUFBSSxHQUFHLEVBQUUsQ0FBQztRQUMxQyxPQUFPLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxFQUFFLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDO0lBQ3ZDLENBQUM7SUFFRCxNQUFNLE9BQU8sR0FBUSxFQUFFLENBQUM7SUFDeEIsS0FBSyxNQUFNLEtBQUssSUFBSSxPQUFPLEVBQUUsQ0FBQztRQUM1QixNQUFNLE1BQU0sR0FBRyxNQUFNLGlCQUFTLENBQUMsSUFBSSxDQUNqQyxJQUFJLDhCQUFlLENBQUM7WUFDbEIsWUFBWSxFQUFFO2dCQUNaLENBQUMsU0FBUyxDQUFDLEVBQUU7b0JBQ1gsSUFBSSxFQUFFLEtBQUs7aUJBQ1o7YUFDRjtTQUNGLENBQUMsQ0FDSCxDQUFDO1FBQ0YsSUFBSSxNQUFNLENBQUMsU0FBUyxFQUFFLENBQUMsU0FBUyxDQUFDLEVBQUUsQ0FBQztZQUNsQyxPQUFPLENBQUMsSUFBSSxDQUFDLEdBQUksTUFBTSxDQUFDLFNBQVMsQ0FBQyxTQUFTLENBQVMsQ0FBQyxDQUFDO1FBQ3hELENBQUM7SUFDSCxDQUFDO0lBQ0QsT0FBTyxPQUFPLENBQUM7QUFDakIsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIER5bmFtb0RCIERhdGEgQWNjZXNzIExheWVyIHdpdGggZW5jcnlwdGlvbiBhdCByZXN0XG4vLyBSZXF1aXJlbWVudHM6IDguMSwgOC40XG5cbmltcG9ydCB7IER5bmFtb0RCQ2xpZW50IH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWR5bmFtb2RiJztcbmltcG9ydCB7XG4gIER5bmFtb0RCRG9jdW1lbnRDbGllbnQsXG4gIFB1dENvbW1hbmQsXG4gIEdldENvbW1hbmQsXG4gIFF1ZXJ5Q29tbWFuZCxcbiAgVXBkYXRlQ29tbWFuZCxcbiAgRGVsZXRlQ29tbWFuZCxcbiAgQmF0Y2hXcml0ZUNvbW1hbmQsXG4gIEJhdGNoR2V0Q29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvbGliLWR5bmFtb2RiJztcblxuLy8gSW5pdGlhbGl6ZSBEeW5hbW9EQiBjbGllbnQgd2l0aCBlbmNyeXB0aW9uXG5jb25zdCBjbGllbnQgPSBuZXcgRHluYW1vREJDbGllbnQoe1xuICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMScsXG59KTtcblxuLy8gQ3JlYXRlIGRvY3VtZW50IGNsaWVudCBmb3IgZWFzaWVyIGRhdGEgbWFuaXB1bGF0aW9uXG5leHBvcnQgY29uc3QgZG9jQ2xpZW50ID0gRHluYW1vREJEb2N1bWVudENsaWVudC5mcm9tKGNsaWVudCwge1xuICBtYXJzaGFsbE9wdGlvbnM6IHtcbiAgICByZW1vdmVVbmRlZmluZWRWYWx1ZXM6IHRydWUsXG4gICAgY29udmVydENsYXNzSW5zdGFuY2VUb01hcDogdHJ1ZSxcbiAgfSxcbiAgdW5tYXJzaGFsbE9wdGlvbnM6IHtcbiAgICB3cmFwTnVtYmVyczogZmFsc2UsXG4gIH0sXG59KTtcblxuLy8gVGFibGUgbmFtZXMgZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbmV4cG9ydCBjb25zdCBUQUJMRVMgPSB7XG4gIFVTRVJTOiBwcm9jZXNzLmVudi5VU0VSU19UQUJMRSB8fCAnJyxcbiAgSEVBTFRIX1JFQ09SRFM6IHByb2Nlc3MuZW52LkhFQUxUSF9SRUNPUkRTX1RBQkxFIHx8ICcnLFxuICBNRURJQ0FUSU9OUzogcHJvY2Vzcy5lbnYuTUVESUNBVElPTlNfVEFCTEUgfHwgJycsXG4gIEFQUE9JTlRNRU5UUzogcHJvY2Vzcy5lbnYuQVBQT0lOVE1FTlRTX1RBQkxFIHx8ICcnLFxuICBBTEVSVFM6IHByb2Nlc3MuZW52LkFMRVJUU19UQUJMRSB8fCAnJyxcbiAgQ0FSRV9DSVJDTEU6IHByb2Nlc3MuZW52LkNBUkVfQ0lSQ0xFX1RBQkxFIHx8ICcnLFxuICBDQVJFX0NJUkNMRV9JTlZJVEFUSU9OUzogcHJvY2Vzcy5lbnYuQ0FSRV9DSVJDTEVfSU5WSVRBVElPTlNfVEFCTEUgfHwgJycsXG4gIENBUkVfQ0lSQ0xFX01FU1NBR0VTOiBwcm9jZXNzLmVudi5DQVJFX0NJUkNMRV9NRVNTQUdFU19UQUJMRSB8fCAnJyxcbiAgREVWSUNFUzogcHJvY2Vzcy5lbnYuREVWSUNFU19UQUJMRSB8fCAnJyxcbn07XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEdlbmVyaWMgRHluYW1vREIgT3BlcmF0aW9uc1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHV0SXRlbTxUPih0YWJsZU5hbWU6IHN0cmluZywgaXRlbTogVCk6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICAgIEl0ZW06IGl0ZW0gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgfSlcbiAgKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEl0ZW08VD4oXG4gIHRhYmxlTmFtZTogc3RyaW5nLFxuICBrZXk6IFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4pOiBQcm9taXNlPFQgfCBudWxsPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgIG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogdGFibGVOYW1lLFxuICAgICAgS2V5OiBrZXksXG4gICAgfSlcbiAgKTtcbiAgcmV0dXJuIChyZXN1bHQuSXRlbSBhcyBUKSB8fCBudWxsO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcXVlcnlJdGVtczxUPihcbiAgdGFibGVOYW1lOiBzdHJpbmcsXG4gIGtleUNvbmRpdGlvbkV4cHJlc3Npb246IHN0cmluZyxcbiAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIGluZGV4TmFtZT86IHN0cmluZyxcbiAgZmlsdGVyRXhwcmVzc2lvbj86IHN0cmluZyxcbiAgbGltaXQ/OiBudW1iZXJcbik6IFByb21pc2U8VFtdPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0YWJsZU5hbWUsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiBrZXlDb25kaXRpb25FeHByZXNzaW9uLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIEluZGV4TmFtZTogaW5kZXhOYW1lLFxuICAgICAgRmlsdGVyRXhwcmVzc2lvbjogZmlsdGVyRXhwcmVzc2lvbixcbiAgICAgIExpbWl0OiBsaW1pdCxcbiAgICB9KVxuICApO1xuICByZXR1cm4gKHJlc3VsdC5JdGVtcyBhcyBUW10pIHx8IFtdO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlSXRlbShcbiAgdGFibGVOYW1lOiBzdHJpbmcsXG4gIGtleTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIHVwZGF0ZUV4cHJlc3Npb246IHN0cmluZyxcbiAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICAgIEtleToga2V5LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogdXBkYXRlRXhwcmVzc2lvbixcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICB9KVxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlSXRlbShcbiAgdGFibGVOYW1lOiBzdHJpbmcsXG4gIGtleTogUmVjb3JkPHN0cmluZywgdW5rbm93bj5cbik6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgRGVsZXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICAgIEtleToga2V5LFxuICAgIH0pXG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBiYXRjaFdyaXRlSXRlbXMoXG4gIHRhYmxlTmFtZTogc3RyaW5nLFxuICBpdGVtczogUmVjb3JkPHN0cmluZywgdW5rbm93bj5bXVxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGJhdGNoZXMgPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkgKz0gMjUpIHtcbiAgICBiYXRjaGVzLnB1c2goaXRlbXMuc2xpY2UoaSwgaSArIDI1KSk7XG4gIH1cblxuICBmb3IgKGNvbnN0IGJhdGNoIG9mIGJhdGNoZXMpIHtcbiAgICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgIG5ldyBCYXRjaFdyaXRlQ29tbWFuZCh7XG4gICAgICAgIFJlcXVlc3RJdGVtczoge1xuICAgICAgICAgIFt0YWJsZU5hbWVdOiBiYXRjaC5tYXAoKGl0ZW0pID0+ICh7XG4gICAgICAgICAgICBQdXRSZXF1ZXN0OiB7IEl0ZW06IGl0ZW0gfSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJhdGNoR2V0SXRlbXM8VD4oXG4gIHRhYmxlTmFtZTogc3RyaW5nLFxuICBrZXlzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPltdXG4pOiBQcm9taXNlPFRbXT4ge1xuICBjb25zdCBiYXRjaGVzID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkgKz0gMTAwKSB7XG4gICAgYmF0Y2hlcy5wdXNoKGtleXMuc2xpY2UoaSwgaSArIDEwMCkpO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0czogVFtdID0gW107XG4gIGZvciAoY29uc3QgYmF0Y2ggb2YgYmF0Y2hlcykge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgICAgbmV3IEJhdGNoR2V0Q29tbWFuZCh7XG4gICAgICAgIFJlcXVlc3RJdGVtczoge1xuICAgICAgICAgIFt0YWJsZU5hbWVdOiB7XG4gICAgICAgICAgICBLZXlzOiBiYXRjaCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICApO1xuICAgIGlmIChyZXN1bHQuUmVzcG9uc2VzPy5bdGFibGVOYW1lXSkge1xuICAgICAgcmVzdWx0cy5wdXNoKC4uLihyZXN1bHQuUmVzcG9uc2VzW3RhYmxlTmFtZV0gYXMgVFtdKSk7XG4gICAgfVxuICB9XG4gIHJldHVybiByZXN1bHRzO1xufVxuIl19