"use strict";
// DynamoDB Data Access Layer with encryption at rest
// Requirements: 8.1, 8.4
Object.defineProperty(exports, "__esModule", { value: true });
exports.TABLES = exports.docClient = void 0;
exports.putItem = putItem;
exports.getItem = getItem;
exports.queryItems = queryItems;
exports.updateItem = updateItem;
exports.deleteItem = deleteItem;
exports.batchWriteItems = batchWriteItems;
exports.batchGetItems = batchGetItems;
const client_dynamodb_1 = require("@aws-sdk/client-dynamodb");
const lib_dynamodb_1 = require("@aws-sdk/lib-dynamodb");
// Initialize DynamoDB client with encryption
const client = new client_dynamodb_1.DynamoDBClient({
    region: process.env.AWS_REGION || 'us-east-1',
});
// Create document client for easier data manipulation
exports.docClient = lib_dynamodb_1.DynamoDBDocumentClient.from(client, {
    marshallOptions: {
        removeUndefinedValues: true,
        convertClassInstanceToMap: true,
    },
    unmarshallOptions: {
        wrapNumbers: false,
    },
});
// Table names from environment variables
exports.TABLES = {
    USERS: process.env.USERS_TABLE || '',
    HEALTH_RECORDS: process.env.HEALTH_RECORDS_TABLE || '',
    MEDICATIONS: process.env.MEDICATIONS_TABLE || '',
    APPOINTMENTS: process.env.APPOINTMENTS_TABLE || '',
    ALERTS: process.env.ALERTS_TABLE || '',
    CARE_CIRCLE: process.env.CARE_CIRCLE_TABLE || '',
    DEVICES: process.env.DEVICES_TABLE || '',
};
// ============================================================================
// Generic DynamoDB Operations
// ============================================================================
async function putItem(tableName, item) {
    await exports.docClient.send(new lib_dynamodb_1.PutCommand({
        TableName: tableName,
        Item: item,
    }));
}
async function getItem(tableName, key) {
    const result = await exports.docClient.send(new lib_dynamodb_1.GetCommand({
        TableName: tableName,
        Key: key,
    }));
    return result.Item || null;
}
async function queryItems(tableName, keyConditionExpression, expressionAttributeValues, indexName, filterExpression, limit) {
    const result = await exports.docClient.send(new lib_dynamodb_1.QueryCommand({
        TableName: tableName,
        KeyConditionExpression: keyConditionExpression,
        ExpressionAttributeValues: expressionAttributeValues,
        IndexName: indexName,
        FilterExpression: filterExpression,
        Limit: limit,
    }));
    return result.Items || [];
}
async function updateItem(tableName, key, updateExpression, expressionAttributeValues, expressionAttributeNames) {
    await exports.docClient.send(new lib_dynamodb_1.UpdateCommand({
        TableName: tableName,
        Key: key,
        UpdateExpression: updateExpression,
        ExpressionAttributeValues: expressionAttributeValues,
        ExpressionAttributeNames: expressionAttributeNames,
    }));
}
async function deleteItem(tableName, key) {
    await exports.docClient.send(new lib_dynamodb_1.DeleteCommand({
        TableName: tableName,
        Key: key,
    }));
}
async function batchWriteItems(tableName, items) {
    const batches = [];
    for (let i = 0; i < items.length; i += 25) {
        batches.push(items.slice(i, i + 25));
    }
    for (const batch of batches) {
        await exports.docClient.send(new lib_dynamodb_1.BatchWriteCommand({
            RequestItems: {
                [tableName]: batch.map((item) => ({
                    PutRequest: { Item: item },
                })),
            },
        }));
    }
}
async function batchGetItems(tableName, keys) {
    const batches = [];
    for (let i = 0; i < keys.length; i += 100) {
        batches.push(keys.slice(i, i + 100));
    }
    const results = [];
    for (const batch of batches) {
        const result = await exports.docClient.send(new lib_dynamodb_1.BatchGetCommand({
            RequestItems: {
                [tableName]: {
                    Keys: batch,
                },
            },
        }));
        if (result.Responses?.[tableName]) {
            results.push(...result.Responses[tableName]);
        }
    }
    return results;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZHluYW1vZGItY2xpZW50LmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiZHluYW1vZGItY2xpZW50LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7QUFBQSxxREFBcUQ7QUFDckQseUJBQXlCOzs7QUE2Q3pCLDBCQU9DO0FBRUQsMEJBV0M7QUFFRCxnQ0FtQkM7QUFFRCxnQ0FnQkM7QUFFRCxnQ0FVQztBQUVELDBDQW9CQztBQUVELHNDQXlCQztBQW5LRCw4REFBMEQ7QUFDMUQsd0RBUytCO0FBRS9CLDZDQUE2QztBQUM3QyxNQUFNLE1BQU0sR0FBRyxJQUFJLGdDQUFjLENBQUM7SUFDaEMsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsVUFBVSxJQUFJLFdBQVc7Q0FDOUMsQ0FBQyxDQUFDO0FBRUgsc0RBQXNEO0FBQ3pDLFFBQUEsU0FBUyxHQUFHLHFDQUFzQixDQUFDLElBQUksQ0FBQyxNQUFNLEVBQUU7SUFDM0QsZUFBZSxFQUFFO1FBQ2YscUJBQXFCLEVBQUUsSUFBSTtRQUMzQix5QkFBeUIsRUFBRSxJQUFJO0tBQ2hDO0lBQ0QsaUJBQWlCLEVBQUU7UUFDakIsV0FBVyxFQUFFLEtBQUs7S0FDbkI7Q0FDRixDQUFDLENBQUM7QUFFSCx5Q0FBeUM7QUFDNUIsUUFBQSxNQUFNLEdBQUc7SUFDcEIsS0FBSyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsV0FBVyxJQUFJLEVBQUU7SUFDcEMsY0FBYyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsb0JBQW9CLElBQUksRUFBRTtJQUN0RCxXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxFQUFFO0lBQ2hELFlBQVksRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGtCQUFrQixJQUFJLEVBQUU7SUFDbEQsTUFBTSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxJQUFJLEVBQUU7SUFDdEMsV0FBVyxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsaUJBQWlCLElBQUks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QzthQUNKO1NBQ0YsQ0FBQyxDQUNILENBQUM7SUFDSixDQUFDO0FBQ0gsQ0FBQztBQUVNLEtBQUssVUFBVSxhQUFhLENBQ2pDLFNBQWlCLEVBQ2pCLElBQStCO0lBRS9CLE1BQU0sT0FBTyxHQUFHLEVBQUUsQ0FBQztJQUNuQixLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsSUFBSSxDQUFDLE1BQU0sRUFBRSxDQUFDLElBQUksR0FBRyxFQUFFLENBQUM7UUFDMUMsT0FBTyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLENBQUMsRUFBRSxDQUFDLEdBQUcsR0FBRyxDQUFDLENBQUMsQ0FBQztJQUN2QyxDQUFDO0lBRUQsTUFBTSxPQUFPLEdBQVEsRUFBRSxDQUFDO0lBQ3hCLEtBQUssTUFBTSxLQUFLLElBQUksT0FBTyxFQUFFLENBQUM7UUFDNUIsTUFBTSxNQUFNLEdBQUcsTUFBTSxpQkFBUyxDQUFDLElBQUksQ0FDakMsSUFBSSw4QkFBZSxDQUFDO1lBQ2xCLFlBQVksRUFBRTtnQkFDWixDQUFDLFNBQVMsQ0FBQyxFQUFFO29CQUNYLElBQUksRUFBRSxLQUFLO2lCQUNaO2FBQ0Y7U0FDRixDQUFDLENBQ0gsQ0FBQztRQUNGLElBQUksTUFBTSxDQUFDLFNBQVMsRUFBRSxDQUFDLFNBQVMsQ0FBQyxFQUFFLENBQUM7WUFDbEMsT0FBTyxDQUFDLElBQUksQ0FBQyxHQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxDQUFTLENBQUMsQ0FBQztRQUN4RCxDQUFDO0lBQ0gsQ0FBQztJQUNELE9BQU8sT0FBTyxDQUFDO0FBQ2pCLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyIvLyBEeW5hbW9EQiBEYXRhIEFjY2VzcyBMYXllciB3aXRoIGVuY3J5cHRpb24gYXQgcmVzdFxuLy8gUmVxdWlyZW1lbnRzOiA4LjEsIDguNFxuXG5pbXBvcnQgeyBEeW5hbW9EQkNsaWVudCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC1keW5hbW9kYic7XG5pbXBvcnQge1xuICBEeW5hbW9EQkRvY3VtZW50Q2xpZW50LFxuICBQdXRDb21tYW5kLFxuICBHZXRDb21tYW5kLFxuICBRdWVyeUNvbW1hbmQsXG4gIFVwZGF0ZUNvbW1hbmQsXG4gIERlbGV0ZUNvbW1hbmQsXG4gIEJhdGNoV3JpdGVDb21tYW5kLFxuICBCYXRjaEdldENvbW1hbmQsXG59IGZyb20gJ0Bhd3Mtc2RrL2xpYi1keW5hbW9kYic7XG5cbi8vIEluaXRpYWxpemUgRHluYW1vREIgY2xpZW50IHdpdGggZW5jcnlwdGlvblxuY29uc3QgY2xpZW50ID0gbmV3IER5bmFtb0RCQ2xpZW50KHtcbiAgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICd1cy1lYXN0LTEnLFxufSk7XG5cbi8vIENyZWF0ZSBkb2N1bWVudCBjbGllbnQgZm9yIGVhc2llciBkYXRhIG1hbmlwdWxhdGlvblxuZXhwb3J0IGNvbnN0IGRvY0NsaWVudCA9IER5bmFtb0RCRG9jdW1lbnRDbGllbnQuZnJvbShjbGllbnQsIHtcbiAgbWFyc2hhbGxPcHRpb25zOiB7XG4gICAgcmVtb3ZlVW5kZWZpbmVkVmFsdWVzOiB0cnVlLFxuICAgIGNvbnZlcnRDbGFzc0luc3RhbmNlVG9NYXA6IHRydWUsXG4gIH0sXG4gIHVubWFyc2hhbGxPcHRpb25zOiB7XG4gICAgd3JhcE51bWJlcnM6IGZhbHNlLFxuICB9LFxufSk7XG5cbi8vIFRhYmxlIG5hbWVzIGZyb20gZW52aXJvbm1lbnQgdmFyaWFibGVzXG5leHBvcnQgY29uc3QgVEFCTEVTID0ge1xuICBVU0VSUzogcHJvY2Vzcy5lbnYuVVNFUlNfVEFCTEUgfHwgJycsXG4gIEhFQUxUSF9SRUNPUkRTOiBwcm9jZXNzLmVudi5IRUFMVEhfUkVDT1JEU19UQUJMRSB8fCAnJyxcbiAgTUVESUNBVElPTlM6IHByb2Nlc3MuZW52Lk1FRElDQVRJT05TX1RBQkxFIHx8ICcnLFxuICBBUFBPSU5UTUVOVFM6IHByb2Nlc3MuZW52LkFQUE9JTlRNRU5UU19UQUJMRSB8fCAnJyxcbiAgQUxFUlRTOiBwcm9jZXNzLmVudi5BTEVSVFNfVEFCTEUgfHwgJycsXG4gIENBUkVfQ0lSQ0xFOiBwcm9jZXNzLmVudi5DQVJFX0NJUkNMRV9UQUJMRSB8fCAnJyxcbiAgREVWSUNFUzogcHJvY2Vzcy5lbnYuREVWSUNFU19UQUJMRSB8fCAnJyxcbn07XG5cbi8vID09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT1cbi8vIEdlbmVyaWMgRHluYW1vREIgT3BlcmF0aW9uc1xuLy8gPT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PT09PVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcHV0SXRlbTxUPih0YWJsZU5hbWU6IHN0cmluZywgaXRlbTogVCk6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgUHV0Q29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICAgIEl0ZW06IGl0ZW0gYXMgUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gICAgfSlcbiAgKTtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGdldEl0ZW08VD4oXG4gIHRhYmxlTmFtZTogc3RyaW5nLFxuICBrZXk6IFJlY29yZDxzdHJpbmcsIHVua25vd24+XG4pOiBQcm9taXNlPFQgfCBudWxsPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgIG5ldyBHZXRDb21tYW5kKHtcbiAgICAgIFRhYmxlTmFtZTogdGFibGVOYW1lLFxuICAgICAgS2V5OiBrZXksXG4gICAgfSlcbiAgKTtcbiAgcmV0dXJuIChyZXN1bHQuSXRlbSBhcyBUKSB8fCBudWxsO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gcXVlcnlJdGVtczxUPihcbiAgdGFibGVOYW1lOiBzdHJpbmcsXG4gIGtleUNvbmRpdGlvbkV4cHJlc3Npb246IHN0cmluZyxcbiAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIGluZGV4TmFtZT86IHN0cmluZyxcbiAgZmlsdGVyRXhwcmVzc2lvbj86IHN0cmluZyxcbiAgbGltaXQ/OiBudW1iZXJcbik6IFByb21pc2U8VFtdPiB7XG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgIG5ldyBRdWVyeUNvbW1hbmQoe1xuICAgICAgVGFibGVOYW1lOiB0YWJsZU5hbWUsXG4gICAgICBLZXlDb25kaXRpb25FeHByZXNzaW9uOiBrZXlDb25kaXRpb25FeHByZXNzaW9uLFxuICAgICAgRXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlcyxcbiAgICAgIEluZGV4TmFtZTogaW5kZXhOYW1lLFxuICAgICAgRmlsdGVyRXhwcmVzc2lvbjogZmlsdGVyRXhwcmVzc2lvbixcbiAgICAgIExpbWl0OiBsaW1pdCxcbiAgICB9KVxuICApO1xuICByZXR1cm4gKHJlc3VsdC5JdGVtcyBhcyBUW10pIHx8IFtdO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gdXBkYXRlSXRlbShcbiAgdGFibGVOYW1lOiBzdHJpbmcsXG4gIGtleTogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIHVwZGF0ZUV4cHJlc3Npb246IHN0cmluZyxcbiAgZXhwcmVzc2lvbkF0dHJpYnV0ZVZhbHVlczogUmVjb3JkPHN0cmluZywgdW5rbm93bj4sXG4gIGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcz86IFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbik6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgVXBkYXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICAgIEtleToga2V5LFxuICAgICAgVXBkYXRlRXhwcmVzc2lvbjogdXBkYXRlRXhwcmVzc2lvbixcbiAgICAgIEV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVWYWx1ZXMsXG4gICAgICBFeHByZXNzaW9uQXR0cmlidXRlTmFtZXM6IGV4cHJlc3Npb25BdHRyaWJ1dGVOYW1lcyxcbiAgICB9KVxuICApO1xufVxuXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gZGVsZXRlSXRlbShcbiAgdGFibGVOYW1lOiBzdHJpbmcsXG4gIGtleTogUmVjb3JkPHN0cmluZywgdW5rbm93bj5cbik6IFByb21pc2U8dm9pZD4ge1xuICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICBuZXcgRGVsZXRlQ29tbWFuZCh7XG4gICAgICBUYWJsZU5hbWU6IHRhYmxlTmFtZSxcbiAgICAgIEtleToga2V5LFxuICAgIH0pXG4gICk7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBiYXRjaFdyaXRlSXRlbXMoXG4gIHRhYmxlTmFtZTogc3RyaW5nLFxuICBpdGVtczogUmVjb3JkPHN0cmluZywgdW5rbm93bj5bXVxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGJhdGNoZXMgPSBbXTtcbiAgZm9yIChsZXQgaSA9IDA7IGkgPCBpdGVtcy5sZW5ndGg7IGkgKz0gMjUpIHtcbiAgICBiYXRjaGVzLnB1c2goaXRlbXMuc2xpY2UoaSwgaSArIDI1KSk7XG4gIH1cblxuICBmb3IgKGNvbnN0IGJhdGNoIG9mIGJhdGNoZXMpIHtcbiAgICBhd2FpdCBkb2NDbGllbnQuc2VuZChcbiAgICAgIG5ldyBCYXRjaFdyaXRlQ29tbWFuZCh7XG4gICAgICAgIFJlcXVlc3RJdGVtczoge1xuICAgICAgICAgIFt0YWJsZU5hbWVdOiBiYXRjaC5tYXAoKGl0ZW0pID0+ICh7XG4gICAgICAgICAgICBQdXRSZXF1ZXN0OiB7IEl0ZW06IGl0ZW0gfSxcbiAgICAgICAgICB9KSksXG4gICAgICAgIH0sXG4gICAgICB9KVxuICAgICk7XG4gIH1cbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGJhdGNoR2V0SXRlbXM8VD4oXG4gIHRhYmxlTmFtZTogc3RyaW5nLFxuICBrZXlzOiBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPltdXG4pOiBQcm9taXNlPFRbXT4ge1xuICBjb25zdCBiYXRjaGVzID0gW107XG4gIGZvciAobGV0IGkgPSAwOyBpIDwga2V5cy5sZW5ndGg7IGkgKz0gMTAwKSB7XG4gICAgYmF0Y2hlcy5wdXNoKGtleXMuc2xpY2UoaSwgaSArIDEwMCkpO1xuICB9XG5cbiAgY29uc3QgcmVzdWx0czogVFtdID0gW107XG4gIGZvciAoY29uc3QgYmF0Y2ggb2YgYmF0Y2hlcykge1xuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGRvY0NsaWVudC5zZW5kKFxuICAgICAgbmV3IEJhdGNoR2V0Q29tbWFuZCh7XG4gICAgICAgIFJlcXVlc3RJdGVtczoge1xuICAgICAgICAgIFt0YWJsZU5hbWVdOiB7XG4gICAgICAgICAgICBLZXlzOiBiYXRjaCxcbiAgICAgICAgICB9LFxuICAgICAgICB9LFxuICAgICAgfSlcbiAgICApO1xuICAgIGlmIChyZXN1bHQuUmVzcG9uc2VzPy5bdGFibGVOYW1lXSkge1xuICAgICAgcmVzdWx0cy5wdXNoKC4uLihyZXN1bHQuUmVzcG9uc2VzW3RhYmxlTmFtZV0gYXMgVFtdKSk7XG4gICAgfVxuICB9XG4gIHJldHVybiByZXN1bHRzO1xufVxuIl19