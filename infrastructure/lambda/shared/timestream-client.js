"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.queryClient = exports.writeClient = exports.TimestreamTables = void 0;
exports.writeVitalSigns = writeVitalSigns;
exports.writeDeviceReadings = writeDeviceReadings;
exports.writeSensorData = writeSensorData;
exports.queryVitalSigns = queryVitalSigns;
exports.queryDeviceReadings = queryDeviceReadings;
const client_timestream_write_1 = require("@aws-sdk/client-timestream-write");
const client_timestream_query_1 = require("@aws-sdk/client-timestream-query");
/**
 * Timestream client configuration for healthcare monitoring app
 * Provides write and query capabilities for time-series health data
 */
const TIMESTREAM_DATABASE = process.env.TIMESTREAM_DATABASE || 'healthcare-timeseries-dev';
// Initialize clients
const writeClient = new client_timestream_write_1.TimestreamWriteClient({
    region: process.env.AWS_REGION || 'us-east-1',
});
exports.writeClient = writeClient;
const queryClient = new client_timestream_query_1.TimestreamQueryClient({
    region: process.env.AWS_REGION || 'us-east-1',
});
exports.queryClient = queryClient;
/**
 * Table names for different types of health data
 */
exports.TimestreamTables = {
    VITAL_SIGNS: 'vital-signs',
    DEVICE_READINGS: 'device-readings',
    SENSOR_DATA: 'sensor-data',
};
/**
 * Write vital signs data to Timestream
 */
async function writeVitalSigns(userId, vitals, timestamp, source = 'manual') {
    const currentTime = timestamp || new Date();
    const timeInMillis = currentTime.getTime().toString();
    const records = [];
    // Create a record for each vital sign measurement
    if (vitals.heartRate !== undefined) {
        records.push(createRecord('heart_rate', vitals.heartRate, userId, source, timeInMillis));
    }
    if (vitals.systolicBP !== undefined) {
        records.push(createRecord('systolic_bp', vitals.systolicBP, userId, source, timeInMillis));
    }
    if (vitals.diastolicBP !== undefined) {
        records.push(createRecord('diastolic_bp', vitals.diastolicBP, userId, source, timeInMillis));
    }
    if (vitals.temperature !== undefined) {
        records.push(createRecord('temperature', vitals.temperature, userId, source, timeInMillis));
    }
    if (vitals.oxygenSaturation !== undefined) {
        records.push(createRecord('oxygen_saturation', vitals.oxygenSaturation, userId, source, timeInMillis));
    }
    if (vitals.weight !== undefined) {
        records.push(createRecord('weight', vitals.weight, userId, source, timeInMillis));
    }
    if (records.length === 0) {
        throw new Error('No vital signs data provided');
    }
    const params = {
        DatabaseName: TIMESTREAM_DATABASE,
        TableName: exports.TimestreamTables.VITAL_SIGNS,
        Records: records,
    };
    await writeClient.send(new client_timestream_write_1.WriteRecordsCommand(params));
}
/**
 * Write device readings to Timestream
 */
async function writeDeviceReadings(deviceId, userId, readings, timestamp, metadata) {
    const currentTime = timestamp || new Date();
    const timeInMillis = currentTime.getTime().toString();
    const records = readings.map(reading => ({
        MeasureName: reading.measureName,
        MeasureValue: reading.value.toString(),
        MeasureValueType: client_timestream_write_1.MeasureValueType.DOUBLE,
        Time: timeInMillis,
        TimeUnit: 'MILLISECONDS',
        Dimensions: [
            { Name: 'device_id', Value: deviceId },
            { Name: 'user_id', Value: userId },
            { Name: 'unit', Value: reading.unit || 'unknown' },
        ],
    }));
    // Add metadata as separate records if provided
    if (metadata?.batteryLevel !== undefined) {
        records.push(createDeviceMetadataRecord('battery_level', metadata.batteryLevel, deviceId, userId, timeInMillis));
    }
    if (metadata?.signalStrength !== undefined) {
        records.push(createDeviceMetadataRecord('signal_strength', metadata.signalStrength, deviceId, userId, timeInMillis));
    }
    const params = {
        DatabaseName: TIMESTREAM_DATABASE,
        TableName: exports.TimestreamTables.DEVICE_READINGS,
        Records: records,
    };
    await writeClient.send(new client_timestream_write_1.WriteRecordsCommand(params));
}
/**
 * Write sensor data to Timestream
 */
async function writeSensorData(sensorId, userId, sensorType, value, unit, timestamp) {
    const currentTime = timestamp || new Date();
    const timeInMillis = currentTime.getTime().toString();
    const record = {
        MeasureName: sensorType,
        MeasureValue: value.toString(),
        MeasureValueType: client_timestream_write_1.MeasureValueType.DOUBLE,
        Time: timeInMillis,
        TimeUnit: 'MILLISECONDS',
        Dimensions: [
            { Name: 'sensor_id', Value: sensorId },
            { Name: 'user_id', Value: userId },
            { Name: 'unit', Value: unit },
        ],
    };
    const params = {
        DatabaseName: TIMESTREAM_DATABASE,
        TableName: exports.TimestreamTables.SENSOR_DATA,
        Records: [record],
    };
    await writeClient.send(new client_timestream_write_1.WriteRecordsCommand(params));
}
/**
 * Query vital signs for a user within a time range
 */
async function queryVitalSigns(userId, startTime, endTime, measureNames) {
    const measureFilter = measureNames && measureNames.length > 0
        ? `AND measure_name IN (${measureNames.map(m => `'${m}'`).join(', ')})`
        : '';
    const query = `
    SELECT 
      time, 
      measure_name, 
      measure_value::double as value,
      source
    FROM "${TIMESTREAM_DATABASE}"."${exports.TimestreamTables.VITAL_SIGNS}"
    WHERE user_id = '${userId}'
      AND time BETWEEN from_milliseconds(${startTime.getTime()}) 
      AND from_milliseconds(${endTime.getTime()})
      ${measureFilter}
    ORDER BY time DESC
  `;
    const params = {
        QueryString: query,
    };
    const response = await queryClient.send(new client_timestream_query_1.QueryCommand(params));
    return parseQueryResults(response);
}
/**
 * Query device readings for a device within a time range
 */
async function queryDeviceReadings(deviceId, startTime, endTime) {
    const query = `
    SELECT 
      time, 
      measure_name, 
      measure_value::double as value,
      device_id,
      user_id,
      unit
    FROM "${TIMESTREAM_DATABASE}"."${exports.TimestreamTables.DEVICE_READINGS}"
    WHERE device_id = '${deviceId}'
      AND time BETWEEN from_milliseconds(${startTime.getTime()}) 
      AND from_milliseconds(${endTime.getTime()})
    ORDER BY time DESC
  `;
    const params = {
        QueryString: query,
    };
    const response = await queryClient.send(new client_timestream_query_1.QueryCommand(params));
    return parseQueryResults(response);
}
/**
 * Helper function to create a vital signs record
 */
function createRecord(measureName, value, userId, source, timeInMillis) {
    return {
        MeasureName: measureName,
        MeasureValue: value.toString(),
        MeasureValueType: client_timestream_write_1.MeasureValueType.DOUBLE,
        Time: timeInMillis,
        TimeUnit: 'MILLISECONDS',
        Dimensions: [
            { Name: 'user_id', Value: userId },
            { Name: 'source', Value: source },
        ],
    };
}
/**
 * Helper function to create a device metadata record
 */
function createDeviceMetadataRecord(measureName, value, deviceId, userId, timeInMillis) {
    return {
        MeasureName: measureName,
        MeasureValue: value.toString(),
        MeasureValueType: client_timestream_write_1.MeasureValueType.DOUBLE,
        Time: timeInMillis,
        TimeUnit: 'MILLISECONDS',
        Dimensions: [
            { Name: 'device_id', Value: deviceId },
            { Name: 'user_id', Value: userId },
            { Name: 'type', Value: 'metadata' },
        ],
    };
}
/**
 * Parse Timestream query results into a more usable format
 */
function parseQueryResults(response) {
    if (!response.Rows || response.Rows.length === 0) {
        return [];
    }
    const columnInfo = response.ColumnInfo || [];
    const results = [];
    for (const row of response.Rows) {
        const record = {};
        row.Data.forEach((data, index) => {
            const columnName = columnInfo[index]?.Name;
            record[columnName] = data.ScalarValue;
        });
        results.push(record);
    }
    return results;
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidGltZXN0cmVhbS1jbGllbnQuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJ0aW1lc3RyZWFtLWNsaWVudC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUErQkEsMENBaURDO0FBS0Qsa0RBNkNDO0FBS0QsMENBK0JDO0FBS0QsMENBOEJDO0FBS0Qsa0RBMEJDO0FBeE9ELDhFQUF1SztBQUN2Syw4RUFBMEc7QUFFMUc7OztHQUdHO0FBRUgsTUFBTSxtQkFBbUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLG1CQUFtQixJQUFJLDJCQUEyQixDQUFDO0FBRTNGLHFCQUFxQjtBQUNyQixNQUFNLFdBQVcsR0FBRyxJQUFJLCtDQUFxQixDQUFDO0lBQzVDLE1BQU0sRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLFVBQVUsSUFBSSxXQUFXO0NBQzlDLENBQUMsQ0FBQztBQW1TTSxrQ0FBVztBQWpTcEIsTUFBTSxXQUFXLEdBQUcsSUFBSSwrQ0FBcUIsQ0FBQztJQUM1QyxNQUFNLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxVQUFVLElBQUksV0FBVztDQUM5QyxDQUFDLENBQUM7QUErUm1CLGtDQUFXO0FBN1JqQzs7R0FFRztBQUNVLFFBQUEsZ0JBQWdCLEdBQUc7SUFDOUIsV0FBVyxFQUFFLGFBQWE7SUFDMUIsZUFBZSxFQUFFLGlCQUFpQjtJQUNsQyxXQUFXLEVBQUUsYUFBYTtDQUNsQixDQUFDO0FBRVg7O0dBRUc7QUFDSSxLQUFLLFVBQVUsZUFBZSxDQUNuQyxNQUFjLEVBQ2QsTUFPQyxFQUNELFNBQWdCLEVBQ2hCLFNBQTJDLFFBQVE7SUFFbkQsTUFBTSxXQUFXLEdBQUcsU0FBUyxJQUFJLElBQUksSUFBSSxFQUFFLENBQUM7SUFDNUMsTUFBTSxZQUFZLEdBQUcsV0FBVyxDQUFDLE9BQU8sRUFBRSxDQUFDLFFBQVEsRUFBRSxDQUFDO0lBRXRELE1BQU0sT0FBTyxHQUF1QixFQUFFLENBQUM7SUFFdkMsa0RBQWtEO0lBQ2xELElBQUksTUFBTSxD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QUksQ0FBQyxXQUFXLENBQUM7UUFDeEMsQ0FBQyxDQUFDLENBQUM7UUFDSCxPQUFPLENBQUMsSUFBSSxDQUFDLE1BQU0sQ0FBQyxDQUFDO0lBQ3ZCLENBQUM7SUFFRCxPQUFPLE9BQU8sQ0FBQztBQUNqQixDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgVGltZXN0cmVhbVdyaXRlQ2xpZW50LCBXcml0ZVJlY29yZHNDb21tYW5kLCBXcml0ZVJlY29yZHNDb21tYW5kSW5wdXQsIF9SZWNvcmQgYXMgVGltZXN0cmVhbVJlY29yZCwgTWVhc3VyZVZhbHVlVHlwZSB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC10aW1lc3RyZWFtLXdyaXRlJztcbmltcG9ydCB7IFRpbWVzdHJlYW1RdWVyeUNsaWVudCwgUXVlcnlDb21tYW5kLCBRdWVyeUNvbW1hbmRJbnB1dCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC10aW1lc3RyZWFtLXF1ZXJ5JztcblxuLyoqXG4gKiBUaW1lc3RyZWFtIGNsaWVudCBjb25maWd1cmF0aW9uIGZvciBoZWFsdGhjYXJlIG1vbml0b3JpbmcgYXBwXG4gKiBQcm92aWRlcyB3cml0ZSBhbmQgcXVlcnkgY2FwYWJpbGl0aWVzIGZvciB0aW1lLXNlcmllcyBoZWFsdGggZGF0YVxuICovXG5cbmNvbnN0IFRJTUVTVFJFQU1fREFUQUJBU0UgPSBwcm9jZXNzLmVudi5USU1FU1RSRUFNX0RBVEFCQVNFIHx8ICdoZWFsdGhjYXJlLXRpbWVzZXJpZXMtZGV2JztcblxuLy8gSW5pdGlhbGl6ZSBjbGllbnRzXG5jb25zdCB3cml0ZUNsaWVudCA9IG5ldyBUaW1lc3RyZWFtV3JpdGVDbGllbnQoe1xuICByZWdpb246IHByb2Nlc3MuZW52LkFXU19SRUdJT04gfHwgJ3VzLWVhc3QtMScsXG59KTtcblxuY29uc3QgcXVlcnlDbGllbnQgPSBuZXcgVGltZXN0cmVhbVF1ZXJ5Q2xpZW50KHtcbiAgcmVnaW9uOiBwcm9jZXNzLmVudi5BV1NfUkVHSU9OIHx8ICd1cy1lYXN0LTEnLFxufSk7XG5cbi8qKlxuICogVGFibGUgbmFtZXMgZm9yIGRpZmZlcmVudCB0eXBlcyBvZiBoZWFsdGggZGF0YVxuICovXG5leHBvcnQgY29uc3QgVGltZXN0cmVhbVRhYmxlcyA9IHtcbiAgVklUQUxfU0lHTlM6ICd2aXRhbC1zaWducycsXG4gIERFVklDRV9SRUFESU5HUzogJ2RldmljZS1yZWFkaW5ncycsXG4gIFNFTlNPUl9EQVRBOiAnc2Vuc29yLWRhdGEnLFxufSBhcyBjb25zdDtcblxuLyoqXG4gKiBXcml0ZSB2aXRhbCBzaWducyBkYXRhIHRvIFRpbWVzdHJlYW1cbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHdyaXRlVml0YWxTaWducyhcbiAgdXNlcklkOiBzdHJpbmcsXG4gIHZpdGFsczoge1xuICAgIGhlYXJ0UmF0ZT86IG51bWJlcjtcbiAgICBzeXN0b2xpY0JQPzogbnVtYmVyO1xuICAgIGRpYXN0b2xpY0JQPzogbnVtYmVyO1xuICAgIHRlbXBlcmF0dXJlPzogbnVtYmVyO1xuICAgIG94eWdlblNhdHVyYXRpb24/OiBudW1iZXI7XG4gICAgd2VpZ2h0PzogbnVtYmVyO1xuICB9LFxuICB0aW1lc3RhbXA/OiBEYXRlLFxuICBzb3VyY2U6ICdtYW51YWwnIHwgJ2RldmljZScgfCAnd2VhcmFibGUnID0gJ21hbnVhbCdcbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBjdXJyZW50VGltZSA9IHRpbWVzdGFtcCB8fCBuZXcgRGF0ZSgpO1xuICBjb25zdCB0aW1lSW5NaWxsaXMgPSBjdXJyZW50VGltZS5nZXRUaW1lKCkudG9TdHJpbmcoKTtcblxuICBjb25zdCByZWNvcmRzOiBUaW1lc3RyZWFtUmVjb3JkW10gPSBbXTtcblxuICAvLyBDcmVhdGUgYSByZWNvcmQgZm9yIGVhY2ggdml0YWwgc2lnbiBtZWFzdXJlbWVudFxuICBpZiAodml0YWxzLmhlYXJ0UmF0ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmVjb3Jkcy5wdXNoKGNyZWF0ZVJlY29yZCgnaGVhcnRfcmF0ZScsIHZpdGFscy5oZWFydFJhdGUsIHVzZXJJZCwgc291cmNlLCB0aW1lSW5NaWxsaXMpKTtcbiAgfVxuICBpZiAodml0YWxzLnN5c3RvbGljQlAgIT09IHVuZGVmaW5lZCkge1xuICAgIHJlY29yZHMucHVzaChjcmVhdGVSZWNvcmQoJ3N5c3RvbGljX2JwJywgdml0YWxzLnN5c3RvbGljQlAsIHVzZXJJZCwgc291cmNlLCB0aW1lSW5NaWxsaXMpKTtcbiAgfVxuICBpZiAodml0YWxzLmRpYXN0b2xpY0JQICE9PSB1bmRlZmluZWQpIHtcbiAgICByZWNvcmRzLnB1c2goY3JlYXRlUmVjb3JkKCdkaWFzdG9saWNfYnAnLCB2aXRhbHMuZGlhc3RvbGljQlAsIHVzZXJJZCwgc291cmNlLCB0aW1lSW5NaWxsaXMpKTtcbiAgfVxuICBpZiAodml0YWxzLnRlbXBlcmF0dXJlICE9PSB1bmRlZmluZWQpIHtcbiAgICByZWNvcmRzLnB1c2goY3JlYXRlUmVjb3JkKCd0ZW1wZXJhdHVyZScsIHZpdGFscy50ZW1wZXJhdHVyZSwgdXNlcklkLCBzb3VyY2UsIHRpbWVJbk1pbGxpcykpO1xuICB9XG4gIGlmICh2aXRhbHMub3h5Z2VuU2F0dXJhdGlvbiAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmVjb3Jkcy5wdXNoKGNyZWF0ZVJlY29yZCgnb3h5Z2VuX3NhdHVyYXRpb24nLCB2aXRhbHMub3h5Z2VuU2F0dXJhdGlvbiwgdXNlcklkLCBzb3VyY2UsIHRpbWVJbk1pbGxpcykpO1xuICB9XG4gIGlmICh2aXRhbHMud2VpZ2h0ICE9PSB1bmRlZmluZWQpIHtcbiAgICByZWNvcmRzLnB1c2goY3JlYXRlUmVjb3JkKCd3ZWlnaHQnLCB2aXRhbHMud2VpZ2h0LCB1c2VySWQsIHNvdXJjZSwgdGltZUluTWlsbGlzKSk7XG4gIH1cblxuICBpZiAocmVjb3Jkcy5sZW5ndGggPT09IDApIHtcbiAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIHZpdGFsIHNpZ25zIGRhdGEgcHJvdmlkZWQnKTtcbiAgfVxuXG4gIGNvbnN0IHBhcmFtczogV3JpdGVSZWNvcmRzQ29tbWFuZElucHV0ID0ge1xuICAgIERhdGFiYXNlTmFtZTogVElNRVNUUkVBTV9EQVRBQkFTRSxcbiAgICBUYWJsZU5hbWU6IFRpbWVzdHJlYW1UYWJsZXMuVklUQUxfU0lHTlMsXG4gICAgUmVjb3JkczogcmVjb3JkcyxcbiAgfTtcblxuICBhd2FpdCB3cml0ZUNsaWVudC5zZW5kKG5ldyBXcml0ZVJlY29yZHNDb21tYW5kKHBhcmFtcykpO1xufVxuXG4vKipcbiAqIFdyaXRlIGRldmljZSByZWFkaW5ncyB0byBUaW1lc3RyZWFtXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3cml0ZURldmljZVJlYWRpbmdzKFxuICBkZXZpY2VJZDogc3RyaW5nLFxuICB1c2VySWQ6IHN0cmluZyxcbiAgcmVhZGluZ3M6IEFycmF5PHtcbiAgICBtZWFzdXJlTmFtZTogc3RyaW5nO1xuICAgIHZhbHVlOiBudW1iZXI7XG4gICAgdW5pdD86IHN0cmluZztcbiAgfT4sXG4gIHRpbWVzdGFtcD86IERhdGUsXG4gIG1ldGFkYXRhPzoge1xuICAgIGJhdHRlcnlMZXZlbD86IG51bWJlcjtcbiAgICBzaWduYWxTdHJlbmd0aD86IG51bWJlcjtcbiAgfVxuKTogUHJvbWlzZTx2b2lkPiB7XG4gIGNvbnN0IGN1cnJlbnRUaW1lID0gdGltZXN0YW1wIHx8IG5ldyBEYXRlKCk7XG4gIGNvbnN0IHRpbWVJbk1pbGxpcyA9IGN1cnJlbnRUaW1lLmdldFRpbWUoKS50b1N0cmluZygpO1xuXG4gIGNvbnN0IHJlY29yZHM6IFRpbWVzdHJlYW1SZWNvcmRbXSA9IHJlYWRpbmdzLm1hcChyZWFkaW5nID0+ICh7XG4gICAgTWVhc3VyZU5hbWU6IHJlYWRpbmcubWVhc3VyZU5hbWUsXG4gICAgTWVhc3VyZVZhbHVlOiByZWFkaW5nLnZhbHVlLnRvU3RyaW5nKCksXG4gICAgTWVhc3VyZVZhbHVlVHlwZTogTWVhc3VyZVZhbHVlVHlwZS5ET1VCTEUsXG4gICAgVGltZTogdGltZUluTWlsbGlzLFxuICAgIFRpbWVVbml0OiAnTUlMTElTRUNPTkRTJyxcbiAgICBEaW1lbnNpb25zOiBbXG4gICAgICB7IE5hbWU6ICdkZXZpY2VfaWQnLCBWYWx1ZTogZGV2aWNlSWQgfSxcbiAgICAgIHsgTmFtZTogJ3VzZXJfaWQnLCBWYWx1ZTogdXNlcklkIH0sXG4gICAgICB7IE5hbWU6ICd1bml0JywgVmFsdWU6IHJlYWRpbmcudW5pdCB8fCAndW5rbm93bicgfSxcbiAgICBdLFxuICB9KSk7XG5cbiAgLy8gQWRkIG1ldGFkYXRhIGFzIHNlcGFyYXRlIHJlY29yZHMgaWYgcHJvdmlkZWRcbiAgaWYgKG1ldGFkYXRhPy5iYXR0ZXJ5TGV2ZWwgIT09IHVuZGVmaW5lZCkge1xuICAgIHJlY29yZHMucHVzaChjcmVhdGVEZXZpY2VNZXRhZGF0YVJlY29yZCgnYmF0dGVyeV9sZXZlbCcsIG1ldGFkYXRhLmJhdHRlcnlMZXZlbCwgZGV2aWNlSWQsIHVzZXJJZCwgdGltZUluTWlsbGlzKSk7XG4gIH1cbiAgaWYgKG1ldGFkYXRhPy5zaWduYWxTdHJlbmd0aCAhPT0gdW5kZWZpbmVkKSB7XG4gICAgcmVjb3Jkcy5wdXNoKGNyZWF0ZURldmljZU1ldGFkYXRhUmVjb3JkKCdzaWduYWxfc3RyZW5ndGgnLCBtZXRhZGF0YS5zaWduYWxTdHJlbmd0aCwgZGV2aWNlSWQsIHVzZXJJZCwgdGltZUluTWlsbGlzKSk7XG4gIH1cblxuICBjb25zdCBwYXJhbXM6IFdyaXRlUmVjb3Jkc0NvbW1hbmRJbnB1dCA9IHtcbiAgICBEYXRhYmFzZU5hbWU6IFRJTUVTVFJFQU1fREFUQUJBU0UsXG4gICAgVGFibGVOYW1lOiBUaW1lc3RyZWFtVGFibGVzLkRFVklDRV9SRUFESU5HUyxcbiAgICBSZWNvcmRzOiByZWNvcmRzLFxuICB9O1xuXG4gIGF3YWl0IHdyaXRlQ2xpZW50LnNlbmQobmV3IFdyaXRlUmVjb3Jkc0NvbW1hbmQocGFyYW1zKSk7XG59XG5cbi8qKlxuICogV3JpdGUgc2Vuc29yIGRhdGEgdG8gVGltZXN0cmVhbVxuICovXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gd3JpdGVTZW5zb3JEYXRhKFxuICBzZW5zb3JJZDogc3RyaW5nLFxuICB1c2VySWQ6IHN0cmluZyxcbiAgc2Vuc29yVHlwZTogc3RyaW5nLFxuICB2YWx1ZTogbnVtYmVyLFxuICB1bml0OiBzdHJpbmcsXG4gIHRpbWVzdGFtcD86IERhdGVcbik6IFByb21pc2U8dm9pZD4ge1xuICBjb25zdCBjdXJyZW50VGltZSA9IHRpbWVzdGFtcCB8fCBuZXcgRGF0ZSgpO1xuICBjb25zdCB0aW1lSW5NaWxsaXMgPSBjdXJyZW50VGltZS5nZXRUaW1lKCkudG9TdHJpbmcoKTtcblxuICBjb25zdCByZWNvcmQ6IFRpbWVzdHJlYW1SZWNvcmQgPSB7XG4gICAgTWVhc3VyZU5hbWU6IHNlbnNvclR5cGUsXG4gICAgTWVhc3VyZVZhbHVlOiB2YWx1ZS50b1N0cmluZygpLFxuICAgIE1lYXN1cmVWYWx1ZVR5cGU6IE1lYXN1cmVWYWx1ZVR5cGUuRE9VQkxFLFxuICAgIFRpbWU6IHRpbWVJbk1pbGxpcyxcbiAgICBUaW1lVW5pdDogJ01JTExJU0VDT05EUycsXG4gICAgRGltZW5zaW9uczogW1xuICAgICAgeyBOYW1lOiAnc2Vuc29yX2lkJywgVmFsdWU6IHNlbnNvcklkIH0sXG4gICAgICB7IE5hbWU6ICd1c2VyX2lkJywgVmFsdWU6IHVzZXJJZCB9LFxuICAgICAgeyBOYW1lOiAndW5pdCcsIFZhbHVlOiB1bml0IH0sXG4gICAgXSxcbiAgfTtcblxuICBjb25zdCBwYXJhbXM6IFdyaXRlUmVjb3Jkc0NvbW1hbmRJbnB1dCA9IHtcbiAgICBEYXRhYmFzZU5hbWU6IFRJTUVTVFJFQU1fREFUQUJBU0UsXG4gICAgVGFibGVOYW1lOiBUaW1lc3RyZWFtVGFibGVzLlNFTlNPUl9EQVRBLFxuICAgIFJlY29yZHM6IFtyZWNvcmRdLFxuICB9O1xuXG4gIGF3YWl0IHdyaXRlQ2xpZW50LnNlbmQobmV3IFdyaXRlUmVjb3Jkc0NvbW1hbmQocGFyYW1zKSk7XG59XG5cbi8qKlxuICogUXVlcnkgdml0YWwgc2lnbnMgZm9yIGEgdXNlciB3aXRoaW4gYSB0aW1lIHJhbmdlXG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiBxdWVyeVZpdGFsU2lnbnMoXG4gIHVzZXJJZDogc3RyaW5nLFxuICBzdGFydFRpbWU6IERhdGUsXG4gIGVuZFRpbWU6IERhdGUsXG4gIG1lYXN1cmVOYW1lcz86IHN0cmluZ1tdXG4pOiBQcm9taXNlPGFueVtdPiB7XG4gIGNvbnN0IG1lYXN1cmVGaWx0ZXIgPSBtZWFzdXJlTmFtZXMgJiYgbWVhc3VyZU5hbWVzLmxlbmd0aCA+IDBcbiAgICA/IGBBTkQgbWVhc3VyZV9uYW1lIElOICgke21lYXN1cmVOYW1lcy5tYXAobSA9PiBgJyR7bX0nYCkuam9pbignLCAnKX0pYFxuICAgIDogJyc7XG5cbiAgY29uc3QgcXVlcnkgPSBgXG4gICAgU0VMRUNUIFxuICAgICAgdGltZSwgXG4gICAgICBtZWFzdXJlX25hbWUsIFxuICAgICAgbWVhc3VyZV92YWx1ZTo6ZG91YmxlIGFzIHZhbHVlLFxuICAgICAgc291cmNlXG4gICAgRlJPTSBcIiR7VElNRVNUUkVBTV9EQVRBQkFTRX1cIi5cIiR7VGltZXN0cmVhbVRhYmxlcy5WSVRBTF9TSUdOU31cIlxuICAgIFdIRVJFIHVzZXJfaWQgPSAnJHt1c2VySWR9J1xuICAgICAgQU5EIHRpbWUgQkVUV0VFTiBmcm9tX21pbGxpc2Vjb25kcygke3N0YXJ0VGltZS5nZXRUaW1lKCl9KSBcbiAgICAgIEFORCBmcm9tX21pbGxpc2Vjb25kcygke2VuZFRpbWUuZ2V0VGltZSgpfSlcbiAgICAgICR7bWVhc3VyZUZpbHRlcn1cbiAgICBPUkRFUiBCWSB0aW1lIERFU0NcbiAgYDtcblxuICBjb25zdCBwYXJhbXM6IFF1ZXJ5Q29tbWFuZElucHV0ID0ge1xuICAgIFF1ZXJ5U3RyaW5nOiBxdWVyeSxcbiAgfTtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHF1ZXJ5Q2xpZW50LnNlbmQobmV3IFF1ZXJ5Q29tbWFuZChwYXJhbXMpKTtcbiAgcmV0dXJuIHBhcnNlUXVlcnlSZXN1bHRzKHJlc3BvbnNlKTtcbn1cblxuLyoqXG4gKiBRdWVyeSBkZXZpY2UgcmVhZGluZ3MgZm9yIGEgZGV2aWNlIHdpdGhpbiBhIHRpbWUgcmFuZ2VcbiAqL1xuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIHF1ZXJ5RGV2aWNlUmVhZGluZ3MoXG4gIGRldmljZUlkOiBzdHJpbmcsXG4gIHN0YXJ0VGltZTogRGF0ZSxcbiAgZW5kVGltZTogRGF0ZVxuKTogUHJvbWlzZTxhbnlbXT4ge1xuICBjb25zdCBxdWVyeSA9IGBcbiAgICBTRUxFQ1QgXG4gICAgICB0aW1lLCBcbiAgICAgIG1lYXN1cmVfbmFtZSwgXG4gICAgICBtZWFzdXJlX3ZhbHVlOjpkb3VibGUgYXMgdmFsdWUsXG4gICAgICBkZXZpY2VfaWQsXG4gICAgICB1c2VyX2lkLFxuICAgICAgdW5pdFxuICAgIEZST00gXCIke1RJTUVTVFJFQU1fREFUQUJBU0V9XCIuXCIke1RpbWVzdHJlYW1UYWJsZXMuREVWSUNFX1JFQURJTkdTfVwiXG4gICAgV0hFUkUgZGV2aWNlX2lkID0gJyR7ZGV2aWNlSWR9J1xuICAgICAgQU5EIHRpbWUgQkVUV0VFTiBmcm9tX21pbGxpc2Vjb25kcygke3N0YXJ0VGltZS5nZXRUaW1lKCl9KSBcbiAgICAgIEFORCBmcm9tX21pbGxpc2Vjb25kcygke2VuZFRpbWUuZ2V0VGltZSgpfSlcbiAgICBPUkRFUiBCWSB0aW1lIERFU0NcbiAgYDtcblxuICBjb25zdCBwYXJhbXM6IFF1ZXJ5Q29tbWFuZElucHV0ID0ge1xuICAgIFF1ZXJ5U3RyaW5nOiBxdWVyeSxcbiAgfTtcblxuICBjb25zdCByZXNwb25zZSA9IGF3YWl0IHF1ZXJ5Q2xpZW50LnNlbmQobmV3IFF1ZXJ5Q29tbWFuZChwYXJhbXMpKTtcbiAgcmV0dXJuIHBhcnNlUXVlcnlSZXN1bHRzKHJlc3BvbnNlKTtcbn1cblxuLyoqXG4gKiBIZWxwZXIgZnVuY3Rpb24gdG8gY3JlYXRlIGEgdml0YWwgc2lnbnMgcmVjb3JkXG4gKi9cbmZ1bmN0aW9uIGNyZWF0ZVJlY29yZChcbiAgbWVhc3VyZU5hbWU6IHN0cmluZyxcbiAgdmFsdWU6IG51bWJlcixcbiAgdXNlcklkOiBzdHJpbmcsXG4gIHNvdXJjZTogc3RyaW5nLFxuICB0aW1lSW5NaWxsaXM6IHN0cmluZ1xuKTogVGltZXN0cmVhbVJlY29yZCB7XG4gIHJldHVybiB7XG4gICAgTWVhc3VyZU5hbWU6IG1lYXN1cmVOYW1lLFxuICAgIE1lYXN1cmVWYWx1ZTogdmFsdWUudG9TdHJpbmcoKSxcbiAgICBNZWFzdXJlVmFsdWVUeXBlOiBNZWFzdXJlVmFsdWVUeXBlLkRPVUJMRSxcbiAgICBUaW1lOiB0aW1lSW5NaWxsaXMsXG4gICAgVGltZVVuaXQ6ICdNSUxMSVNFQ09ORFMnLFxuICAgIERpbWVuc2lvbnM6IFtcbiAgICAgIHsgTmFtZTogJ3VzZXJfaWQnLCBWYWx1ZTogdXNlcklkIH0sXG4gICAgICB7IE5hbWU6ICdzb3VyY2UnLCBWYWx1ZTogc291cmNlIH0sXG4gICAgXSxcbiAgfTtcbn1cblxuLyoqXG4gKiBIZWxwZXIgZnVuY3Rpb24gdG8gY3JlYXRlIGEgZGV2aWNlIG1ldGFkYXRhIHJlY29yZFxuICovXG5mdW5jdGlvbiBjcmVhdGVEZXZpY2VNZXRhZGF0YVJlY29yZChcbiAgbWVhc3VyZU5hbWU6IHN0cmluZyxcbiAgdmFsdWU6IG51bWJlcixcbiAgZGV2aWNlSWQ6IHN0cmluZyxcbiAgdXNlcklkOiBzdHJpbmcsXG4gIHRpbWVJbk1pbGxpczogc3RyaW5nXG4pOiBUaW1lc3RyZWFtUmVjb3JkIHtcbiAgcmV0dXJuIHtcbiAgICBNZWFzdXJlTmFtZTogbWVhc3VyZU5hbWUsXG4gICAgTWVhc3VyZVZhbHVlOiB2YWx1ZS50b1N0cmluZygpLFxuICAgIE1lYXN1cmVWYWx1ZVR5cGU6IE1lYXN1cmVWYWx1ZVR5cGUuRE9VQkxFLFxuICAgIFRpbWU6IHRpbWVJbk1pbGxpcyxcbiAgICBUaW1lVW5pdDogJ01JTExJU0VDT05EUycsXG4gICAgRGltZW5zaW9uczogW1xuICAgICAgeyBOYW1lOiAnZGV2aWNlX2lkJywgVmFsdWU6IGRldmljZUlkIH0sXG4gICAgICB7IE5hbWU6ICd1c2VyX2lkJywgVmFsdWU6IHVzZXJJZCB9LFxuICAgICAgeyBOYW1lOiAndHlwZScsIFZhbHVlOiAnbWV0YWRhdGEnIH0sXG4gICAgXSxcbiAgfTtcbn1cblxuLyoqXG4gKiBQYXJzZSBUaW1lc3RyZWFtIHF1ZXJ5IHJlc3VsdHMgaW50byBhIG1vcmUgdXNhYmxlIGZvcm1hdFxuICovXG5mdW5jdGlvbiBwYXJzZVF1ZXJ5UmVzdWx0cyhyZXNwb25zZTogYW55KTogYW55W10ge1xuICBpZiAoIXJlc3BvbnNlLlJvd3MgfHwgcmVzcG9uc2UuUm93cy5sZW5ndGggPT09IDApIHtcbiAgICByZXR1cm4gW107XG4gIH1cblxuICBjb25zdCBjb2x1bW5JbmZvID0gcmVzcG9uc2UuQ29sdW1uSW5mbyB8fCBbXTtcbiAgY29uc3QgcmVzdWx0czogYW55W10gPSBbXTtcblxuICBmb3IgKGNvbnN0IHJvdyBvZiByZXNwb25zZS5Sb3dzKSB7XG4gICAgY29uc3QgcmVjb3JkOiBhbnkgPSB7fTtcbiAgICByb3cuRGF0YS5mb3JFYWNoKChkYXRhOiBhbnksIGluZGV4OiBudW1iZXIpID0+IHtcbiAgICAgIGNvbnN0IGNvbHVtbk5hbWUgPSBjb2x1bW5JbmZvW2luZGV4XT8uTmFtZTtcbiAgICAgIHJlY29yZFtjb2x1bW5OYW1lXSA9IGRhdGEuU2NhbGFyVmFsdWU7XG4gICAgfSk7XG4gICAgcmVzdWx0cy5wdXNoKHJlY29yZCk7XG4gIH1cblxuICByZXR1cm4gcmVzdWx0cztcbn1cblxuZXhwb3J0IHsgd3JpdGVDbGllbnQsIHF1ZXJ5Q2xpZW50IH07XG4iXX0=